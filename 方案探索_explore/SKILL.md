---
name: explore
command: explore
user_invocable: true
parallel_mode: true
description: 方案探索。调研业界最佳实践（至少5个来源，包括不限于Github、Claude Code、Cursor、Gemini、Google等），对比分析后给出推荐方案。在需求澄清（/clarify）之后、架构设计（/design）之前使用。
---

# 方案探索 (Explore)

> **角色**：技术侦察兵，在行动前摸清地形
> **目标**：找到业界最佳实践，选择最优方案
> **原则**：至少 5 个来源、对比分析、给出推荐
> **流程**：`/clarify` 之后 → `/design` 之前
> **思考模式**：启用 ultrathink 深度思考，全面权衡方案利弊

---

## 文档契约（铁律）

> **原则**：没有输入文档 → 不能执行；没有输出文档 → 不算完成

### 输入文档（门控检查）

| 文档 | 路径 | 必须 | 检查命令 |
|------|------|------|---------|
| **AC 文档** | `docs/需求文档/clarify_[功能名].md` | ✅ 必须 | `ls docs/需求文档/clarify_*.md` |

**门控规则**：
```bash
# 门控检查：AC 文档必须存在
CLARIFY_DOC=$(ls docs/需求文档/clarify_*.md 2>/dev/null | head -1)
if [ -z "$CLARIFY_DOC" ]; then
  echo "❌ 门控失败: AC 文档不存在"
  echo "   修复: 先执行 /clarify 生成需求文档"
  exit 1
fi
echo "✅ 门控通过: $CLARIFY_DOC"
```

**门控失败处理**：
- AC 文档不存在 → **停止执行**，先执行 `/clarify`
- 禁止跳过门控检查

### 输出文档（强制）

| 文档 | 路径 | 用途 |
|------|------|------|
| **调研文档** | `docs/设计文档/调研_[功能名].md` | /design 依赖 |

**输出规则**：
- 未输出调研文档 → **不算完成**
- 完成提示必须包含输出文档的完整路径

**下游依赖**：
- `/design` 依赖此文档

---

## 依赖规范

本 Skill 依赖以下规范文件：

| 规范文件 | 覆盖内容 |
|---------|---------|
| `.claude/rules/代码质量.md` | 项目铁律（方案不能违反） |
| `.claude/rules/文档规范.md` | 调研文档存放位置和格式 |

> **职责分离**：本 Skill 定义方案探索**流程**，`rules/` 定义**约束标准**。

---

## 核心原则

| 原则 | 说明 |
|------|------|
| **先调研后设计** | 不闭门造车，先看业界怎么做 |
| **至少 5 个来源** | 调研要充分，不能只看一两个 |
| **2-3 个可行方案** | 不只给一个方案，要有对比 |
| **只选型不设计** | 架构设计交给 `/design` |
| **YAGNI** | 不推荐不需要的功能 |

---

## 触发条件

当用户使用以下任一方式时，立即激活此 skill：
- 说"**探索方案**"或"**方案探索**"（主触发词）
- 使用命令：`/explore`
- 说"看看业界怎么做"、"调研一下"
- 说"有什么最佳实践"
- 说"别人是怎么实现的"
- 说"对比一下方案"

**适用场景**：
- 需求已明确，需要探索实现方案
- 复杂功能，需要调研业界最佳实践
- 不确定用哪种技术方案

**不做的事情**（交给 `/design`）：
- 模块划分
- 接口设计
- 数据模型设计

---

## 并行架构

> **设计目标**：通过 8 Agent 并行执行，每个 Agent 有明确的搜索策略和独占范围

### Phase 1: 并行信息收集（8 Agent，subagent_type=Explore）

同时启动以下 8 个调研任务（使用 Task 工具），每个 Agent 有独占的搜索范围：

| Agent | 调研任务 | 搜索策略 | 独占范围 |
|-------|---------|---------|---------|
| Agent 1 | GitHub 仓库搜索 | 搜索 `{技术关键词} stars:>500`，筛选 README、架构图 | 开源项目代码和设计 |
| Agent 2 | 技术博客搜索 | 搜索 `{问题} site:medium.com OR site:dev.to OR site:掘金`，关注实战经验 | 开发者分享的实战文章 |
| Agent 3 | Stack Overflow | 搜索 `[{技术标签}] {问题} is:answer score:10`，关注高票答案 | 技术问答和最佳实践 |
| Agent 4 | 官方文档 | 直接访问框架/库官网的 Best Practices / Guide 页面 | 官方推荐方案 |
| Agent 5 | 企业技术博客 | 搜索 `{问题} site:engineering.*.com OR site:tech.*.com`（大厂工程博客） | 企业级实践案例 |
| Agent 6 | 学术/白皮书 | 搜索 `{问题} filetype:pdf OR site:arxiv.org`，关注架构设计论文 | 理论基础和研究成果 |
| Agent 7 | 中文社区 | 搜索 `{问题} site:juejin.cn OR site:segmentfault.com OR site:cnblogs.com` | 中文技术社区实践 |
| Agent 8 | AI 辅助分析 | 使用 Claude/GPT 分析问题，给出方案建议（标注为 AI 生成） | AI 视角的方案建议 |

**每个 Agent 的 Prompt 模板**：

```markdown
你是调研专家，负责「[调研任务]」。

## 搜索策略
使用以下搜索查询：
- 查询 1: [具体搜索词]
- 查询 2: [具体搜索词]

## 独占范围
你只负责从 [范围描述] 收集信息，不要重复其他 Agent 的工作。

## 输出要求
返回 2-3 个最相关的来源，每个来源包含：
- 来源名称和链接
- 核心思路（50字以内）
- 优势和劣势
- 适用场景
```

每个 Agent 返回结构化 JSON：
```json
{
  "agent_id": "agent_N",
  "search_type": "搜索类型",
  "queries_used": ["实际使用的搜索词1", "搜索词2"],
  "status": "success | failed | timeout",
  "output": {
    "sources": [
      {
        "name": "来源名称",
        "url": "链接",
        "summary": "核心思路（≤50字）",
        "pros": ["优势1", "优势2"],
        "cons": ["劣势1", "劣势2"],
        "applicable_scenarios": "适用场景"
      }
    ]
  }
}
```

**等待所有 Agent 完成后继续。**

---

### Phase 2: 并行方案分析（按候选方案拆分，subagent_type=general-purpose）

主 Agent 汇总 Phase 1 结果后，提取 N 个候选方案，启动 N 个 Agent（subagent_type=general-purpose）各深入分析一个候选方案（最多 8 个）。

**⚠️ 候选方案冻结机制（Phase 2 启动前必须执行）**：

```markdown
## 候选方案冻结点

**冻结时机**：Phase 1 所有 Agent 返回后、Phase 2 启动前

**冻结操作**：
1. 主 Agent 汇总 Phase 1 所有 Agent 的 sources
2. 去重合并，生成候选方案列表（记录来源 Agent）
3. **冻结**：将候选方案列表写入临时状态，禁止后续修改
4. 输出冻结确认：

   ```
   🔒 候选方案已冻结（共 N 个）

   | 方案编号 | 方案名称 | 来源 Agent |
   |---------|---------|-----------|
   | 1 | [方案A] | Agent 2, Agent 5 |
   | 2 | [方案B] | Agent 1 |
   | ... | ... | ... |

   Phase 2 将基于此列表分配任务，列表不可变更。
   ```

**冻结后保证**：
- Phase 2 启动的 Agent 数量 = 冻结列表中的方案数量（最多 8）
- 每个 Agent 的任务分配基于冻结列表，不受后续输入影响
- 若 Phase 1 有延迟返回的 Agent，其结果不纳入 Phase 2（记录日志）

**异常处理**：
- 冻结列表为空 → 报告错误，终止流程
- 冻结列表仅 1 个方案 → 跳过 Phase 2，直接进入 Phase 3 汇总
```

**拆分策略**：每个 Agent 负责分析一个独立的候选方案，不同 Agent 分析不同方案。

**候选方案数量与 Agent 分配规则**：

| 候选方案数量 | Agent 数量 | 分配策略 |
|-------------|-----------|---------|
| 1-2 | N（=方案数） | 每个 Agent 1 个候选方案 |
| 3-8 | N（=方案数） | 每个 Agent 1 个候选方案 |
| >8 | 8 | 按相似度分组，每个 Agent 1-2 个相似方案 |

**>8 方案分组算法**：
1. 计算每个 Agent 负责的方案数：`ceil(N/8)`（例如 9 方案时为 2，16 方案时为 2）
2. 按技术栈相似度分组：相同框架/语言的方案优先分到同一 Agent
3. 分组不均匀时：前 `N mod 8` 个 Agent 各多负责 1 个方案
4. 示例：10 个方案时，Agent 1-2 各负责 2 个方案，Agent 3-8 各负责 1 个方案

| Agent | 负责范围 | 分析内容（全维度） |
|-------|---------|-------------------|
| Agent 1 | 候选方案 A | 技术栈匹配 + 复杂度 + 工作量 + 风险 |
| Agent 2 | 候选方案 B | 技术栈匹配 + 复杂度 + 工作量 + 风险 |
| Agent 3 | 候选方案 C | 技术栈匹配 + 复杂度 + 工作量 + 风险 |
| ... | ... | ... |

**每个 Agent 的职责**：
- 深入分析其负责的候选方案
- 评估与项目技术栈的匹配度
- 评估实现复杂度和工作量
- 识别潜在风险
- **禁止分析其他候选方案**（避免重复）

每个 Agent 返回结构化 JSON：
```json
{
  "agent_id": "agent_N",
  "solution_name": "候选方案名称",
  "source": "来源（Phase 1 哪个 Agent 发现的）",
  "status": "success | failed | timeout",
  "analysis": {
    "tech_stack_match": "高/中/低",
    "match_reason": "匹配原因",
    "complexity": "高/中/低",
    "complexity_reason": "复杂度原因",
    "estimated_effort": "X 天",
    "risks": [
      {"risk": "风险描述", "mitigation": "缓解措施"}
    ],
    "recommendation_score": 1-10,
    "score_reason": "评分理由"
  }
}
```

**等待所有 Agent 完成后继续。**

---

### Phase 3: 汇总输出（串行）

主 Agent 综合所有结果，输出：
- **调研对比表**（至少 5 个来源）
- **可行方案对比**（2-3 个）
- **推荐方案及理由**

---

## 错误处理

> **配置来源**：`docs/需求文档/clarify_skills并行优化.md` 第 7.3 节超时配置表

| 场景 | 处理方式 |
|------|---------|
| 单个 Agent 超时（>120s，见 AC 文档） | 标记失败，继续其他 Agent |
| 单个 Agent 崩溃 | 标记失败，继续其他 Agent |
| 失败 Agent > 50% | 整体任务失败，报告错误 |
| 网络异常 | 重试 1 次，仍失败则标记 |

### ⚠️ 高价值来源失败处理

以下来源被视为**高价值来源**，是方案探索的核心参考：
- **Agent 1（GitHub 仓库搜索）**：开源实现和最佳实践
- **Agent 4（官方文档）**：权威技术指南

**失败处理**：

| 失败场景 | 处理方式 |
|---------|---------|
| GitHub 或 官方文档 单个失败 | 标记失败，继续执行，汇总时标注"高价值来源缺失" |
| GitHub **和** 官方文档 同时失败 | **停止执行**，报告失败，等待用户决策 |

**同时失败时的提示模板**：

```markdown
❌ 高价值来源失败

GitHub 仓库搜索和官方文档搜索均失败：
- GitHub: [失败原因]
- 官方文档: [失败原因]

这两个来源是方案探索的核心参考，缺失将导致：
1. 无法获取业界最佳实践
2. 推荐方案质量无法保证

请选择：
1. 重试高价值来源（推荐）
2. 终止本次探索
```

**用户选择"重试"后**：重新启动 Agent 1 和 Agent 4
**用户选择"终止"后**：停止执行，不输出结果

---

## 执行流程

### Step 0: 确认需求和 AC（快速，串行）

**首先检查 AC 来源文档是否存在**：

```bash
# 检查 AC 文档
ls docs/需求文档/clarify_*.md 2>/dev/null
```

如果 AC 文档存在，读取并确认：

```markdown
## 需求和 AC 确认

**AC 来源文档**：`docs/需求文档/clarify_[功能名].md`

**要实现什么**：[一句话描述]

**验收标准（AC 摘要）**：
- AC-1: [简述]
- AC-2: [简述]
- ...

**完整 AC 见**：[clarify 文档链接]

以上理解正确吗？方案探索将基于这些 AC 进行。
```

如果 AC 文档不存在或需求不清晰，建议先执行 `/clarify`。

> ⚠️ **AC 一致性**：方案探索时必须参考 /clarify 的 AC，确保选择的方案能满足所有 AC

---

### Step 1: 执行 Phase 1 并行信息收集

启动 8 个 Agent 并行调研（参见上方「并行架构 - Phase 1」）。

---

### Step 2: 执行 Phase 2 并行方案分析

汇总 Phase 1 结果，启动 N 个 Agent（N≤8，subagent_type=general-purpose）并行分析（参见上方「并行架构 - Phase 2」）。

---

### Step 3: 执行 Phase 3 汇总输出

> **用户进度提示**：在执行每个 Phase 前输出进度信息

```markdown
📊 /explore 执行进度

⏳ Phase 1: 信息收集（GitHub/文档/博客等 8 个来源）... ✅ 完成（收集 X 个参考）
⏳ Phase 2: 方案分析（对 N 个候选方案深入评估）... ✅ 完成
⏳ Phase 3: 汇总输出... ⏳ 执行中
```

综合所有结果，筛选可行方案。

考虑因素：
- **技术栈匹配**：Python/FastAPI、React/TS
- **团队熟悉度**：学习成本
- **维护成本**：长期可维护性
- **性能要求**：是否满足
- **时间约束**：能否按时完成

筛选出 **2-3 个可行方案**。

---

### Step 4: 方案对比与推荐

```markdown
## 可行方案对比

### 方案 A：[名称]（推荐）
- **来源**：[调研来源]
- **概述**：一句话描述
- **核心思路**：xxx
- **优势**：
  - xxx
  - xxx
- **劣势**：
  - xxx
- **工作量**：约 X 天
- **风险**：xxx

### 方案 B：[名称]
- **来源**：[调研来源]
- **概述**：一句话描述
- **核心思路**：xxx
- **优势**：
  - xxx
- **劣势**：
  - xxx
- **工作量**：约 X 天
- **风险**：xxx

### 推荐理由

选择方案 A 是因为：
1. [理由1]
2. [理由2]
3. [理由3]
```

---

## 输出模板

方案确认后，输出调研文档：

```markdown
# [功能名称] 方案调研

**日期**：YYYY-MM-DD
**状态**：已确认

## 1. 背景
[为什么要做这个]

## 2. 需求概述
[来自 /clarify 的需求定义]

## 3. 业界调研
[调研对比表]

## 4. 方案选择
[选定的方案及理由]

## 5. 风险与缓解
[潜在风险和缓解措施]

---

下一步：/design（架构设计）
```

保存位置：`docs/设计文档/调研_[主题].md`

---

## 项目特定约束

### 技术栈（不可更改）

| 层次 | 技术选型 |
|------|---------|
| 前端 | React + TypeScript + Ant Design |
| 后端 | Python + FastAPI |
| 数据库 | MySQL + Qdrant |
| AI服务 | DashScope + OpenRouter（可配置） |

### 架构约束

> **规范来源**：`.claude/rules/代码质量.md`（项目铁律）

- **禁止降级**：方案不能包含降级/兜底逻辑（铁律一）
- **禁止硬编码**：所有配置必须从 `.env` 或 `runtime_config/` 读取（铁律二）
- **全栈完整**：方案必须同时考虑前后端（参见 `全栈开发.md`）

---

## 与其他 Skills 的关系

```
/clarify（需求澄清）
    ↓ 需求清晰后
/explore（方案探索）← 当前
    ↓ 方案确定后
/design（架构设计）
    ↓ 设计完成后
/plan（写计划）
    ↓
/run-plan（执行计划）
```

---

## ⛔ 边界约束（铁律）

> **`/explore` 的职责边界：只做方案探索，不能跳过后续环节**

| 禁止行为 | 说明 |
|---------|------|
| ❌ 跳过 `/design` 直接进入 `/plan` | 必须按顺序：explore → design → plan |
| ❌ 跳过整个流程直接修改代码 | 必须走完 design → plan → run-plan |
| ❌ 在探索阶段设计模块划分/接口 | 架构设计是 `/design` 的职责 |

**正确的完成动作**：
1. 输出调研文档到 `docs/设计文档/调研_[功能名].md`
2. 展示完成提示
3. 进入下一环节 `/design`（正常流转）或等待用户指令

**跳过环节的处理**：
- 如果用户要求跳过某个环节，必须明确提醒风险并获得确认
- 未经确认不能跳过

---

## 禁止行为

| 禁止 | 原因 |
|------|------|
| 跳过调研直接给方案 | 可能错过更好的方案 |
| 只调研 1-2 个来源 | 调研不充分 |
| 在 explore 阶段做详细设计 | 架构设计交给 `/design` |
| 推荐与项目技术栈不匹配的方案 | 增加学习成本 |

---

## ✅ 完成提示

当方案探索完成后，输出：

```
✅ 方案探索完成

📋 推荐方案：[方案名称]
📄 调研文档：docs/设计文档/调研_[主题].md

下一步：/design（架构设计）
```

<!-- L1 模块规格 - 按需加载 -->
<!-- 来源：设计_人机协作模式重建.md 行 2697-2783 -->
<!-- 生成日期：2026-02-21 -->

# L1: 进度可见性与通知机制

**本模块依赖**：L1_pipeline编排器.md（编排器写入进度文件和发送通知）
**本模块被依赖**：L1_配置与权限.md（Status Line 配置）

---

## 1. 三层感知渠道

用户在 Pipeline 后台运行期间有三层感知渠道，从被动到主动：

| 层级 | 渠道 | 触发方式 | 信息量 | Token 开销 |
|------|------|---------|--------|-----------|
| L1 | Status Line（UI 状态栏） | 被动实时 | 一行摘要 | 零 |
| L2 | `/status` Skill | 用户主动查询 | 详细 JSON | 少量 |
| L3 | 系统通知 | 关键事件推送 | 标题+描述 | 零 |

---

## 2. L1: Status Line（被动实时）

**机制**：Claude Code 的 Status Line 定期执行 shell 命令，读取最近更新的 `.pipeline-progress-{feature}.json` 并在 UI 状态栏显示一行摘要。

**显示效果**：`[Pipeline: 用户管理 | implement 3/6 | 12m]`

**进度文件**：`.pipeline-progress-{feature}.json`（项目根目录），pipeline.sh 每步写入，按 feature 隔离。

**特点**：
- 用户无需主动操作，打开 Claude Code 就能看到
- 零 token 开销，不消耗 LLM 上下文
- 会话独立——pipeline.sh 写文件，Status Line 读文件，无耦合
- 无 Pipeline 运行时回退到 `npx ccstatusline@latest`

**前置依赖**：jq（`brew install jq`），pipeline.sh 启动时检查。

---

## 3. L2: /status Skill（主动查询）

用户在任何会话中说 `/status`，读取进度文件格式化展示：

```
Pipeline 进度：用户管理
+-- 当前步骤：implement (3/6)
+-- 状态：running
+-- 已用时间：12 分钟
+-- 修复次数：0
+-- CLI Backend：claude-codex
+-- 上次更新：2026-02-13T15:30:00
```

多个 Pipeline 时列出全部。

**与 Status Line 分工**：Status Line 一行摘要（被动），/status 完整详情（主动）。

---

## 4. L3: 系统通知（关键事件推送）

### 4.1 通知事件全表

| 场景 | 触发位置 | 通知内容 | 音效 |
|------|---------|---------|------|
| clarify 不存在 | 前置检查 | "handoff_clarify.md 不存在" | Basso |
| 残留 Handoff 文件 | 前置检查 | "检测到残留 Handoff 文件" | Basso |
| 残留 fix 文件 | 前置检查 | "检测到残留 handoff_fix 文件" | Basso |
| 步骤执行失败 | run_step | "[步骤名] 执行失败" | Basso |
| Handoff 未生成 | run_step | "[步骤名] 未生成输出文件" | Basso |
| **QA 通过** | QA/Fix 循环 | "{feature} QA 验收通过" | **Glass** |
| QA 反复失败 >= 10 | QA/Fix 循环 | "修复已达 10 次，请人工排查" | Basso |
| QA 结果解析异常 | QA/Fix 防御性分支 | "QA 结果解析异常" | Basso |
| 重复启动 | 前置检查 | "{feature} 已有 Pipeline 在运行" | Basso |
| **Design 评审通过** | Design-Plan 循环 | "{feature} Design 评审通过" | **Glass** |
| Design 评审循环耗尽 | Design-Plan 循环 | "Design 经 3 轮评审仍有问题" | Basso |
| **Plan 评审通过** | Plan-Implement 循环 | "{feature} Plan 评审通过" | **Glass** |
| Plan 评审循环耗尽 | Plan-Implement 循环 | "Plan 经 3 轮评审仍有问题" | Basso |
| Check 通过 | Implement-Check 循环 | 无通知（直接进入 QA） | -- |
| Check 循环耗尽 | Implement-Check 循环 | "代码检查 3 轮未通过" | Basso |
| Design 评审格式异常 | Design-Plan 循环 | "评审输出缺少 REVIEW 行" | Basso |
| Plan 评审格式异常 | Plan-Implement 循环 | "评审输出缺少 REVIEW 行" | Basso |
| Check 结果解析异常 | Implement-Check 防御性分支 | "Check 结果解析异常" | Basso |

### 4.2 通知实现

```bash
notify() {       # 正常通知，Glass 音效
  osascript / notify-send + echo 日志
}
notify_error() { # 错误通知，Basso 音效
  osascript / notify-send + echo 日志
}
```

- 支持 macOS（osascript）+ Linux（notify-send）跨平台
- 始终输出到日志（`echo "[NOTIFY]"`）
- 通知失败不影响 Pipeline 执行

---

## 5. 方案选型说明

| 方案 | 结论 | 原因 |
|------|------|------|
| Agent Teams | 不采用 | 设计用于并行协作；无 session resumption |
| Bash `run_in_background` | 不采用 | 3 个已知严重 Bug（#11716 token 爆炸 11.6x、#16958 上下文膨胀、#19097 孤儿进程），部分 closed as NOT_PLANNED |
| **Progress File + Status Line** | **采用** | 被动实时、零 token、会话独立、官方支持、无已知 Bug |

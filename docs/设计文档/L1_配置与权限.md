<!-- L1 模块规格 - 按需加载 -->
<!-- 来源：设计_人机协作模式重建.md 行 2525-2900 -->
<!-- 生成日期：2026-02-21 -->

# L1: 配置与权限

**本模块依赖**：L1_三层架构与Skills.md（Skills 引用关系）、L1_SubAgent质量设计.md（SubAgent 角色定义）
**本模块被依赖**：L1_pipeline编排器.md（编排器使用配置）

---

## 1. SubAgent 完整配置

每个 SubAgent 文件（`~/.claude/agents/pipeline-*.md`）的 YAML frontmatter 配置：

| SubAgent | allowedTools | skills | model | maxTurns | memory |
|----------|-------------|--------|-------|----------|--------|
| pipeline-designer | Read, Write, Glob, Grep, WebSearch | `[architecture]` | `opus` | 30 | `project` |
| pipeline-planner | Read, Write, Glob, Grep | `[architecture, review-standard]` | `opus` | 30 | `project` |
| pipeline-implementer | Read, Write, Edit, Bash, Glob, Grep | `[tdd-methodology, code-quality]` | `opus` | 50 | `project` |
| pipeline-checker | Read, Bash, Glob, Grep | `[code-quality, review-standard]` | `sonnet` | 20 | - |
| pipeline-qa | Read, Bash, Glob, Grep | `[qa-methodology]` | `sonnet` | 30 | - |
| pipeline-fixer | Read, Write, Edit, Bash, Glob, Grep | `[tdd-methodology, code-quality]` | `opus` | 40 | - |

### 配置字段说明

| 字段 | 用途 | 设计理由 |
|------|------|---------|
| `skills` | 声明引用的 Skills，启动时自动注入 | 方法论复用，修改一处全局生效 |
| `model` | opus / sonnet | Designer/Planner/Implementer/Fixer 需强推理用 opus；Checker/QA 偏执行验证用 sonnet（成本低、速度快） |
| `maxTurns` | 单次会话最大轮次 | 防止无限循环。Implementer 最高（50，多轮 TDD）；Checker 最低（20，步骤确定） |
| `memory` | 跨会话记忆（`project` = 按项目持久化） | Designer/Planner/Implementer 积累项目理解；Checker/QA/Fixer 每次独立判断更客观 |

### SubAgent 文件结构示例（pipeline-designer.md）

```yaml
---
name: pipeline-designer
description: 资深架构师，负责架构设计
skills:
  - architecture
model: opus
maxTurns: 30
memory: project
allowedTools:
  - Read
  - Write
  - Glob
  - Grep
  - WebSearch
---

# 角色身份
你是资深架构师，熟悉本项目代码风格和技术栈。

# 行为准则
- 先扫描现有代码再设计
- 拒绝需求文档未提及的功能
- 关键决策必须多方案对比

# 负向约束
- 不写代码、不做任务拆分
- 不引入 clarify 未要求的抽象层或设计模式
- 不修改项目代码文件（Write 仅用于输出 Handoff 文档）

# 输入输出
- 输入：handoff_clarify.md
- 输出：handoff_design.md
- 输出格式：必须包含"输入分析"、"决策"、"产出"三个核心章节

# 质量门控
[引用自 architecture Skill]

# 输出前自检清单
[引用自 architecture Skill]
```

> SubAgent 文件保留角色身份、行为准则、负向约束、输入输出规范。方法论、质量门控标准、Few-shot 示例通过 skills 字段从知识层引入。控制在 < 3k tokens。

### 工具权限原则

| 权限级别 | SubAgent | 说明 |
|---------|----------|------|
| 只读 + Write Handoff | Designer, Planner | Write 仅用于输出 Handoff，prompt 约束不修改项目代码，事后 diff 校验兜底 |
| 只读 + Bash | Checker, QA | 只读 + 运行测试/Lint，不能修改代码 |
| 全权限 | Implementer, Fixer | 改代码、运行测试、commit |

---

## 2. pipeline.sh 配置

配置直接写在脚本顶部（bash 变量），不依赖外部配置文件。

| 配置项 | 默认值 | 传入方式 | 说明 |
|--------|--------|---------|------|
| `MAX_FIX` | 10 | 脚本内 | QA-Fix 最大修复循环 |
| `MAX_REVIEW` | 3 | 环境变量 | 评审最大轮数 |
| `MAX_CHECK_LOOP` | 3 | 环境变量 | QA 前 Check 修复循环最大轮数 |
| `STEP_BUDGET` | 10.00 | 脚本内 | 单步费用上限（临时占位，须 3 次实测校准 P90 x 2） |
| `STEP_TIMEOUT` | 1800 | 脚本内 | 单步超时（秒） |
| `TOTAL_STEPS` | 6 | 脚本内 | 主步骤数 |
| `TOTAL_BUDGET` | 200.00 | 环境变量 | 总费用安全网（临时占位，须 3 次实测校准 P90 x 1.5） |
| `START_STEP` | design | 环境变量 | 断点续传入口：design/implement/qa |
| `HUMAN_CHECKPOINT` | true | 环境变量 | Design/Plan 人工确认开关（前 10 个需求建议保持开启，积累信心后可关闭） |
| `CLI_CMD` | claude | 环境变量 | CLI 命令：claude/claude-codex/claude-gemini |
| `PROJECT_DIR` | . | 脚本参数 | 项目根目录 |
| `SKILLS_DIR` | $HOME/.claude/skills | 脚本内 | Skills 知识层目录 |

**环境变量传入示例**：
```bash
HUMAN_CHECKPOINT=false TOTAL_BUDGET=200 CLI_CMD=claude-codex \
  ~/.claude/pipeline.sh "用户管理" /path/to/project
```

---

## 3. Status Line 配置

**配置位置**：`~/.claude/settings.json`

```json
{
  "statusLine": {
    "type": "command",
    "command": "f=$(ls -t .pipeline-progress-*.json 2>/dev/null | head -1) && [ -n \"$f\" ] && jq -r '\"[Pipeline: \" + .feature + \" | \" + .current_step + \" \" + (.step_index|tostring) + \"/\" + (.total_steps|tostring) + \" | \" + ((.elapsed_seconds/60)|floor|tostring) + \"m]\"' \"$f\" 2>/dev/null || npx ccstatusline@latest 2>/dev/null || echo ''"
  }
}
```

**显示效果**：`[Pipeline: 用户管理 | implement 3/6 | 12m]`

**工作原理**：
- 定期执行 shell 命令，查找最近更新的进度文件
- 按 feature 隔离，支持并行
- 无 Pipeline 时回退到 ccstatusline
- 零 token 开销

**前置依赖**：jq（`brew install jq`）

---

## 4. 交付物清单

| 交付物 | 路径 | 说明 |
|--------|------|------|
| Shell 编排器 | `~/.claude/pipeline.sh` | 确定性流程控制 |
| Designer SubAgent | `~/.claude/agents/pipeline-designer.md` | 架构设计角色卡 |
| Planner SubAgent | `~/.claude/agents/pipeline-planner.md` | 开发计划角色卡 |
| Implementer SubAgent | `~/.claude/agents/pipeline-implementer.md` | 执行开发角色卡 |
| Checker SubAgent | `~/.claude/agents/pipeline-checker.md` | 代码检查角色卡 |
| QA SubAgent | `~/.claude/agents/pipeline-qa.md` | 验收测试角色卡 |
| Fixer SubAgent | `~/.claude/agents/pipeline-fixer.md` | 修复角色卡 |
| /status Skill | `~/.claude/skills/pipeline-status/SKILL.md` | 进度详情查询 |
| Status Line 配置 | `~/.claude/settings.json` 中 statusLine | 被动进度显示 |
| /clarify 升级 | 更新现有 Skill | 输出 Handoff + 后台启动 |
| 现有 Skill 改造 | /design /plan /run-plan /check /qa | 改为调用 SubAgent |
| /fix Skill 新增 | 新建 Skill | 调用 pipeline-fixer |

---

## 5. SubAgent Prompt 验收标准

每个 `pipeline-*.md` 必须包含以下 5 个段落（缺一不可）：

| 段落 | 内容要求 | 验收方式 |
|------|---------|---------|
| 角色身份定义 | 身份 + 行为准则 + 负向约束（三要素） | 人工 review |
| Few-shot 对比示例 | >= 1 组好 vs 坏对比 | 人工 review |
| 自检清单 | >= 5 条检查项 | 逐条核对 |
| 输出格式模板 | Handoff 结构（输入分析/决策/产出/交接项） | 格式校验 |
| 负向约束 | >= 3 条 "Do NOT" | 人工 review |

**验收流程**：
1. 骨架 review（用户 30 分钟）：角色定义、负向约束、Few-shot 坏输出是否触及真实问题
2. A/B 实测：拿已完成需求用 Pipeline 重跑，对比产出
3. 持续迭代：Pipeline 失败回溯到 prompt，积累 5 条后修订

---

## 6. 前置验证清单（Go-Live 准入）

以下全部满足才可正式使用：

- [ ] `claude -p --permission-mode plan` 实测通过（Designer/Planner 依赖）
- [ ] 3 次不同规模需求实测费用数据已记录，STEP_BUDGET/TOTAL_BUDGET 已校准
- [ ] 6 个 SubAgent prompt 已交付且通过骨架 review
- [ ] `preflight_check()` 覆盖 jq/gtimeout/setsid 三个依赖
- [ ] 1 次冒烟测试全流程通过
- [ ] shellcheck 对 pipeline.sh 零 warning

---

## 7. 验证方案摘要

### 7.1 自动模式验证
- /clarify -> "开始" -> pipeline.sh 后台运行
- 每步验证：退出码、Handoff 文件生成、PASS/FAIL 判定、锁目录
- 故意制造缺陷验证 QA/Fix 循环收敛
- QA 通过后收到系统通知

### 7.2 手动模式验证
- 单独执行 /check，确认调用了 pipeline-checker SubAgent
- 验证 Skill 和 pipeline.sh 调用同一份 SubAgent 文件

### 7.3 并行验证
- 两个不同 feature 同时运行，Handoff 互不干扰
- 同一 feature 重复启动被锁文件阻止

### 7.4 进度可见性验证
- Status Line 显示实时进度
- /status 显示完整详情
- CLI Backend 正确显示
- 无 Pipeline 时正确回退

### 7.5 评审循环验证
- Design 故意遗漏 -> Planner 发现 DESIGN_ISSUE
- Plan AC 不可执行 -> Implementer 发现 PLAN_ISSUE
- 3 轮评审不通过 -> pipeline.sh 正确退出
- parse_review 缺少 REVIEW 行 -> 不重试直接退出

### 7.6 新增功能验证
- START_STEP 断点续传
- 权限模式分级（plan vs bypassPermissions）
- 事后 diff 校验（只读角色修改代码 -> exit 1）
- 费用累计超预算 -> 暂停
- Implement 回滚锚点（IMPL_BASE）
- per-feature 日志文件
- 评审按轮次编号
- 进程组超时清理
- INFRA_ERROR 路径（不进入 Fix）
- preflight_check 阻断

### 7.7 验证标准
- 自动模式：全流程无需用户中间干预（异常除外）
- 手动模式与自动模式质量一致
- 流程控制 100% 确定性，不依赖 LLM
- 进度可见性：任何时刻可通过 Status Line 或 /status 了解状态
- CLI 兼容性：claude-codex/claude-gemini 与默认 claude 行为一致

> 详见 L2 原文 行 2834-2900（完整验证方案和逐项验证标准）

---

## 8. Hooks 配置与改造

> 来源：L2 原文行 208-218（Section 1.7 P2 配置质量）
> 当前状态：已实施。以下记录改造设计决策，供实施校验和后续维护参考。

### 8.1 改造概要

Hooks 从 12 个精简到 8 个（删除 4 个 + 重写 1 个），同步重新定义职责边界。

**删除的 4 个 Hooks**：

| 删除的 Hook | 删除理由 |
|------------|---------|
| `research_tracker.sh` | Pipeline Handoff 文档替代其记录功能 |
| `brain_switch.sh` | 未启用，无实际用途 |
| `claude_slavery.sh` | 未启用，无实际用途 |
| `completion_check.sh` | 验证 Claude 自己标记的 checkbox 是形式主义（"认证者"而非"检查者"），由 Pipeline 编排器的实质验证替代 |

**重写的 1 个 Hook**：

`code_quality_check.sh` 从 50+ 规则精简到 ~12 条安全/资源类规则，移除所有"判断类"规则（降级、Mock、N+1 等），质量判断交给 SubAgent 语义检查。

### 8.2 职责边界原则

**核心原则**：不用 bash/grep/regex 解决需要 LLM 判断力的问题。

| 职责 | 归属 | 执行方式 | 理由 |
|------|------|---------|------|
| 安全防线 | Hook | bash 脚本 fail-fast | 确定性规则，零误判容忍 |
| 机械自动化 | Hook | 格式化、快照、统计 | 无需 LLM 判断力 |
| 质量判断 | SubAgent | pipeline-checker / pipeline-qa 语义检查 | 需要上下文理解（降级、Mock、需求偏差、虚假完成） |

**行业验证**：社区最佳实践将 Hook 定义为"deterministic control over a probabilistic system"——Hook 执行确定性事项（必须发生的），LLM 负责判断性事项（需要推理的）。

### 8.3 保留的 8 个 Hook 清单

| # | Hook 脚本 | 分类 | 触发时机 | 功能 |
|---|----------|------|---------|------|
| 1 | `session_start.sh` | 上下文管理 | SessionStart | 检测压缩快照、加载活跃计划 |
| 2 | `block_dangerous.sh` | 安全防线 | PreToolUse:Bash | 阻止 `rm -rf /`、fork bomb 等危险命令 |
| 3 | `protect_secrets.sh` | 安全防线 | PreToolUse:Write\|Edit | 保护 `.env`、SSH 密钥等敏感文件 |
| 4 | `doc_check.sh` | 机械自动化 | PreToolUse:Write | 文档命名规范、目录结构检查 |
| 5 | `code_quality_check.sh` | 安全防线 | PreToolUse:Write\|Edit | 安全漏洞 + 资源泄漏 + 占位符代码拦截（~12 条规则） |
| 6 | `auto_format.sh` | 机械自动化 | PostToolUse:Edit\|Write | 自动运行 prettier/ruff/gofmt |
| 7 | `change_stats.sh` | 信息展示 | Stop | 智能统计代码变更 |
| 8 | `save_before_compact.sh` | 上下文管理 | PreCompact | 压缩前保存上下文快照 |

另有 2 个 Notification Hook（permission_prompt 提示音、idle_prompt 系统通知），不计入脚本总数。

### 8.4 code_quality_check.sh 规则清单

精简后保留 12 条规则，分三类：

| # | 类别 | 规则 | 严重度 |
|---|------|------|--------|
| 1 | 安全 | 硬编码密钥/密码 | ❌ 阻止 |
| 2 | 安全 | SQL 注入（字符串拼接 SQL） | ❌ 阻止 |
| 3 | 安全 | SQL 注入（Java 无参数化查询） | ❌ 阻止 |
| 4 | 占位符 | NotImplementedError / 占位符 | ❌ 阻止 |
| 5 | 占位符 | 明确的占位符标记（stub/placeholder） | ❌ 阻止 |
| 6 | 资源 | 空 catch/except 块 | ⚠️ 警告 |
| 7 | 资源 | Python 裸 except | ⚠️ 警告 |
| 8 | 资源 | Python 可变默认参数 | ❌ 阻止 |
| 9 | 资源 | Python 文件未使用 with 语句 | ⚠️ 警告 |
| 10 | 资源 | Python 异步代码中使用 time.sleep | ⚠️ 警告 |
| 11 | 资源 | Java 资源未使用 try-with-resources | ⚠️ 警告 |
| 12 | 资源 | JS addEventListener 无 removeEventListener | ⚠️ 警告 |

附加 1 条 JS API 调用未处理错误（⚠️ 警告），实际共 12-13 条。

**移除的规则类型**（交给 SubAgent）：降级检测、Mock 检测、N+1 查询、完成度验证、需求偏差、函数长度/参数数量等代码质量指标。

### 8.5 Hook 与 SubAgent 分工表

| 检查维度 | Hook 负责 | SubAgent 负责 |
|---------|-----------|--------------|
| 硬编码密钥 | ✅ fail-fast 拦截 | pipeline-checker 深度检查 |
| SQL 注入 | ✅ fail-fast 拦截 | pipeline-checker 深度检查 |
| 资源泄漏 | ✅ 警告 | pipeline-checker 深度检查 |
| 占位符代码 | ✅ fail-fast 拦截 | pipeline-checker 确认实现完整性 |
| 降级逻辑 | — | pipeline-checker 语义检查 |
| Mock 使用 | — | pipeline-checker 语义检查 |
| N+1 查询 | — | pipeline-checker 语义检查 |
| 代码质量规则 | — | pipeline-checker 五维检查 |
| 需求偏差 | — | pipeline-qa 验收测试 |
| 虚假完成 | — | pipeline-qa 端到端验证 |

### 8.6 Pipeline 兼容性

Pipeline 编排器使用 `claude -p` 启动 SubAgent，不触发 SessionStart/Stop/PreCompact Hook。但 SubAgent 写文件时正常触发 PreToolUse 和 PostToolUse Hook。

| Hook | Pipeline 中的行为 |
|------|-----------------|
| block_dangerous.sh | ✅ 正常生效 |
| protect_secrets.sh | ✅ 正常生效 |
| code_quality_check.sh | ✅ 正常生效 |
| doc_check.sh | ✅ 正常生效（`docs/pipeline/` 已加入允许目录） |
| auto_format.sh | ✅ 正常生效 |
| session_start.sh | ❌ 不触发（`claude -p` 无 SessionStart） |
| change_stats.sh | ❌ 不触发 |
| save_before_compact.sh | ❌ 不触发 |

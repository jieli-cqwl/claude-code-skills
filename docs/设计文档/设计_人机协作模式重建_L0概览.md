<!-- L0 全局概览 - 始终加载 -->
<!-- 来源：设计_人机协作模式重建.md -->
<!-- 生成日期：2026-02-21 -->

# 设计：Claude Code 人机协作模式重建 — L0 全局概览

**设计日期**：2026-02-13
**需求文档**：`docs/需求澄清/clarify_人机协作模式重建.md`

---

## 1. 项目目标与核心思路

Shell 脚本（`pipeline.sh`）作为编排器，依次调用 `claude -p` 执行每个环节。每次调用注入对应 SubAgent 的 prompt，拥有独立上下文窗口。流程控制（顺序、循环、条件判断）在 bash 中确定性执行，不依赖 LLM。CLI 命令可配置（`claude` / `claude-codex` / `claude-gemini`）。

**关键原则**：确定性逻辑用确定性工具，LLM 只负责每个环节内的实际工作。

---

## 2. 架构总览流程图

```
用户输入需求
    |
/clarify（交互式会话）
    | 输出: {project}/docs/pipeline/{feature}/handoff_clarify.md
    |
用户："开始"
    |
pipeline.sh "{feature}" "{project_dir}" (后台独立进程)
    |
+-- Design-Plan 评审循环（最多 3 轮） --+
|  Designer -> handoff_design               |
|  Planner 评审 -> DESIGN_OK / DESIGN_ISSUE |
+-------------------------------------------+
    |
  [可选人工确认 HUMAN_CHECKPOINT]
    |
+-- Plan-Implement 评审循环（最多 3 轮） --+
|  Planner -> handoff_plan                   |
|  Implementer 评审 -> PLAN_OK / PLAN_ISSUE  |
+--------------------------------------------+
    |
  [可选人工确认 HUMAN_CHECKPOINT]
    |
+-- Implement-Check 循环（最多 3 轮） ------+
|  Implementer -> handoff_run                |
|  Checker -> handoff_check                  |
|  pipeline.sh 独立运行测试 -> PASS / FAIL   |
+--------------------------------------------+
    |
+-- QA-Fix 循环（最多 10 轮） --------------+
|  QA -> handoff_qa                          |
|  pipeline.sh 独立运行测试 -> PASS / FAIL   |
|  FAIL -> Fixer -> Checker -> 重新 QA       |
|  >= 5 轮暂停人工 / >= 10 轮终止            |
+--------------------------------------------+
    |
用户验收 -> /ship
```

> 详见 L2 原文 行 15-69

---

## 3. 双模式架构

同一套 SubAgent 文件 + 同一套 Skills（方法论），两种触发方式：

| 模式 | 触发方式 | 执行机制 | 适用场景 |
|------|---------|---------|---------|
| **手动** | `/design`、`/check` 等 Skill | `context: fork` + `agent` 字段，隔离上下文 | 改 Bug、单步执行 |
| **自动** | `/clarify` 后用户说"开始" | `pipeline.sh` -> 多次 `claude -p` | 完整功能开发 |

> 详见 L2 原文 行 75-101

---

## 4. 三层架构

| 层级 | 载体 | 职责 | Token 规模 |
|------|------|------|-----------|
| **编排层** | `pipeline.sh` / Skill (`context: fork`) | 确定性流程控制 | N/A |
| **执行层** | SubAgents（`~/.claude/agents/pipeline-*.md`） | 角色身份 + 行为边界 + 输入输出规范 | < 3k tokens/个 |
| **知识层** | Skills（`~/.claude/skills/pipeline-*/`） | 方法论、经验、质量标准（跨 SubAgent 复用） | 按需加载 |

**拆分原因**：消除 SubAgent 臃肿（25k+ -> <3k tokens）、方法论跨角色复用、修改一处全局生效。

> 详见 L1_三层架构与Skills.md

---

## 5. 设计原则

| 原则 | 说明 |
|------|------|
| **独立上下文** | 每个 SubAgent 拥有独立上下文窗口，天然隔离 |
| **文档留痕** | 每步输出结构化 Handoff 文档，可追溯 |
| **失败即停** | 任何环节异常暂停通知用户，禁止降级 |
| **工具最小化** | 每个 SubAgent 只开放必要的工具权限 |
| **三层分离** | SubAgent + Skills + pipeline.sh，各层职责清晰 |
| **判定权分离** | PASS/FAIL 判定在 pipeline.sh（独立运行测试），不在 SubAgent |

> 详见 L2 原文 行 148-156

---

## 5.1 前置验证

| 验证项 | 结果 | 关键数据 |
|--------|------|---------|
| Task+SubAgent 机制可行性 | ✅ 通过 | 26 秒，Subagent 成功读写文件 |
| 链式调用多个 Subagent | ✅ 通过 | 398 秒（2 步），暴露链式调用耗时问题 |
| `--permission-mode plan` 非交互兼容性 | ⏳ 待验证 | Go-Live 阻断项：plan 模式在 `-p` 下是否自动跳过审批 |

**架构决策**：验证 1-2 证明 Task+Subagent 可行，但链式调用耗时过高（2 步 400 秒）。结合可靠性分析（LLM 流程控制不如 bash 确定性），最终选择 Shell 脚本编排器 + 多次 `claude -p` 方案。

> 详见 L2 原文 行 158-166

---

## 6. 已知风险摘要

| 风险 | 防护措施 |
|------|---------|
| CLI 进程挂死 | `timeout --signal=KILL` + `setsid` 进程组隔离 + `--max-budget-usd` |
| 单步费用失控 | `--max-budget-usd` 限制单步费用 |
| 同一 feature 重复启动 | 锁文件（`mkdir` 原子操作） |
| Handoff 文件残留 | 启动前检查，支持 `pipeline.sh reset` 清理 |
| Implement 中途失败 | 记录 commit_hashes，通知用户自行决定回滚 |
| feature name Unicode 正则兼容性 | macOS bash 3.2 不支持 `\x{4e00}`，改用 `perl -e` 正则解决 |
| 总费用失控 | `TOTAL_BUDGET` 安全网（步数 x STEP_BUDGET 估算）（详见 L2 行 335-338 配置参数） |

> 详见 L2 原文 行 168-183（含行 177-178 Unicode 风险）、L1_pipeline编排器.md

---

## 7. 目录结构

```
~/.claude/
+-- agents/                            # SubAgent 定义（精简角色卡）
|   +-- pipeline-designer.md           # skills: [architecture]
|   +-- pipeline-planner.md            # skills: [architecture, review-standard]
|   +-- pipeline-implementer.md        # skills: [tdd-methodology, code-quality]
|   +-- pipeline-checker.md            # skills: [code-quality, review-standard]
|   +-- pipeline-qa.md                 # skills: [qa-methodology]
|   +-- pipeline-fixer.md              # skills: [tdd-methodology, code-quality]
+-- pipeline.sh                        # Shell 编排器（含 build_prompt Skills 拼接）
+-- skills/
    +-- pipeline-architecture/         # 架构设计方法论
    +-- pipeline-tdd-methodology/      # TDD 流程
    +-- pipeline-code-quality/         # 代码质量标准
    +-- pipeline-review-standard/      # 代码审查标准
    +-- pipeline-qa-methodology/       # QA 验收方法论
    +-- pipeline-status/               # /status Skill

项目根目录/
+-- .pipeline-progress-{feature}.json  # 进度文件（按 feature 隔离）
+-- docs/pipeline/
    +-- {feature}/                     # 每个需求一个命名空间
    |   +-- handoff_clarify.md
    |   +-- handoff_design.md
    |   +-- review_design_N.md         # Planner 评审（N=轮次）
    |   +-- handoff_plan.md
    |   +-- review_plan_N.md           # Implementer 评审（N=轮次）
    |   +-- handoff_run.md
    |   +-- handoff_check.md
    |   +-- handoff_qa.md
    |   +-- handoff_fix_pre_N.md       # QA 前修复
    |   +-- handoff_fix_N.md           # QA 后修复
    +-- archive/                       # 已完成的 Pipeline
```

> 详见 L2 原文 行 225-278

---

## 8. 模块依赖关系

```
/clarify (用户交互)
    |
    v
pipeline.sh (编排器) --调用--> 6 个 SubAgents
    |                              |
    |                              +--引用--> 5 个 Skills (知识层)
    |
    +--写入--> .pipeline-progress-{feature}.json
    |              |
    |              +--读取--> Status Line (UI)
    |              +--读取--> /status Skill
    |
    +--写入/读取--> docs/pipeline/{feature}/handoff_*.md
```

**SubAgent 间数据流（通过 Handoff 文件）**：

```
clarify -> Designer -> Planner(评审Design) -> Planner -> Implementer(评审Plan)
                                                              |
                                                              v
                                                         Implementer -> Checker
                                                              |            |
                                                              v            v
                                                           QA <-------- Fixer
```

**Skills 知识层复用关系**：

| Skill | Designer | Planner | Implementer | Checker | QA | Fixer |
|-------|:--------:|:-------:|:-----------:|:-------:|:--:|:-----:|
| architecture | **主用** | 引用 | - | - | - | - |
| tdd-methodology | - | - | **主用** | - | - | **主用** |
| code-quality | - | - | 引用 | **主用** | - | 引用 |
| review-standard | - | 引用 | - | **主用** | - | - |
| qa-methodology | - | - | - | - | **主用** | - |

---

## 9. 全局约束与铁律

| 约束 | 说明 |
|------|------|
| 禁止降级 | 任何环节失败即停，不静默切换备选方案 |
| 判定权在编排器 | PASS/FAIL 由 pipeline.sh 独立运行测试判定，SubAgent 只负责检查和描述问题 |
| Handoff 阻断性验证 | 核心章节（输入分析/决策/产出）缺失 -> `exit 1` 强杀 |
| 只读角色事后校验 | Designer/Planner/Checker/QA 不应修改 `docs/pipeline/` 以外的文件，`git diff` 事后校验 |
| 费用安全网 | `STEP_BUDGET`（单步）+ `TOTAL_BUDGET`（总量），超限暂停 |
| 进程超时强杀 | `timeout --signal=KILL` + `setsid` 进程组隔离，防止 CLI 挂死 |
| SubAgent 自检清单 | 每个 SubAgent 输出前必须逐条自检，不通过则修正后再输出 |
| 早期熔断 | 下游发现上游重大缺陷时，有权拒绝执行并直接报错终止 |

---

## 10. L1 模块索引

| L1 文件 | 对应原文章节 | 行号范围 | 一句话摘要 |
|---------|------------|---------|-----------|
| `L1_pipeline编排器.md` | 第 3 节 | 280-1146 | pipeline.sh 的完整设计：触发方式、核心脚本逻辑（状态机、循环控制、辅助函数）、设计决策、异常处理全表 |
| `L1_SubAgent质量设计.md` | 第 4 节 | 1149-1977 | 10 条通用 Prompt 设计原则 + 6 个 SubAgent 各自的角色定义、失败模式、质量标准、Few-shot 示例、质量门控、自检清单 |
| `L1_Handoff文档规范.md` | 第 5-6 节 | 1979-2261 | Handoff 通用格式、文件引用方式、/clarify 升级方向（苏格拉底提问 + Example Mapping）、输出格式 |
| `L1_进度与通知.md` | 第 9 节 | 2697-2783 | 三层感知渠道（Status Line / /status / 系统通知）、通知事件全表、方案选型 |
| `L1_三层架构与Skills.md` | 第 7 节 | 2264-2522 | Skills/SubAgents/pipeline.sh 协作关系、知识复用矩阵、两种调用路径、Skill 改造方式、5 个 Skills 知识层内容定义、19 个 Skills 完整清单 |
| `L1_配置与权限.md` | 第 8、10-11 节 | 2525-2900 | SubAgent 完整配置表（工具/Skills/模型/轮次/记忆）、pipeline.sh 配置项、Status Line 配置、交付物清单、验收标准、验证方案 |

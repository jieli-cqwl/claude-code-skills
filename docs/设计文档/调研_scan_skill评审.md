# /scan Skill 设计合理性评审 - 业界调研报告

**日期**：2025-01-29
**状态**：已完成
**目的**：评审 /scan skill 设计合理性，对比业界最佳实践

---

## 1. 业界方案调研

### 1.1 调研来源

| # | 来源 | 类型 | 说明 |
|---|------|------|------|
| 1 | [SonarQube](https://docs.sonarsource.com/sonarqube-server/user-guide/code-metrics/metrics-definition) | 官方文档 | 业界领先代码质量平台，SQALE 评分标准 |
| 2 | [CodeQL/GitHub](https://docs.github.com/en/code-security/code-scanning/introduction-to-code-scanning/about-code-scanning-with-codeql) | 官方文档 | GitHub 安全扫描引擎 |
| 3 | [ESLint Rules](https://eslint.org/docs/latest/rules/) | 官方文档 | JavaScript 最流行的 Linter |
| 4 | [Code Climate](https://codeclimate.com/blog/10-point-technical-debt-assessment) | 技术博客 | 技术债评估方法论 |
| 5 | [SonarSource 技术债文章](https://www.sonarsource.com/learn/measuring-and-identifying-code-level-technical-debt-a-practical-guide/) | 技术博客 | 技术债计算方法 |
| 6 | [Qodo 静态分析工具对比](https://www.qodo.ai/blog/best-static-code-analysis-tools/) | 行业报告 | 2025 年静态分析工具对比 |
| 7 | [Claude Code 代码审查](https://github.com/anthropics/claude-code/blob/main/plugins/code-review/README.md) | 官方文档 | AI 辅助代码审查最佳实践 |

---

## 2. 检测规则覆盖度分析

### 2.1 业界标准规则分类

**SonarQube 三大类**：
| 类别 | 说明 | 覆盖范围 |
|------|------|---------|
| **Reliability（可靠性）** | Bugs、缺陷 | 空指针、资源泄露、逻辑错误 |
| **Security（安全性）** | 漏洞、敏感点 | SQL 注入、XSS、敏感信息 |
| **Maintainability（可维护性）** | Code Smells、技术债 | 复杂度、重复、命名 |

**ESLint 四大类**：
| 类别 | 说明 |
|------|------|
| **Possible Errors** | 语法错误、常见错误 |
| **Best Practices** | 最佳实践、代码质量 |
| **Strict Mode** | 严格模式相关 |
| **Variables** | 变量声明和使用 |

**CodeQL 安全分类**：
| 严重程度 | 说明 |
|---------|------|
| Critical | 严重安全漏洞 |
| High | 高风险问题 |
| Medium | 中风险问题 |
| Low | 低风险问题 |

### 2.2 你的 /scan 规则分类

| Agent | 类别 | 对应业界 |
|-------|------|---------|
| Agent1: 铁律检测 | 降级/硬编码/Mock | ❌ **自定义类别**（无业界对应） |
| Agent2: 安全漏洞 | SQL 注入/XSS/敏感信息 | ✅ 对应 Security |
| Agent3: 代码规范 | 函数长度/空 catch/裸 except | ✅ 对应 Maintainability |
| Agent4: 技术债 | TODO/FIXME/废弃代码 | ✅ 对应 Maintainability |

### 2.3 覆盖度评估

| 维度 | 业界标准 | /scan 覆盖 | 差距 |
|------|---------|-----------|------|
| **安全性** | SQL 注入、XSS、CSRF、敏感信息、认证绕过... | SQL 注入、XSS、敏感信息 | 🟡 缺少：CSRF、认证绕过、路径遍历 |
| **可靠性** | 空指针、资源泄露、并发问题、异常处理... | 空 catch、裸 except | 🔴 缺少：空指针、资源泄露、并发问题 |
| **可维护性** | 复杂度、重复代码、命名规范、注释... | 函数长度、TODO/FIXME | 🟡 缺少：圈复杂度、代码重复率 |
| **项目铁律** | N/A（自定义） | 降级/硬编码/Mock | ✅ 特色亮点 |

### 2.4 缺失项清单

**高优先级缺失**：
1. **圈复杂度（Cyclomatic Complexity）** - 业界标准，衡量代码复杂度
2. **代码重复率（Duplication）** - SonarQube 核心指标
3. **空指针/None 检查** - 可靠性核心
4. **资源泄露检测** - 未关闭的文件/连接

**中优先级缺失**：
5. **认知复杂度（Cognitive Complexity）** - 比圈复杂度更现代
6. **CSRF 检测** - 安全性补充
7. **并发问题检测** - 竞态条件、死锁风险

---

## 3. 评分算法科学性分析

### 3.1 业界评分模型

**SonarQube SQALE 模型**：
```
技术债比率 = 技术债（分钟）/ (每行代码成本 × 代码行数) × 100

评级：
A = 0-5%    （优秀）
B = 6-10%   （良好）
C = 11-20%  （一般）
D = 21-50%  （较差）
E = 51%+    （需重构）
```

**SonarQube 安全/可靠性评级**：
```
基于最严重问题的严重程度：
A = 0 个或仅 Info 级别
B = 至少 1 个 Low
C = 至少 1 个 Medium
D = 至少 1 个 High
E = 至少 1 个 Blocker
```

**Code Climate GPA 模型**：
```
基于文件级评分加权平均：
A = 4.0
B = 3.0
C = 2.0
D = 1.0
F = 0
```

### 3.2 你的评分算法

```
评分 = 100 - (严重 × 3) - (警告 × 0.5) - (建议 × 0.1)
```

### 3.3 科学性评估

| 维度 | 业界做法 | /scan 做法 | 评估 |
|------|---------|-----------|------|
| **评分逻辑** | 基于技术债比率（相对值） | 基于问题数量扣分（绝对值） | 🔴 不科学 |
| **权重设计** | 基于修复成本（分钟/小时） | 固定权重（3/0.5/0.1） | 🟡 过于简化 |
| **代码规模** | 考虑代码行数 | 不考虑 | 🔴 大项目不公平 |
| **评级映射** | A-E 基于比率阈值 | A-F 基于分数 | 🟡 可接受 |

### 3.4 问题分析

**核心问题**：当前算法不考虑代码规模

- 10 个文件的项目有 5 个严重问题 → 85 分
- 1000 个文件的项目有 5 个严重问题 → 同样 85 分

**业界做法**：技术债比率 = 问题总修复时间 / 项目开发时间估算

**改进建议**：
```
改进算法：
技术债比率 = Σ(问题修复时间) / (代码行数 × 0.5分钟/行)

默认修复时间：
- 严重问题：60 分钟
- 警告问题：15 分钟
- 建议问题：5 分钟

评级：
A = 0-5%
B = 6-10%
C = 11-20%
D = 21-50%
E/F = 51%+
```

---

## 4. 与业界工具对比

### 4.1 功能对比表

| 功能 | SonarQube | ESLint | Pylint | CodeQL | /scan |
|------|-----------|--------|--------|--------|-------|
| **多语言支持** | 27+ | 1 (JS/TS) | 1 (Python) | 10+ | 4 |
| **规则数量** | 5000+ | 500+ | 400+ | 2000+ | ~20 |
| **圈复杂度** | ✅ | ✅ | ✅ | ✅ | ❌ |
| **代码重复** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **安全漏洞** | ✅ | 插件 | 插件 | ✅ | ✅ 基础 |
| **技术债计算** | ✅ SQALE | ❌ | ❌ | ❌ | ✅ 简化版 |
| **增量扫描** | ✅ | ✅ | ✅ | ✅ | ❌ |
| **CI/CD 集成** | ✅ | ✅ | ✅ | ✅ | ❌ |
| **自定义规则** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **IDE 集成** | ✅ | ✅ | ✅ | ✅ | ❌ |

### 4.2 定位差异

| 工具 | 定位 | 优势 | 劣势 |
|------|------|------|------|
| **SonarQube** | 企业级质量平台 | 全面、专业、生态完善 | 重、需部署、学习成本 |
| **ESLint/Pylint** | 语言级 Linter | 轻量、实时、IDE 集成 | 单语言、无技术债概念 |
| **CodeQL** | 安全分析 | 深度语义分析、数据流 | 安全聚焦、非全面质量 |
| **/scan** | Claude Code 全量扫描 | 轻量、项目铁律、无需部署 | 规则少、算法简化 |

### 4.3 竞争力评估

| 维度 | 评分 | 说明 |
|------|------|------|
| **规则覆盖** | 3/10 | 约 20 条规则，业界 500+ |
| **评分科学性** | 4/10 | 不考虑代码规模 |
| **特色亮点** | 8/10 | 项目铁律检测是独特价值 |
| **易用性** | 9/10 | 无需部署，直接用 |
| **可扩展性** | 6/10 | 可加规则，但无插件生态 |

---

## 5. 实用性分析

### 5.1 报告可操作性

**当前报告结构**：
```
🔴 严重问题 TOP 5:
  1. [文件:行号] - [类型] - [简述]
```

**业界报告特点**（SonarQube）：
1. 问题定位：文件 + 行号 + 代码片段
2. 修复建议：具体怎么改
3. 相关资料：规则文档链接
4. 影响说明：为什么这是问题
5. 修复成本：预估时间

### 5.2 实用性评估

| 维度 | 当前状态 | 改进建议 |
|------|---------|---------|
| **问题定位** | ✅ 有文件行号 | 可加代码片段 |
| **修复建议** | ❌ 无 | 🔴 必须加 |
| **优先级排序** | ✅ 按严重程度 | 可加修复成本排序 |
| **趋势对比** | ❌ 无 | 可加历史对比 |
| **自动修复** | ❌ 无 | 可加简单自动修复 |

### 5.3 用户场景覆盖

| 场景 | 支持程度 | 说明 |
|------|---------|------|
| 接手新项目评估 | ✅ 适合 | 核心场景 |
| 定期巡检 | 🟡 部分 | 缺历史对比 |
| 重构前评估 | ✅ 适合 | 核心场景 |
| CI/CD 集成 | ❌ 不支持 | 需要输出格式标准化 |

---

## 6. 综合评审结论

### 6.1 总体评价

| 维度 | 评分 | 结论 |
|------|------|------|
| 检测规则覆盖度 | ⭐⭐⭐ 一般 | 缺少圈复杂度、重复率等核心指标 |
| 评分算法科学性 | ⭐⭐ 需改进 | 不考虑代码规模，大项目不公平 |
| 与业界差距 | ⭐⭐⭐ 一般 | 定位轻量工具，规则数量差距大 |
| 实用性 | ⭐⭐⭐⭐ 良好 | 易用，但缺修复建议 |

### 6.2 核心优势

1. **项目铁律检测** - 独特价值，业界工具没有
2. **零部署** - 直接用，无需安装配置
3. **轻量快速** - 适合日常使用
4. **并行扫描** - 4 Agent 效率高

### 6.3 核心短板

1. **评分算法不科学** - 不考虑代码规模
2. **缺少核心指标** - 圈复杂度、重复率
3. **缺修复建议** - 发现问题但不告诉怎么改
4. **规则数量少** - 约 20 条 vs 业界 500+

---

## 7. 改进建议（按优先级）

### P0（必须改进）

| # | 改进项 | 说明 | 预估工作量 |
|---|--------|------|-----------|
| 1 | **评分算法改用技术债比率** | 考虑代码规模，对齐 SQALE | 小 |
| 2 | **每个问题加修复建议** | 提升报告可操作性 | 中 |

### P1（建议改进）

| # | 改进项 | 说明 | 预估工作量 |
|---|--------|------|-----------|
| 3 | **增加圈复杂度检测** | 业界标准指标 | 中 |
| 4 | **增加代码重复率检测** | SonarQube 核心指标 | 大 |
| 5 | **增加可靠性检测** | 空指针、资源泄露 | 中 |

### P2（可选改进）

| # | 改进项 | 说明 | 预估工作量 |
|---|--------|------|-----------|
| 6 | 历史对比功能 | 支持趋势分析 | 中 |
| 7 | 更多安全规则 | CSRF、认证绕过等 | 中 |
| 8 | 报告输出代码片段 | 提升可读性 | 小 |

---

## 8. 推荐改进方案

### 方案 A：最小改进（推荐）

聚焦 P0 改进，保持轻量定位：

1. 改进评分算法（对齐 SQALE）
2. 每个问题加修复建议

**优势**：工作量小，效果明显
**劣势**：规则覆盖度仍然有限

### 方案 B：中等改进

P0 + P1 部分：

1. 改进评分算法
2. 加修复建议
3. 加圈复杂度检测
4. 加基础可靠性检测

**优势**：覆盖度提升明显
**劣势**：工作量较大

### 方案 C：全面改进

P0 + P1 + P2：对标 SonarQube 能力子集

**优势**：功能完善
**劣势**：工作量大，可能过度设计

---

**推荐**：**方案 A（最小改进）**

理由：
1. /scan 定位是轻量工具，不是要替代 SonarQube
2. 项目铁律检测是独特价值，应保持
3. P0 改进投入产出比最高

---

下一步：用户确认后，进入 `/design` 设计改进方案细节

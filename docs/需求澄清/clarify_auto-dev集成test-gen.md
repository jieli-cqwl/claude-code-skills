## 需求澄清结果

**需求名称**：auto-dev 集成 test-gen
**澄清日期**：2026-01-30
**状态**：已确认
**文档路径**：docs/需求澄清/clarify_auto-dev集成test-gen.md

---

### 0. 项目上下文

**功能类型**：[Skills开发]

> ⚠️ **重要**：此标记决定是否应用全栈开发规范
> - 全栈：需要前后端同步完成
> - 纯后端/纯前端/CLI/Skills：不强制要求全栈

**相关规范**：
- `~/.claude/rules/RULES.md` - 项目铁律（禁止降级、禁止硬编码、禁止 Mock）
- TDD 铁律：「没有先失败的测试，就没有生产代码」

**相关代码**：
- `自动开发_auto-dev/SKILL.md:299-315` - 当前阶段 2（测试先行）实现
- `测试生成_test-gen/SKILL.md` - test-gen 完整实现

**关键约束**：
- 项目铁律：禁止 Mock（内部服务）
- AC 单一来源：/clarify 定义 AC，后续只能引用
- Skills 能力复用：避免重复实现

---

### 1. 背景

当前 `/auto-dev` 阶段 2（测试先行）只是简单描述"从 AC 生成 FAILING 测试"，但没有调用已有的 `/test-gen` skill。这导致：

1. **能力浪费**：`/test-gen` 已实现完整的测试生成能力（并行架构、多维度分析、Mock 检查），未被复用
2. **质量风险**：Worker 各自写测试，没有统一的 Mock 合规检查
3. **流程不一致**：推荐流程图显示 `/test-gen` 应在 `/run-plan` 之前，但 `/auto-dev` 未遵循

---

### 2. 目标

- **功能目标**：`/auto-dev` 阶段 2 显式调用 `/test-gen from-clarify`，复用已有能力
- **质量目标**：测试生成质量与独立调用 `/test-gen` 一致
- **规范要求**：保持 Skills 流程一致性，遵循 AC 单一来源原则

---

### 3. 技术方案要点

**涉及模块**：
- `自动开发_auto-dev/SKILL.md` - 修改阶段 2 实现

**关键技术决策**：
- 阶段 2 使用 Skill 工具调用 `/test-gen from-clarify <clarify_doc>`
- 保留现有的测试文件验证和运行确认步骤

**改动范围**：
- 仅修改 `auto-dev/SKILL.md` 的阶段 2 描述
- 无需修改 `/test-gen`

---

### 4. 验收标准（Acceptance Criteria）

> ⚠️ **AC 单一来源声明**：此处定义的 AC 是整个开发流程的唯一验收标准。
> `/plan`、`/test-gen`、`/qa` 必须引用此 AC，禁止重新定义。

#### 4.1 AC 表格（Given-When-Then 格式）

##### 正常流程
| AC-ID | Given（前置条件） | When（操作） | Then（预期结果） | 优先级 | 测试方法 |
|-------|------------------|-------------|-----------------|--------|---------|
| AC-1 | AC 文档存在（clarify_*.md） | 执行 /auto-dev 进入阶段 2 | 调用 /test-gen from-clarify 生成测试 | P0 | 人工验证 |
| AC-2 | /test-gen 执行完成 | 继续阶段 2 后续步骤 | 验证测试文件存在于 tests/ 目录 | P0 | 人工验证 |
| AC-3 | 测试文件存在 | 运行测试 | 测试全部 FAILING（符合 TDD 预期） | P0 | 人工验证 |

##### 异常流程
| AC-ID | Given | When | Then | 优先级 | 测试方法 |
|-------|-------|------|------|--------|---------|
| AC-4 | AC 文档不存在 | 执行 /auto-dev 进入阶段 2 | 门控失败，提示先执行 /clarify | P1 | 人工验证 |
| AC-5 | /test-gen 执行失败 | 阶段 2 检测到失败 | 停止执行，报告失败原因 | P1 | 人工验证 |

##### 边界情况
| AC-ID | Given | When | Then | 优先级 | 测试方法 |
|-------|-------|------|------|--------|---------|
| AC-6 | 测试文件已存在（增量场景） | 执行 /auto-dev 进入阶段 2 | /test-gen 按增量模式处理（追加/跳过） | P2 | 人工验证 |

#### 4.2 质量验收（可量化指标）
- [ ] SKILL.md 修改后语法正确，无歧义
- [ ] 阶段 2 明确调用 /test-gen from-clarify

#### 4.3 规范验收（来自项目规范）
- [ ] 保持 Skills 流程一致性
- [ ] 遵循 AC 单一来源原则
- [ ] 无重复实现（复用 /test-gen 能力）

---

### 5. 具体改动内容

**修改位置**：`自动开发_auto-dev/SKILL.md` 阶段 2

**修改前**（行 299-315）：
```markdown
### 阶段 2：测试先行（TDD 铁律）

> ⚠️ **铁律**：没有测试就没有开发，测试是开发的验收标准

1. **从 AC 生成 FAILING 测试**
2. **验证测试文件存在**：`tests/test_[功能名]_acceptance.py`
3. **运行测试确认失败**：符合 TDD 预期
```

**修改后**：
```markdown
### 阶段 2：测试先行（TDD 铁律）

> ⚠️ **铁律**：没有测试就没有开发，测试是开发的验收标准

1. **调用 /test-gen 生成 FAILING 测试**
   - 使用 Skill 工具调用：`/test-gen from-clarify <clarify_doc>`
   - /test-gen 会执行并行代码分析和测试生成
   - 包含 Mock 合规检查（禁止 Mock 内部服务）

2. **验证测试文件存在**：`tests/test_[功能名]_acceptance.py`

3. **运行测试确认失败**：符合 TDD 预期

```bash
# 运行测试，必须看到失败
pytest tests/test_*_acceptance.py
# 预期：FAILED（这是正确的，因为还没写实现）
```

**如果 /test-gen 失败**：停止执行，报告失败原因，等待用户决策
```

---

以上理解是否正确？确认后进入方案探索 (`/explore`) 或直接执行修改。

## 需求澄清结果

**需求名称**：开发阶段自动化（dev-loop）
**澄清日期**：2026-02-04
**状态**：已确认
**复杂度**：中等
**涉及范围**：Skills 开发（纯后端/CLI）

---

### 1. 背景

用户希望将真实研发流程中的"开发阶段"自动化，包含：
- 开发编码（run-plan）
- 代码自检（check）
- 代码评审（gemini-review）
- 评审不通过时的自动修复循环

这是渐进式全流程自动化的第一步，先把开发阶段做好，验证效果后再扩展到其他阶段。

---

### 2. 目标

- **功能目标**：创建一个新 Skill `/dev-loop`，自动执行 run-plan → check → gemini-review 的完整循环，评审失败时自动修复重试
- **质量目标**：
  - 单次循环耗时 < 现有手动流程的 50%
  - 自动修复成功率 > 70%（3 次内通过）
  - 最大重试次数：3 次

---

### 3. 验收标准（Acceptance Criteria）

> ⚠️ **AC 单一来源声明**：此处定义的 AC 是整个开发流程的唯一验收标准。
> `/plan`、`/test-gen`、`/qa` 必须引用此 AC，禁止重新定义。

**AC 指纹**：`AC-HASH-7B3F2E1A`

#### 正常流程

| AC-ID | Given（前置条件） | When（操作） | Then（预期结果） | 优先级 | 测试方法 |
|-------|------------------|-------------|-----------------|--------|---------|
| AC-1 | 存在 plan 文档，代码质量良好 | 执行 `/dev-loop` | 依次执行 run-plan → check → gemini-review，全部通过后输出成功报告 | P0 | E2E |
| AC-2 | /run-plan 执行完成 | 自动进入 /check | 无需人工干预，自动触发 check 流程 | P0 | 集成测试 |
| AC-3 | /check 通过 | 自动进入 /gemini-review | 无需人工干预，自动触发 gemini-review | P0 | 集成测试 |
| AC-4 | /gemini-review 通过（无严重问题） | 输出完成报告 | 显示"开发阶段完成，可进入 /qa"，包含执行统计 | P0 | E2E |

#### 异常流程（评审失败 → 自动修复循环）

| AC-ID | Given（前置条件） | When（操作） | Then（预期结果） | 优先级 | 测试方法 |
|-------|------------------|-------------|-----------------|--------|---------|
| AC-5 | /check 失败（如 lint 错误） | 检测到失败 | 自动分析失败原因，尝试修复代码，重新执行 /check | P0 | 集成测试 |
| AC-6 | /gemini-review 发现问题 | 检测到评审问题 | 自动根据评审意见修复代码，重新执行 /check → /gemini-review | P0 | 集成测试 |
| AC-7 | 修复后重新评审 | 评审通过 | 退出修复循环，输出成功报告（含重试次数统计） | P0 | E2E |
| AC-8 | 修复失败，需要再次修复 | 继续修复循环 | 累计重试次数，继续尝试修复（不超过最大次数） | P1 | 集成测试 |

#### 边界情况

| AC-ID | Given（前置条件） | When（操作） | Then（预期结果） | 优先级 | 测试方法 |
|-------|------------------|-------------|-----------------|--------|---------|
| AC-9 | 达到最大重试次数（3 次） | 第 3 次修复后仍失败 | 停止循环，输出失败报告，列出未解决的问题，提示人工介入 | P0 | E2E |
| AC-10 | plan 文档不存在 | 执行 `/dev-loop` | 门控失败，提示"请先执行 /plan 生成计划文档" | P1 | 单元测试 |
| AC-11 | gemini CLI 不可用 | 执行到 gemini-review | 跳过 gemini-review（降级为仅 check），输出警告但不阻塞 | P2 | 单元测试 |
| AC-12 | 用户中断执行（Ctrl+C） | 执行过程中中断 | 保存当前进度检查点，下次可从中断处恢复 | P2 | 手动测试 |

---

### 4. AC 质量验证

| 检查项 | 状态 |
|--------|------|
| 正常流程 | ✅ 4 条 |
| 异常流程 | ✅ 4 条 |
| 边界情况 | ✅ 4 条 |
| 可验证性 | ✅ 全部通过 |

验证时间：2026-02-04 15:30

---

### 5. 核心设计要点

#### 5.1 执行流程

```
/dev-loop 启动
    ↓
门控检查（plan 文档存在）
    ↓
执行 /run-plan
    ↓
执行 /check
    ↓ 失败？→ 自动修复 → 重新 /check（最多 3 次）
    ↓ 通过
执行 /gemini-review
    ↓ 发现问题？→ 自动修复 → 重新 /check → /gemini-review（最多 3 次）
    ↓ 通过
输出完成报告
    ↓
提示：可执行 /qa 进入测试阶段
```

#### 5.2 自动修复策略

| 问题类型 | 修复方式 |
|---------|---------|
| lint 错误 | 调用 ruff --fix 或 eslint --fix |
| 类型错误 | 根据错误信息自动添加类型注解 |
| 测试失败 | 分析失败原因，修复代码或测试 |
| gemini-review 问题 | 根据评审意见逐条修复 |

#### 5.3 重试计数

- check 失败重试和 gemini-review 失败重试**共享**最大次数（3 次）
- 每次修复后重置为完整流程（check → gemini-review）
- 达到 3 次后停止，输出所有未解决问题

---

### 6. 约束（来自项目规范）

- **禁止降级**：修复失败不能静默跳过，必须报告
- **禁止 Mock**：测试必须连接真实服务
- **文档同步**：新增 Skill 需要更新 SKILL.md

---

### 7. 与其他 Skills 的关系

```
/plan（写计划）
    ↓
/dev-loop（本需求）← 封装 run-plan + check + gemini-review + 修复循环
    ↓
/qa（测试验收）
```

**本 Skill 封装了**：
- /run-plan（执行计划）
- /check（开发检查）
- /gemini-review（代码评审）
- 自动修复逻辑

---

以上理解是否正确？确认后进入方案探索 (`/explore`)

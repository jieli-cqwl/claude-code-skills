# Skills 并行优化 - 统一 AC 文档

> 来源：`/clarify` 需求澄清
> 创建时间：2026-01-29
> 状态：待实施

---

## 背景

当前多数 Skills 采用串行执行模式，效率低下。本次优化目标是为所有适合并行化的 Skills 添加 8-10 个子 Agent 并行执行点，预期效率提升 2-5 倍。

## 优化范围

| 优先级 | Skill | 当前状态 | 预期提升 |
|--------|-------|----------|----------|
| P0 | `/explore` | 串行 | 5x |
| P0 | `/test-gen` | 串行 | 4-5x |
| P0 | `/qa` | 串行门控 | 2-3x |
| P1 | `/critique` | 串行 | 3-4x |
| P1 | `/design` | 串行 | 3x |
| P1 | `/experts` | 设计并行但未实现 | 4-5x |
| P2 | `/security` | 部分并行 | 2-3x |
| P2 | `/perf` | 部分并行 | 2-3x |
| P2 | `/overview` | 串行 | 2x |
| P2 | `/refactor` | 串行 | 2-3x |

## 保持串行的 Skills（有明确理由）

| Skill | 理由 |
|-------|------|
| `/clarify` | 需要用户交互，无法并行 |
| `/debug` | 阶段依赖性强，需要上一步结果 |
| `/ship` | 交互式确认流程 |
| `/plan` | 需要全局理解后统一规划 |

---

## P0 优先级 AC

### AC-1: `/explore` 方案探索并行化

**当前问题**：串行调研 5+ 信息源，耗时长

**目标架构**：
```
Phase 1: 并行信息收集（8 Agent）
├── Agent 1: GitHub 仓库搜索
├── Agent 2: Claude Code 最佳实践
├── Agent 3: Cursor 方案调研
├── Agent 4: Gemini 方案调研
├── Agent 5: Google 搜索（技术博客）
├── Agent 6: Stack Overflow 调研
├── Agent 7: 官方文档搜索
└── Agent 8: 开源项目案例

Phase 2: 并行方案分析（8 Agent）
├── Agent 1-8: 各自分析一个候选方案
│   ├── 优劣势分析
│   ├── 适用场景
│   └── 风险评估

Phase 3: 汇总输出（串行）
└── 主 Agent: 综合对比，输出推荐方案
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-1.1 | 用户触发 `/explore` | 进入信息收集阶段 | 同时启动 8 个 Agent 并行调研不同信息源 |
| AC-1.2 | Phase 1 完成 | 进入方案分析阶段 | 同时启动 8 个 Agent 并行分析候选方案 |
| AC-1.3 | 所有并行 Agent 完成 | 汇总输出 | 主 Agent 综合所有结果，输出结构化对比报告 |
| AC-1.4 | 任一 Agent 超时或失败 | 错误处理 | 记录失败 Agent，继续处理其他结果，最终报告标注数据完整性 |

**验证标准**：
- [ ] 信息收集阶段：8 个 Task 调用在同一消息中发出
- [ ] 方案分析阶段：8 个 Task 调用在同一消息中发出
- [ ] 总耗时相比串行版本减少 70%+

---

### AC-2: `/test-gen` 测试生成并行化

**当前问题**：串行生成测试用例，效率低

**目标架构**：
```
Phase 1: 并行代码分析（10 Agent）
├── Agent 1: 函数签名分析
├── Agent 2: 边界值识别
├── Agent 3: 异常路径分析
├── Agent 4: 依赖关系分析
├── Agent 5: 状态变化分析
├── Agent 6: 输入组合分析
├── Agent 7: 并发场景分析
├── Agent 8: 性能边界分析
├── Agent 9: 安全输入分析
└── Agent 10: 业务规则分析

Phase 2: 并行测试生成（10 Agent）
├── Agent 1: 正常路径测试
├── Agent 2: 边界值测试
├── Agent 3: 异常处理测试
├── Agent 4: Mock/Stub 测试
├── Agent 5: 参数化测试
├── Agent 6: 属性测试
├── Agent 7: 集成测试
├── Agent 8: 性能测试
├── Agent 9: 安全测试
└── Agent 10: 回归测试

Phase 3: 汇总去重（串行）
└── 主 Agent: 合并、去重、格式化输出
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-2.1 | 用户触发 `/test-gen` | 进入代码分析阶段 | 同时启动 10 个 Agent 并行分析代码的不同维度 |
| AC-2.2 | Phase 1 完成 | 进入测试生成阶段 | 同时启动 10 个 Agent 并行生成不同类型测试 |
| AC-2.3 | 所有测试生成完成 | 汇总输出 | 主 Agent 合并去重，输出完整测试文件 |
| AC-2.4 | 生成的测试 | 执行验证 | 所有生成的测试必须能通过编译/语法检查 |

**验证标准**：
- [ ] 代码分析阶段：10 个 Task 调用在同一消息中发出
- [ ] 测试生成阶段：10 个 Task 调用在同一消息中发出
- [ ] 生成的测试覆盖率 ≥ 80%

---

### AC-3: `/qa` 测试验收并行化

**当前问题**：Layer 1 → 2 → 3 完全串行

**目标架构**：
```
Layer 1: 单元测试（8 Agent 并行）
├── Agent 1-8: 各负责一个模块的单元测试
│   ├── 运行测试
│   └── 收集覆盖率

Layer 2: 集成测试（8 Agent 并行）
├── Agent 1-8: 各负责一个集成场景
│   ├── API 测试
│   └── 服务间测试

Layer 3: E2E 测试（8 Agent 并行）
├── Agent 1-8: 各负责一个用户场景
│   ├── 端到端流程
│   └── UI 交互测试

门控规则：Layer N 全部通过后才进入 Layer N+1
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-3.1 | 用户触发 `/qa` | 进入 Layer 1 | 同时启动 8 个 Agent 并行执行不同模块的单元测试 |
| AC-3.2 | Layer 1 全部通过 | 进入 Layer 2 | 同时启动 8 个 Agent 并行执行不同场景的集成测试 |
| AC-3.3 | Layer 2 全部通过 | 进入 Layer 3 | 同时启动 8 个 Agent 并行执行不同用户场景的 E2E 测试 |
| AC-3.4 | 任一 Layer 有失败 | 门控阻断 | 停止后续 Layer，输出失败报告，等待修复 |
| AC-3.5 | 全部 Layer 通过 | 输出报告 | 汇总所有测试结果，输出验收报告 |

**验证标准**：
- [ ] 每个 Layer 内：8 个 Task 调用在同一消息中发出
- [ ] 门控逻辑正确：Layer 失败时不进入下一 Layer
- [ ] Layer 内并行，Layer 间串行

---

## P1 优先级 AC

### AC-4: `/critique` 方案评审并行化

**当前问题**：5 个评审维度串行执行

**目标架构**：
```
Phase 1: 并行评审（10 Agent）
├── Agent 1: 完整性检查
├── Agent 2: 一致性检查
├── Agent 3: 可行性评估
├── Agent 4: 风险识别
├── Agent 5: 遗漏分析
├── Agent 6: 技术债务评估
├── Agent 7: 安全性审查
├── Agent 8: 性能影响分析
├── Agent 9: 可维护性评估
└── Agent 10: 用户体验影响

Phase 2: 汇总（串行）
└── 主 Agent: 综合所有评审意见，输出评审报告
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-4.1 | 用户触发 `/critique` | 进入评审阶段 | 同时启动 10 个 Agent 并行评审不同维度 |
| AC-4.2 | 所有评审完成 | 汇总输出 | 主 Agent 综合意见，按严重程度排序输出 |
| AC-4.3 | 发现阻断性问题 | 标记处理 | 明确标注 BLOCKER，阻止进入下一阶段 |

**验证标准**：
- [ ] 评审阶段：10 个 Task 调用在同一消息中发出
- [ ] 评审报告包含所有 10 个维度的结论

---

### AC-5: `/design` 架构设计并行化

**当前问题**：模块设计、API 设计、数据模型设计串行

**目标架构**：
```
Phase 1: 并行设计（9 Agent）
├── Agent 1: 核心模块设计
├── Agent 2: 辅助模块设计
├── Agent 3: API 接口设计
├── Agent 4: 数据模型设计
├── Agent 5: 状态管理设计
├── Agent 6: 错误处理设计
├── Agent 7: 日志监控设计
├── Agent 8: 安全机制设计
└── Agent 9: 扩展性设计

Phase 2: 一致性校验（串行）
└── 主 Agent: 检查各设计间的一致性，解决冲突

Phase 3: 输出设计文档（串行）
└── 主 Agent: 整合输出完整设计文档
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-5.1 | 用户触发 `/design` | 进入设计阶段 | 同时启动 9 个 Agent 并行设计不同方面 |
| AC-5.2 | Phase 1 完成 | 一致性校验 | 检查接口契约、数据模型、模块边界是否一致 |
| AC-5.3 | 发现设计冲突 | 冲突解决 | 列出冲突点，给出解决方案建议 |
| AC-5.4 | 全部完成 | 输出文档 | 输出结构化设计文档（模块图 + API 契约 + 数据模型） |

**验证标准**：
- [ ] 设计阶段：9 个 Task 调用在同一消息中发出
- [ ] 输出文档包含所有 9 个设计维度

---

### AC-6: `/experts` 专家协作并行化

**当前问题**：设计为并行但未真正实现

**目标架构**：
```
Phase 1: 并行专家分析（8-10 Agent，按需）
├── Agent 1: 后端架构师
├── Agent 2: 前端架构师
├── Agent 3: 数据库专家
├── Agent 4: 安全专家
├── Agent 5: 性能专家
├── Agent 6: DevOps 专家
├── Agent 7: 测试专家
├── Agent 8: UX 专家
├── Agent 9: 业务分析师（可选）
└── Agent 10: 领域专家（可选）

Phase 2: 专家会诊（串行）
└── 主 Agent: 模拟圆桌会议，整合各专家意见

Phase 3: 输出决策（串行）
└── 主 Agent: 输出综合建议和行动项
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-6.1 | 用户触发 `/experts` | 进入分析阶段 | 同时启动 8-10 个专家 Agent 并行分析 |
| AC-6.2 | 所有专家完成分析 | 进入会诊阶段 | 整合各专家观点，识别共识和分歧 |
| AC-6.3 | 存在分歧 | 分歧处理 | 列出分歧点，给出权衡建议 |
| AC-6.4 | 全部完成 | 输出决策 | 输出综合建议、行动项、风险提示 |

**验证标准**：
- [ ] 专家分析阶段：8-10 个 Task 调用在同一消息中发出
- [ ] 每个专家给出独立意见，不相互依赖

---

## P2 优先级 AC

### AC-7: `/security` 安全扫描完全并行化

**当前问题**：工具部分并行，分析串行

**目标架构**：
```
Phase 1: 并行扫描（8 Agent）
├── Agent 1: Bandit 扫描
├── Agent 2: Semgrep 扫描
├── Agent 3: Gitleaks 扫描
├── Agent 4: 依赖漏洞扫描
├── Agent 5: SQL 注入检测
├── Agent 6: XSS 检测
├── Agent 7: 认证授权审查
└── Agent 8: 敏感数据暴露检测

Phase 2: 并行修复建议（8 Agent）
├── Agent 1-8: 各自为发现的漏洞生成修复代码

Phase 3: 汇总报告（串行）
└── 主 Agent: 按 OWASP Top 10 分类，输出报告
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-7.1 | 用户触发 `/security` | 进入扫描阶段 | 同时启动 8 个 Agent 并行执行不同安全检测 |
| AC-7.2 | 扫描完成 | 生成修复建议 | 同时启动 8 个 Agent 并行生成修复代码 |
| AC-7.3 | 全部完成 | 输出报告 | 按严重程度排序，每个漏洞附带可执行修复代码 |

**验证标准**：
- [ ] 扫描阶段：8 个 Task 调用在同一消息中发出
- [ ] 修复建议阶段：8 个 Task 调用在同一消息中发出

---

### AC-8: `/perf` 性能分析并行化

**当前问题**：串行执行各类性能分析

**目标架构**：
```
Phase 1: 并行分析（8 Agent）
├── Agent 1: CPU 热点分析
├── Agent 2: 内存使用分析
├── Agent 3: I/O 瓶颈分析
├── Agent 4: N+1 查询检测
├── Agent 5: 缓存命中分析
├── Agent 6: 并发性能分析
├── Agent 7: 网络延迟分析
└── Agent 8: 资源泄漏检测

Phase 2: 并行优化建议（8 Agent）
├── Agent 1-8: 各自为发现的问题生成优化方案

Phase 3: 汇总报告（串行）
└── 主 Agent: 按影响程度排序，输出火焰图和优化建议
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-8.1 | 用户触发 `/perf` | 进入分析阶段 | 同时启动 8 个 Agent 并行分析不同性能维度 |
| AC-8.2 | 分析完成 | 生成优化建议 | 同时启动 8 个 Agent 并行生成优化方案 |
| AC-8.3 | 全部完成 | 输出报告 | 按性能影响排序，附带可执行优化代码 |

**验证标准**：
- [ ] 分析阶段：8 个 Task 调用在同一消息中发出
- [ ] 优化建议阶段：8 个 Task 调用在同一消息中发出

---

### AC-9: `/overview` 项目概览并行化

**当前问题**：串行收集项目信息

**目标架构**：
```
Phase 1: 并行信息收集（8 Agent）
├── Agent 1: 目录结构分析
├── Agent 2: 技术栈识别
├── Agent 3: 依赖关系分析
├── Agent 4: 核心模块识别
├── Agent 5: API 端点收集
├── Agent 6: 数据模型分析
├── Agent 7: 配置文件分析
└── Agent 8: 文档收集

Phase 2: 汇总输出（串行）
└── 主 Agent: 整合信息，输出项目概览
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-9.1 | 用户触发 `/overview` | 进入信息收集阶段 | 同时启动 8 个 Agent 并行收集不同类型信息 |
| AC-9.2 | 全部完成 | 输出概览 | 输出结构化项目概览（架构图 + 模块说明 + 入口指引） |

**验证标准**：
- [ ] 信息收集阶段：8 个 Task 调用在同一消息中发出

---

### AC-10: `/refactor` 重构分析并行化

**当前问题**：串行分析代码坏味道

**目标架构**：
```
Phase 1: 并行分析（10 Agent）
├── Agent 1: God Class 检测
├── Agent 2: 长方法检测
├── Agent 3: 重复代码检测
├── Agent 4: 过度耦合检测
├── Agent 5: 接口膨胀检测
├── Agent 6: 魔法数字检测
├── Agent 7: 死代码检测
├── Agent 8: 命名规范检测
├── Agent 9: 复杂度分析
└── Agent 10: 依赖循环检测

Phase 2: 并行重构建议（10 Agent）
├── Agent 1-10: 各自生成重构方案

Phase 3: 汇总计划（串行）
└── 主 Agent: 整合为重构计划，交给 /run-plan 执行
```

| AC ID | Given | When | Then |
|-------|-------|------|------|
| AC-10.1 | 用户触发 `/refactor` | 进入分析阶段 | 同时启动 10 个 Agent 并行检测不同代码坏味道 |
| AC-10.2 | 分析完成 | 生成重构建议 | 同时启动 10 个 Agent 并行生成重构方案 |
| AC-10.3 | 全部完成 | 输出计划 | 输出结构化重构计划，可直接交给 `/run-plan` |

**验证标准**：
- [ ] 分析阶段：10 个 Task 调用在同一消息中发出
- [ ] 重构建议阶段：10 个 Task 调用在同一消息中发出

---

## 通用实现规范

### 并行调用模式

```markdown
所有并行 Agent 必须在同一条消息中通过多个 Task tool 调用发出：

<function_calls>
<invoke name="Task">
<parameter name="description">Agent 1 任务描述</parameter>
<parameter name="prompt">具体 prompt</parameter>
<parameter name="subagent_type">Explore</parameter>
</invoke>
<invoke name="Task">
<parameter name="description">Agent 2 任务描述</parameter>
<parameter name="prompt">具体 prompt</parameter>
<parameter name="subagent_type">Explore</parameter>
</invoke>
... 8-10 个并行调用
</function_calls>
```

### 错误处理

- 单个 Agent 失败不影响其他 Agent
- 最终汇总时标注失败 Agent 和原因
- 失败 Agent 数量超过 50% 时，整体任务标记为失败

### 超时控制

- 单个 Agent 超时：120 秒
- 整体阶段超时：300 秒
- 超时后强制进入下一阶段，标注超时 Agent

---

## 实施顺序

1. **第一批（P0）**：`/explore`、`/test-gen`、`/qa`
2. **第二批（P1）**：`/critique`、`/design`、`/experts`
3. **第三批（P2）**：`/security`、`/perf`、`/overview`、`/refactor`

---

## 验收标准（全局）

| 验收项 | 标准 |
|--------|------|
| 并行调用 | 每个并行点必须有 8-10 个 Task 调用在同一消息中发出 |
| 效率提升 | 优化后执行时间相比串行版本减少 50%+ |
| 稳定性 | 错误处理完善，单点失败不影响整体 |
| 兼容性 | 与现有工作流（`/check`、`/run-plan`）无缝衔接 |

---

## 文档契约

本 AC 文档是 Skills 并行优化的唯一需求来源。

- 输入：本 AC 文档
- 输出：各 Skill 的 SKILL.md 更新

后续 `/design` 和 `/plan` 阶段应基于此 AC 进行。

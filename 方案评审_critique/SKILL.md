---
name: critique
command: critique
user_invocable: true
description: 方案评审。在 /clarify、/explore、/design、/plan 完成后使用，以批评者视角审查方案，找出遗漏、矛盾、风险。特别适合非技术用户无法自行评估方案质量的场景。
---

# 方案评审 (Critique)

> **角色**：对抗式评审员（Agent-as-a-Judge）
> **目标**：以批评者视角审查方案，找出问题和风险
> **原则**：挑刺优先、业务语言、可操作建议
> **铁律**：**发现即修复，不分级** — 所有问题都必须修复，不留技术债
> **理论基础**：[CRITIC 框架](https://openreview.net/forum?id=Sx038qxjek)、[Agent-as-a-Judge](https://arxiv.org/html/2508.02994v1)
> **思考模式**：启用 ultrathink 深度思考，确保全面分析风险和遗漏

---

## 核心理念

**"LLM 批评能力比生成能力更强"** — 让一个 Agent 评审另一个 Agent 的输出是有效的。

**解决的问题**：
- 非技术用户无法判断方案质量
- AI 自己出的方案自己不会质疑
- 问题在实现后才发现，修复成本高

---

## 与 /check 的区别

| 维度 | `/critique`（本 Skill） | `/check` |
|------|----------------------|----------|
| **检查对象** | 还没实现的**方案** | 已写完的**代码** |
| **时机** | 设计阶段，实现前 | 开发完成后 |
| **目的** | 方案设计得好不好 | 代码写得对不对 |
| **发现问题** | 需求遗漏、设计缺陷 | 代码 bug、规范违反 |
| **修复成本** | 低（还没开始写） | 高（代码已写完） |

---

## 依赖规范

> **执行前按需读取**：以下规范文件在评审时按需加载。

| 规范文件 | 覆盖评审项 |
|---------|-----------|
| `~/.claude/rules/RULES.md` | 项目铁律、禁用词汇、文档生命周期 |
| `~/.claude/reference/全栈开发.md` | 前后端同步、API 设计规范 |
| `~/.claude/reference/性能效率.md` | 缓存策略、批量操作、N+1 问题 |
| `~/.claude/reference/代码质量.md` | 函数设计、错误处理、类型注解 |

**执行 /critique 时，根据评审对象自动读取相关规范文件。**

---

## 触发方式

用户输入 `/critique` 时激活此 skill。

**适用场景**：
- `/clarify` 完成后 → 评审需求文档
- `/explore` 完成后 → 评审方案选型
- `/design` 完成后 → 评审架构设计
- `/plan` 完成后 → 评审实施计划

**调用方式**：
```
/critique              # 自动识别最近完成的环节
/critique design       # 指定评审架构设计
/critique plan         # 指定评审实施计划
```

---

## 评审维度（5 维度）

| 维度 | 检查内容 | 业务语言示例 |
|------|---------|-------------|
| **完整性** | 是否有遗漏场景、边界情况 | "没考虑用户取消操作的情况" |
| **一致性** | 前后是否矛盾、与规范是否冲突 | "前面说支持批量，后面只处理单个" |
| **可行性** | 技术上能否实现、依赖是否可用 | "全房通接口不支持这个参数" |
| **风险** | 可能出什么问题、有什么隐患 | "并发时可能发重复消息给用户" |
| **业务对齐** | 是否满足原始业务需求 | "管家要的是批量操作，这里只能单个" |

---

## 执行流程

### Phase 1: 识别评审对象

```markdown
## 评审对象识别

**最近完成的环节**：[/clarify | /explore | /design | /plan]
**输出内容**：[文档名称或内容摘要]
**涉及文件**：[如有，列出相关文件]
```

如果无法识别，询问用户要评审什么。

---

### Phase 2: 读取相关规范

根据评审对象，读取对应的规范文件：

| 评审对象 | 必读规范 |
|---------|---------|
| /clarify 输出 | `~/.claude/rules/RULES.md`（项目铁律） |
| /explore 输出 | `~/.claude/reference/性能效率.md`（性能约束） |
| /design 输出 | `~/.claude/reference/全栈开发.md`、`~/.claude/reference/性能效率.md` |
| /plan 输出 | `~/.claude/reference/全栈开发.md`、`~/.claude/reference/代码质量.md` |

---

### Phase 3: 对抗式评审

**切换到批评者视角**，逐一检查 5 个维度：

#### 3.1 完整性检查

```markdown
### 完整性检查

**检查项**：
- [ ] 正常流程覆盖完整
- [ ] 异常流程有处理（失败、超时、取消）
- [ ] 边界情况有考虑（空值、极值、并发）
- [ ] 用户角色覆盖（不同权限的用户）

**发现的遗漏**：
1. [具体遗漏，用业务语言描述]
2. ...
```

#### 3.2 一致性检查

```markdown
### 一致性检查

**检查项**：
- [ ] 方案内部前后一致
- [ ] 与项目规范一致（铁律、全栈规范等）
- [ ] 与现有系统设计一致

**发现的矛盾**：
1. [具体矛盾，指出前后不一致的地方]
2. ...
```

#### 3.3 可行性检查

```markdown
### 可行性检查

**检查项**：
- [ ] 技术方案可实现
- [ ] 依赖的接口/服务可用
- [ ] 性能可接受
- [ ] 时间/资源充足

**发现的问题**：
1. [具体问题，说明为什么不可行]
2. ...
```

#### 3.4 风险识别

```markdown
### 风险识别

**检查项**：
- [ ] 并发/竞态问题
- [ ] 数据一致性问题
- [ ] 第三方依赖风险
- [ ] 安全风险

**发现的风险**：
1. [具体风险，说明可能导致什么后果]
2. ...
```

#### 3.5 业务对齐检查

```markdown
### 业务对齐检查

**原始需求**：[回顾 /clarify 的输出]

**检查项**：
- [ ] 满足核心业务目标
- [ ] 用户体验符合预期
- [ ] 不违背业务约束

**发现的偏离**：
1. [具体偏离，说明方案与需求不符的地方]
2. ...
```

---

### Phase 4: 输出评审报告

```markdown
## 评审报告

**评审对象**：[/design 输出的架构设计]
**评审时间**：YYYY-MM-DD HH:mm

---

### 总体评价

| 维度 | 评分 | 说明 |
|------|------|------|
| 完整性 | ✅ 高 / ⚠️ 中 / ❌ 低 | [一句话说明] |
| 一致性 | ✅ 高 / ⚠️ 中 / ❌ 低 | [一句话说明] |
| 可行性 | ✅ 高 / ⚠️ 中 / ❌ 低 | [一句话说明] |
| 风险 | ✅ 低 / ⚠️ 中 / ❌ 高 | [一句话说明] |
| 业务对齐 | ✅ 高 / ⚠️ 中 / ❌ 低 | [一句话说明] |

**总体建议**：✅ 可以继续 / ❌ 必须修复后继续

---

### 🔴 必须修复

> **原则：发现即修复，不留技术债**
>
> 所有评审发现的问题都必须修复。大问题是小问题累积出来的，要做就做到最好。

| # | 问题 | 业务影响 | 修复建议 |
|---|------|---------|---------|
| 1 | [问题描述，用业务语言] | [会导致什么后果] | [具体修复方法] |
| 2 | ... | ... | ... |

---

### 🟢 做得好的地方

> 肯定方案中的优点，建立信心

1. [优点 1]
2. [优点 2]

---

### 下一步

- [ ] 修复全部 X 个问题
- 修复后重新 /critique 确认
- 全部通过后继续执行 [/plan | /run-plan | ...]

或

- ✅ 无问题，可以继续执行 [下一个环节]
```

---

## 业务语言翻译表

**技术问题 → 业务语言**：

| 技术描述 | 业务语言 |
|---------|---------|
| 缺少异常处理，可能导致未捕获的 RuntimeError | 系统出错时会卡住，用户看不到任何提示 |
| N+1 查询问题 | 数据多的时候页面要等很久才能加载出来 |
| 缺少事务控制 | 批量操作可能只成功一半，数据会乱 |
| 没有并发控制 | 多人同时操作时可能互相覆盖，数据丢失 |
| 缺少重试机制 | 网络不好时操作会直接失败，用户要重新来 |
| 硬编码配置 | 换环境要改代码，容易出错 |
| 没有缓存 | 每次操作都很慢，用户体验差 |
| 接口没有限流 | 被恶意调用时系统会崩溃 |

---

## 不同环节的评审重点

### 评审 /clarify 输出（需求文档）

**重点**：
- 需求是否完整、有无歧义
- 边界情况是否定义清楚
- 验收标准是否可测量

**常见问题**：
- "用户可以管理文档" → 什么操作算管理？增删改查都支持吗？
- "系统要快" → 多快算快？1 秒还是 5 秒？

---

### 评审 /explore 输出（方案选型）

**重点**：
- 方案对比是否全面
- 选择依据是否充分
- 有无遗漏的主流方案

**常见问题**：
- 只对比了 2 个方案，漏了更适合的
- 选择依据是"简单"，但没考虑可扩展性

---

### 评审 /design 输出（架构设计）

**重点**：
- 模块职责是否清晰
- 接口设计是否完整（含错误处理）
- 数据模型是否合理
- 是否违反项目规范

**常见问题**：
- 没有定义接口的错误响应
- 缺少异常情况的处理流程
- 模块间有循环依赖

---

### 评审 /plan 输出（实施计划）

**重点**：
- 步骤顺序是否合理（先后端后前端）
- 每步是否可验证
- 是否遗漏关键步骤
- 是否违反项目铁律
- **AC 是否引用而非重新定义**（新增）
- **测试设计状态是否完整**（新增）

**AC 引用检查项**（阻塞项）：

| 检查项 | 要求 | 常见问题 |
|--------|------|---------|
| AC 来源声明 | 必须声明引用 /clarify 的 AC | 直接定义新的验收场景 |
| AC 文档路径 | 必须指向 `docs/需求文档/clarify_*.md` | 路径错误或缺失 |
| 禁止重新定义 | 不能修改或新增 AC | 在 /plan 中新增了 /clarify 没有的场景 |
| 测试设计状态 | 必须有测试设计检查点 | 缺少门控检查 |

**验收测试场景检查项**（阻塞项）：

| 检查项 | 要求 | 常见问题 |
|--------|------|---------|
| 引用而非定义 | 引用 /clarify 的 AC 表格 | 重新定义 AC |
| 格式正确 | 引用链接 + AC 列表 | 只写了描述，没有引用 |
| 完整性 | 引用所有相关 AC | 遗漏部分 AC |

**常见问题**：
- 先做前端后做后端
- 缺少联调验证步骤
- 步骤粒度太粗，无法验证
- **AC 重新定义而非引用**（阻塞）- /plan 中的 AC 与 /clarify 不一致
- **缺少测试设计状态检查点**（阻塞）- 没有门控确保测试先于开发
- **AC 来源文档路径错误**（阻塞）- 无法追溯到单一来源

---

## 与其他 Skills 的关系

```
/clarify（需求澄清）
    ↓
/explore（方案探索）
    ↓
/design（架构设计）
    ↓ 完成后自动触发
/critique（评审架构）← 自动
    ↓ 评审通过后
/plan（写计划）
    ↓ 完成后自动触发
/critique（评审计划）← 自动
    ↓ 评审通过后
/run-plan（执行计划）
    ↓
/check（检查代码）
    ↓
/qa（测试验收）
```

---

## 禁止行为

| 禁止 | 原因 |
|------|------|
| 敷衍评审，全说"没问题" | 失去评审意义 |
| 用技术术语吓唬用户 | 用户看不懂，无法判断 |
| 只挑刺不给解决方案 | 用户不知道怎么改 |
| 评审时开始改方案 | 评审和修改是两个环节 |

---

## 完成检查清单

- [ ] 识别了评审对象
- [ ] 读取了相关规范
- [ ] 完成了 5 维度评审
- [ ] 问题用业务语言描述
- [ ] 每个问题都有修复建议
- [ ] 所有问题都列为必须修复（不分级）
- [ ] 给出了明确的下一步建议

---

## ✅ 完成提示

```
✅ 方案评审完成

📊 评审结果：
- 评审阶段：[/clarify | /explore | /design | /plan]
- 发现问题：X 个（全部必须修复）
- 总体评价：[可以继续 / 必须修复后继续]

🎯 下一步：
- [修复全部问题，然后重新 /critique]

评审通过后继续（根据当前阶段）：
- 评审 /clarify 输出 → /explore（方案探索）
- 评审 /explore 输出 → /design（架构设计）
- 评审 /design 输出 → /plan（写计划）
- 评审 /plan 输出 → /test-gen（测试先行）→ /run-plan
```

---

**版本**：v1.3（上下文感知版）
**创建日期**：2025-01-27
**更新日期**：2026-01-29
**理论基础**：CRITIC 框架、Agent-as-a-Judge、Self-Critique
**v1.3 变更**：
- 完成提示增加「评审阶段」字段，明确当前评审的是哪个环节
- 下一步建议根据评审阶段动态输出，避免跳过 /test-gen 等环节
- 修复：评审 /plan 后直接跳到 /run-plan 的问题
**v1.2 变更**：
- 取消问题分级，所有问题都必须修复
- 原则：发现即修复，不留技术债
- 大问题是小问题累积出来的，要做就做到最好

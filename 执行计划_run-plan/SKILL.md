---
name: run-plan
command: run-plan
user_invocable: true
description: 执行计划。支持两种执行模式：依赖链模式（按依赖拓扑排序）和多人协作模式（按功能分派开发者，效率提升 2-5 倍）。内置严格 TDD 和完成前验证。在写计划（/plan）之后、开发检查（/check）之前使用。
---

# 执行计划 (Run Plan)

> **角色**：Tech Lead，负责任务分派、协调和集成
> **流程**：`/plan` 之后 → `/check` 之前

---

## ⚠️ 执行前必读（铁律）

**执行 /run-plan 时，必须按以下顺序加载文件**：

```
┌────────────────────────────────────────────────────────────────┐
│ 步骤 1: 读取本文件 (SKILL.md)                                   │
│         理解总体框架、执行模式、核心原则                          │
└────────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤 2: 读取 Tech Lead 操作手册                                 │
│         ~/.claude/skills/执行计划_run-plan/prompts/tech-lead.md │
│         按手册步骤执行，这是你的详细操作指南                      │
└────────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤 3: 派发任务时，读取 Implementer 规范                        │
│         ~/.claude/skills/执行计划_run-plan/prompts/implementer.md│
│         作为子代理的 prompt 模板，组装后发送给子代理              │
└────────────────────────────────────────────────────────────────┘
```

**禁止行为**：
- ❌ 只读 SKILL.md 就开始执行（缺少详细操作步骤）
- ❌ 跳过 tech-lead.md 直接派发任务（不知道如何组装 prompt）
- ❌ 不读 implementer.md 就创建子代理（子代理没有执行规范）

---

## 三文件配合流程图

```
用户执行 /run-plan
       ↓
┌──────────────────────────────────────────────────────────────┐
│ SKILL.md (本文件)                                            │
│ ─────────────────                                            │
│ 你读取本文件，理解：                                           │
│ • 自己是 Tech Lead 角色                                       │
│ • 有两种执行模式（多人协作/依赖链）                              │
│ • 核心原则是什么                                              │
│                                                              │
│ 然后立即读取 tech-lead.md ↓                                   │
└──────────────────────────────────────────────────────────────┘
       ↓
┌──────────────────────────────────────────────────────────────┐
│ tech-lead.md (Tech Lead 操作手册)                             │
│ ────────────────────────────────                              │
│ 你按照此手册的步骤操作：                                        │
│ • 第一步：读取计划文档                                         │
│ • 第二步：分组执行                                             │
│ • 第三步：完成前置工作                                         │
│ • 第四步：组装子代理 prompt ──┐                                │
│ • 第五步：处理返回结果        │                                │
│ • 第六步：状态更新            │                                │
│ • 第七步：服务启动验证        │                                │
│ • 第八步：中断恢复            │                                │
└───────────────────────────────│──────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────┐
│ implementer.md (子代理 Prompt 模板)                           │
│ ─────────────────────────────────                             │
│ 你读取此文件，作为子代理的 prompt 模板                          │
│                                                              │
│ 组装方式：                                                    │
│ ┌──────────────────────────────────────────────────────────┐ │
│ │ <Task description="Alice 执行登录功能">                   │ │
│ │   [implementer.md 的内容]                                │ │
│ │   +                                                      │ │
│ │   [任务参数: 角色=Alice, 文件范围=login.py, 任务详情...]   │ │
│ │ </Task>                                                  │ │
│ └──────────────────────────────────────────────────────────┘ │
│                                                              │
│ 子代理 Alice/Bob/Charlie 按此规范执行：                        │
│ • 严格 TDD                                                   │
│ • 只修改分配的文件                                            │
│ • 完成前验证                                                  │
│ • 返回完成报告或问题报告                                       │
└──────────────────────────────────────────────────────────────┘
```

---

## 操作手册（执行时必读）

| 手册 | 路径 | 用途 | 加载时机 |
|------|------|------|---------|
| **Tech Lead 操作手册** | `~/.claude/skills/执行计划_run-plan/prompts/tech-lead.md` | 你的详细操作指南 | 读完 SKILL.md 后立即读取 |
| **Implementer 规范** | `~/.claude/skills/执行计划_run-plan/prompts/implementer.md` | 子代理的 prompt 模板 | 派发任务时读取并组装 |

---

## 参考规范

| 规范 | 路径 | 用途 |
|------|------|------|
| **TDD 规范** | `~/.claude/reference/TDD规范.md` | 严格 TDD 流程 |
| **完成前验证** | `~/.claude/reference/完成前验证.md` | 验证清单 |
| **并行拆分策略** | `~/.claude/reference/并行拆分策略.md` | 多人协作拆分原则 |

---

## 执行模式

### 模式识别（根据计划文档自动判断）

| 模式 | 识别特征 | 适用场景 | 效率提升 |
|------|---------|---------|---------|
| **多人协作模式** | Tasks 表格有"负责人"列 | 功能独立、文件不冲突 | **2-5 倍** |
| **依赖链模式** | Tasks 表格无"负责人"列 | 强依赖、功能耦合 | 40-60% |

### 多人协作模式架构（推荐）

```
Tech Lead 前置工作（基础设施）
    ↓
开发者并行执行
┌─────────┐  ┌─────────┐  ┌─────────┐
│ Alice   │  │ Bob     │  │ Charlie │ ← 并行
│ 登录功能│  │ 注册功能│  │ 重置密码│
└─────────┘  └─────────┘  └─────────┘
    ↓ 等待全部完成
Tech Lead 后置工作（集成 + 服务启动验证）
    ↓
/check
```

### 依赖链模式架构

```
按依赖分组（拓扑排序）→ 组内并行 → 组间串行 → 服务启动验证 → /check
```

---

## 核心原则

| 原则 | 说明 |
|------|------|
| **职责边界清晰** | 每个开发者负责完整功能（前+后端），不越界 |
| **文件隔离** | 每个开发者只修改分配的文件，避免冲突 |
| **严格 TDD** | 必须先看到测试失败，再写实现代码 |
| **完成前验证** | 必须亲眼看到验证命令成功，才能声明完成 |
| **服务启动验证** | 集成后必须验证服务能正常启动并响应请求 |

---

## 角色分工

### Tech Lead（你）

**职责**：
1. 读取计划 → 识别执行模式
2. 完成基础设施（前置工作）
3. 派发任务 → 监控进度 → 处理问题
4. 合并代码 → **服务启动验证**（后置工作）

**详细操作**：见 `~/.claude/skills/执行计划_run-plan/prompts/tech-lead.md`

### 开发者 Alice/Bob/Charlie（子代理）

**职责**：
- **只修改分配的文件**（禁止越界）
- **遵循严格 TDD**（RED-GREEN-REFACTOR）
- **完成前验证**（亲眼看到命令成功）
- 提交结果（代码 + 测试报告）

**执行规范**：见 `~/.claude/skills/执行计划_run-plan/prompts/implementer.md`

**文件边界约束（铁律）**：
```
❌ 禁止：Alice 修改 Bob 负责的 register.py
✅ 允许：Alice 只修改 login.py, LoginForm.tsx
```

---

## 执行流程概述

```
1. 读取计划文档，解析 Tasks 表格
    ↓
2. 识别执行模式（多人协作 / 依赖链）
    ↓
3. 分组执行
   ├─ 多人协作: Tech Lead前置 → 开发者并行 → Tech Lead后置
   └─ 依赖链: 拓扑排序 → 组内并行 → 组间串行
    ↓
4. 派发任务（在一条消息中发送多个 Task 调用实现并行）
    ↓
5. 处理结果（成功→更新状态，失败→/debug分析→重试）
    ↓
6. 服务启动验证
    ↓
7. 完成
```

**详细步骤**：见 `~/.claude/skills/执行计划_run-plan/prompts/tech-lead.md`

---

## 状态更新

**每个 Task 完成后立即更新**（不等批次结束）：

1. 更新计划文档 checkbox: `- [ ] T1` → `- [x] T1`
2. 更新 TaskUpdate: status → completed

**为什么立即更新**：
- 支持中断恢复
- 进度可见
- 避免重复执行

---

## 服务启动验证（铁律）

> 如果没有看到服务正常启动并响应请求，就不能声称完成。

```bash
# 启动服务
python -m uvicorn app.main:app &
sleep 3

# 验证健康检查
curl -f http://localhost:8000/health || echo "❌ 失败"

# 停止服务
kill %1
```

**验证清单**：
- [ ] 服务启动无报错
- [ ] 健康检查端点响应 200
- [ ] 核心 API 能正常响应

---

## 中断恢复

- **权威来源**：计划文档 checkbox
- **恢复方式**：重新执行 /run-plan，自动从 checkbox 状态恢复
- **扫描路径**：`docs/开发文档/plan_*.md`

---

## 禁止行为

| 禁止 | 原因 |
|------|------|
| 串行执行所有 Tasks | 失去并行优势 |
| 跳过 TDD | 代码质量无保证 |
| 不更新 checkbox | 无法中断恢复 |
| 假设性完成 | 必须有实际执行结果 |
| 等批次结束才更新状态 | 中断时状态丢失 |
| 跳过服务启动验证 | 集成问题无法发现 |
| 不读 tech-lead.md 就执行 | 缺少详细操作步骤 |

---

## ✅ 完成提示

```
✅ 计划执行完成

📊 执行统计:
- 执行模式: 多人协作模式
- 并行开发者: Alice, Bob, Charlie
- 效率提升: 2-5 倍

📋 开发者完成情况:
- Alice (登录功能): ✅ TDD 通过, 验证通过
- Bob (注册功能): ✅ TDD 通过, 验证通过
- Charlie (密码重置): ✅ TDD 通过, 验证通过

🔧 Tech Lead 集成验证:
- 服务启动: ✅ 健康检查通过

下一步: /check（开发检查）
```

---

**版本**：v3.1（分层架构 + 加载顺序明确 + 配合流程图）
**更新日期**：2025-01-28

# Implementer 标准输出格式

> 定义 Implementer 子代理返回给主代理的标准输出格式
> 主代理依据此格式解析并决定后续动作

---

## 输出类型

Implementer 有三种输出类型，主代理通过顶级标记识别：

| 输出类型 | 标记 | 含义 |
|---------|------|------|
| **完成报告** | `## ✅ Task 完成报告` | 任务成功完成 |
| **问题报告** | `## ❌ 问题报告` | 遇到问题无法继续 |
| **澄清请求** | `## ❓ 澄清请求` | 需要更多信息 |

---

## 输出格式一：完成报告

当 Task 成功完成时使用：

```markdown
## ✅ Task 完成报告

### 元数据
- **Task ID**: [Task-N 或任务名称]
- **完成时间**: YYYY-MM-DD HH:mm
- **耗时**: 预计 X 分钟

### 实现摘要
[1-2 句话描述做了什么]

### 变更清单

#### 新增文件
| 文件路径 | 行数 | 说明 |
|---------|------|------|
| `backend/app/api/v1/xxx.py` | 50 | API 路由 |
| `backend/tests/test_xxx.py` | 80 | 单元测试 |

#### 修改文件
| 文件路径 | 变更范围 | 说明 |
|---------|---------|------|
| `backend/app/core/config.py` | 23-45行 | 添加新配置 |

### 验证结果
| 验证标准（来自计划） | 状态 | 备注 |
|---------------------|------|------|
| [验证标准 1] | ✅ | |
| [验证标准 2] | ✅ | |
| [验证标准 3] | ✅ | |

### 测试结果
- **运行命令**: `pytest backend/tests/test_xxx.py -v`
- **通过/总数**: 5/5
- **覆盖率**: 85%

### 自审检查
| 检查类型 | 状态 | 说明 |
|---------|------|------|
| 完整性 | ✅ | 所有功能已实现 |
| 质量 | ✅ | 代码干净可维护 |
| 纪律 | ✅ | 无过度构建 |
| 测试 | ✅ | TDD 流程已遵循 |

### 备注（可选）
[任何需要主代理或审查员注意的事项]
```

---

## 输出格式二：问题报告

当遇到问题无法继续时使用：

```markdown
## ❌ 问题报告

### 元数据
- **Task ID**: [Task-N 或任务名称]
- **报告时间**: YYYY-MM-DD HH:mm
- **问题严重程度**: [阻塞 | 需要帮助 | 需要决策]

### 问题类型
- [ ] 测试失败（超过 2 次尝试）
- [ ] 多个测试同时失败
- [ ] 依赖缺失
- [ ] 环境问题
- [ ] 任务描述不清晰
- [ ] 发现无法完成的阻碍
- [ ] 其他

### 问题描述
[详细描述遇到的问题]

### 错误信息
```
[完整的错误堆栈或日志]
```

### 已尝试的解决方案
| # | 尝试内容 | 结果 |
|---|---------|------|
| 1 | [尝试 1] | ❌ [失败原因] |
| 2 | [尝试 2] | ❌ [失败原因] |

### 当前进度

#### 已完成
- [x] [已完成的步骤 1]
- [x] [已完成的步骤 2]

#### 未完成
- [ ] [未完成的步骤 1]
- [ ] [未完成的步骤 2]

### 相关文件
| 文件路径 | 行号 | 说明 |
|---------|------|------|
| `backend/app/services/xxx.py` | 45 | 问题发生位置 |

### 我的分析
[Implementer 对问题原因的分析]

### 建议的下一步
[Implementer 认为可能的解决方向]

1. [建议 1]
2. [建议 2]
```

---

## 输出格式三：澄清请求

当需要更多信息才能继续时使用：

```markdown
## ❓ 澄清请求

### 元数据
- **Task ID**: [Task-N 或任务名称]
- **请求时间**: YYYY-MM-DD HH:mm
- **阻塞状态**: [可继续其他部分 | 完全阻塞]

### 问题列表

#### 问题 1: [简短标题]
**类型**: [需求澄清 | 技术选择 | 边界情况 | 依赖确认]
**描述**: [详细描述问题]
**选项**（如适用）:
- A: [选项 A 描述]
- B: [选项 B 描述]
**影响**: [这个问题不澄清会导致什么]

#### 问题 2: [简短标题]
...

### 当前进度
[描述在等待澄清期间已经完成的部分]

### 继续条件
回答以上问题后，我将继续执行任务。
```

---

## 主代理解析规则

### 识别输出类型

```python
def parse_implementer_output(output: str) -> dict:
    if "## ✅ Task 完成报告" in output:
        return {"type": "completed", "data": parse_completion(output)}
    elif "## ❌ 问题报告" in output:
        return {"type": "problem", "data": parse_problem(output)}
    elif "## ❓ 澄清请求" in output:
        return {"type": "clarification", "data": parse_clarification(output)}
    else:
        return {"type": "unknown", "data": output}
```

### 后续动作决策

| 输出类型 | 主代理动作 |
|---------|-----------|
| `completed` | 提取变更信息 → 调度 spec-reviewer |
| `problem` | 分析问题 → 调用 /debug 或人工介入 |
| `clarification` | 回答问题 → 重新调度 Implementer |

---

## 注意事项

1. **格式严格**：必须使用指定的标记（`## ✅`、`## ❌`、`## ❓`）
2. **信息完整**：所有必填字段都要填写
3. **表格格式**：使用 Markdown 表格便于解析
4. **不要混合**：一次输出只能是一种类型

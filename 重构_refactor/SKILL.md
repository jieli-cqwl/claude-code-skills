---
name: refactor
command: refactor
user_invocable: true
description: 代码重构。遵循简单、合适、演化原则，让代码保持最佳状态。自动识别语言并应用对应的重构规则。
---

# 代码重构 (Refactor)

> **角色**：代码质量守护者
> **目标**：让代码保持"恰到好处"的状态
> **原则**：简单、合适、演化
> **思考模式**：启用 ultrathink 深度思考，全面评估重构影响范围

---

## 核心理念

**"重构不是简化，而是让代码恰到好处"**

| 误区 | 正确理解 |
|------|---------|
| 代码越少越好 | 代码量要**合适** |
| 抽象越少越好 | 抽象要**恰当** |
| 简单就是好 | **必要的复杂**也是好的 |

---

## 三大原则

### 1. 简单原则

**不过度设计**

| 检查 | 行动 |
|------|------|
| 只有一个实现的接口 | 删除接口 |
| "万一将来需要"的代码 | 删除（YAGNI） |
| 只是透传的中间层 | 合并层 |

### 2. 合适原则

**该复杂时复杂，该简单时简单**

| 场景 | 正确做法 |
|------|---------|
| 业务本身复杂 | 保持必要的复杂度 |
| 有多个实现需要切换 | 保留接口抽象 |
| 有真实的扩展需求 | 保留扩展点 |

### 3. 演化原则

**根据实际需求演化，而非预设**

| 误区 | 正确做法 |
|------|---------|
| 预先设计所有扩展点 | 需要时再加 |
| 一开始就分层完整 | 逐步演化分层 |
| 提前抽象公共模块 | 重复 3 次再抽象 |

---

## 重构方向

重构不只是"减法"，可能是：

| 方向 | 场景 | 行动 |
|------|------|------|
| **减法** | 过度设计 | 删除不必要的抽象 |
| **加法** | 设计不足 | 补充必要的抽象 |
| **调整** | 设计不当 | 重新划分职责 |

---

## 语言识别与路由

根据代码语言，自动应用对应的重构规则：

| 语言 | 专属 Skill | 核心关注 |
|------|-----------|---------|
| **Java** | `/refactor-java` | God Class、接口泛滥、Spring 分层 |
| **Python** | `/refactor-py` | ABC 滥用、装饰器嵌套、过度 OOP |

**自动识别规则**：
- 看到 `.java` 文件 → 应用 Java 规则
- 看到 `.py` 文件 → 应用 Python 规则
- 用户可直接指定：`/refactor-java` 或 `/refactor-py`

---

## 执行流程

```
Phase 1: 代码诊断
    ↓
Phase 2: 识别问题（过度设计 or 设计不足）
    ↓
Phase 3: 确定重构方向（减法/加法/调整）
    ↓
Phase 4: 制定重构计划
    ↓
Phase 5: 输出计划文档
    ↓
交给 /run-plan 执行
```

---

### Phase 1: 代码诊断

**通用指标**：

| 层级 | 核心指标 | 警戒阈值 |
|------|---------|---------|
| **文件级** | 代码行数 | >300 行（可能需要拆分） |
| **类级** | 方法数、依赖数 | >10 方法，>5 依赖 |
| **函数级** | 行数、圈复杂度 | >50 行，>10 复杂度 |

---

### Phase 2: 识别问题

| 问题类型 | 特征 | 方向 |
|---------|------|------|
| **过度设计** | 抽象多但实现少、层级多但只透传 | 减法 |
| **设计不足** | 职责混乱、重复代码多、难以扩展 | 加法 |
| **设计不当** | 边界划分不清、依赖方向错误 | 调整 |

---

### Phase 3-5: 制定计划并输出

输出到 `docs/开发文档/plan_重构_[模块名].md`

---

## 危险信号

| 信号 | 行动 |
|------|------|
| 重构后代码更难理解 | 停，方向可能错了 |
| 重构引入新的复杂度而无收益 | 停，重新评估 |
| 重构破坏了现有功能 | 停，先写测试保护 |
| 没有明确目标就开始重构 | 停，先诊断 |

---

## 与其他 Skills 的关系

```
发现代码问题 / 准备优化
    ↓
/refactor（重构）← 当前（自动路由到语言专属 skill）
    ↓ 输出重构计划
/run-plan（执行计划）
    ↓
/check（开发检查）
    ↓
/qa（测试验收）
```

---

## 完成检查清单

- [ ] 代码诊断完成，问题类型明确
- [ ] 重构方向确定（减法/加法/调整）
- [ ] 重构计划输出，每步可验证
- [ ] 符合三原则（简单、合适、演化）
- [ ] 计划文档已保存到 `docs/开发文档/`

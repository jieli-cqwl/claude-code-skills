---
name: scan
command: scan
user_invocable: true
description: 代码质量扫描。扫描指定项目的整体代码质量，发现存量问题。适用于定期巡检、接手新项目、系统性质量评估。输出健康度评分和分级问题清单。用法：/scan [项目路径]
---

# 代码扫描 (Scan)

> **角色**：代码质量检测员
> **目标**：评估项目整体代码健康度，发现存量问题
> **原则**：全量扫描、按严重程度分级、给出可执行建议
> **流程**：识别项目 → 并行扫描 → 汇总报告
> **思考模式**：启用 ultrathink 深度思考，全面检查代码质量问题

---

## 何时使用

| 场景 | 使用 |
|------|------|
| 接手新项目，评估技术债规模 | ✅ 必须 |
| 定期巡检（每周/每月） | ✅ 推荐 |
| 重构前评估现状 | ✅ 推荐 |
| 代码审查前预检 | ⚠️ 互补（用 /check 更适合） |
| 开发完成后检查变更 | ❌ 不适用（用 /check） |
| 单文件快速检查 | ❌ 不适用（直接 Read） |

---

## 与 /check 的区别

| 维度 | /check | /scan |
|------|--------|-------|
| **范围** | 变更文件（git diff） | 全项目 |
| **时机** | 开发完成后 | 定期巡检、接手项目 |
| **输出** | 通过/不通过 | 健康度评分 + 详细报告 |
| **用途** | 防止新问题引入 | 发现存量问题 |

**检测规则一致性**：两个 Skill 的铁律检测、安全检测规则继承自同一规范（`~/.claude/reference/代码质量.md`），确保检测结果一致。

---

## 前置条件

- 项目路径有效且可访问
- 项目包含可识别的语言标识文件（`pom.xml`、`package.json`、`pyproject.toml` 等）
- 无需安装额外依赖，纯 Grep + LLM 分析

---

## 执行流程

```
/scan [项目路径]
    ↓
Phase 1: 项目识别（语言、规模、忽略目录）
    ↓
Phase 2: 并行扫描（4 个 Agent 同时执行）
    ┌────────────────────────────────────────────────┐
    │  Agent1: 铁律检测        Agent2: 安全漏洞      │
    │  - 降级逻辑              - SQL 注入            │
    │  - 硬编码                - XSS 风险            │
    │  - Mock（非测试）        - 敏感信息泄露        │
    │                                                │
    │  Agent3: 代码规范        Agent4: 技术债        │
    │  - 函数过长              - TODO/FIXME/HACK     │
    │  - 空 catch 块           - 废弃代码            │
    │  - System.out 使用       - 大文件统计          │
    └────────────────────────────────────────────────┘
    ↓
Phase 3: 汇总报告
    - 计算健康度评分
    - 输出终端摘要
    - 保存 Markdown 报告
```

---

## Phase 1: 项目识别

**自动检测语言**：
| 标识文件 | 语言 |
|---------|------|
| `pom.xml` / `build.gradle` | Java |
| `package.json` | JavaScript/TypeScript |
| `pyproject.toml` / `requirements.txt` | Python |
| `go.mod` | Go |
| `Cargo.toml` | Rust |

**自动忽略目录**：
- `node_modules/`, `dist/`, `build/`, `target/`
- `__pycache__/`, `.venv/`, `venv/`
- `.git/`, `.idea/`, `.vscode/`
- `vendor/`, `coverage/`

---

## Phase 2: 并行扫描

### Agent1: 铁律检测

> 检测规则来源：`~/.claude/reference/代码质量.md`

**降级逻辑**：

| 语言 | 检测模式 |
|------|---------|
| Java | `orElse(null)`, `orElseGet(() -> null)`, `catch.*return null` |
| Python | `except:.*pass`, `except.*return None`, `or None$` |
| TypeScript | `?? null`, `\|\| null`, `catch.*return null` |

**硬编码**：

| 类型 | 检测模式 |
|------|---------|
| URL | `http://localhost`, `127.0.0.1`, `://.*:\d{4,5}` |
| 密钥 | `(api_key\|secret\|password\|token)\s*=\s*"[^"]+"` |
| 配置文件 | `.yml`, `.properties`, `.env` 中的敏感值 |

**常量分层**（详见 `~/.claude/reference/硬编码治理规范.md`）：

| 类型 | 检测模式 | 严重程度 |
|------|---------|---------|
| 跨模块导入 | `from src.{module_a}.constants import` 在其他模块中出现 | 🟡 警告 |
| 缺少前缀 | 模块 constants.py 中 `^[A-Z_]+ =` 不带模块前缀 | 🟡 警告 |
| 常量膨胀 | constants.py 行数 > 200 | 🟡 警告 |

**Mock（非测试目录）**：

| 语言 | 检测模式 |
|------|---------|
| Python | `@patch`, `MagicMock`, `Mock(` |
| TypeScript | `vi.fn`, `vi.mock`, `jest.fn`, `jest.mock` |
| Java | `@Mock`, `Mockito.`, `when().thenReturn` |

**输出格式**：
```
[严重程度] [文件:行号] [类型] [代码片段]
示例：🔴 AuthService.java:45 硬编码密钥 apiKey = "sk-xxx"
```

---

### Agent2: 安全漏洞检测

| 类型 | 检测模式 | 严重程度 |
|------|---------|---------|
| SQL 注入 | 字符串拼接 SQL（`"SELECT" +`） | 🔴 严重 |
| XSS | `dangerouslySetInnerHTML`, `innerHTML =` | 🔴 严重 |
| 敏感信息日志 | `log.*(password\|token\|secret)` | 🔴 严重 |
| 未授权接口 | 无权限校验的危险操作 | 🔴 严重 |

---

### Agent3: 代码规范检测

| 规则 | 阈值 | 严重程度 |
|------|------|---------|
| 函数长度 | > 40 行 | 🟡 警告 |
| 文件长度 | > 500 行 | 🟡 警告 |
| 空 catch 块 | 存在 | 🟡 警告 |
| 裸 except | 存在 | 🟡 警告 |
| System.out 使用 | 存在 | 🟡 警告 |

---

### Agent4: 技术债统计

| 类型 | 检测模式 | 严重程度 |
|------|---------|---------|
| FIXME | `FIXME:` | 🟡 警告 |
| HACK | `HACK:` | 🟡 警告 |
| TODO | `TODO:` | 🔵 建议 |
| XXX | `XXX:` | 🔵 建议 |
| @Deprecated | 废弃代码 | 🔵 建议 |
| @Disabled 测试 | 禁用的测试 | 🔵 建议 |

---

## Phase 3: 汇总报告

### 健康度评分算法

```
评分 = 100 - (严重 × 3) - (警告 × 0.5) - (建议 × 0.1)
最低 0 分，最高 100 分

评级：
  90-100: A (优秀)
  80-89:  B (良好)
  70-79:  C (一般)
  60-69:  D (较差)
  <60:    F (需要重构)
```

### 终端输出格式

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 代码质量扫描报告 - [项目名]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏆 健康度评分: XX/100 (评级)

📁 扫描范围: X 个文件
🛠️ 技术栈: [语言列表]

┌─────────────────────────────────────────────────┐
│  🔴 严重问题    X 个                             │
│  🟡 警告        X 个                             │
│  🔵 建议        X 个                             │
└─────────────────────────────────────────────────┘

🔴 严重问题 TOP 5:
  1. [文件:行号] - [类型] - [简述]
  2. ...

📄 完整报告: docs/技术债扫描/[日期]_技术债扫描报告.md
```

### Markdown 报告

**保存路径**：`docs/技术债扫描/[YYYY-MM-DD]_技术债扫描报告.md`

报告包含：
- 健康度评分和评级
- 严重问题完整列表（文件、行号、代码片段、修复建议）
- 警告完整列表
- 建议完整列表
- 修复优先级建议

---

## 使用示例

```bash
# 扫描指定项目
/scan /path/to/project

# 扫描当前目录
/scan .

# 扫描子目录
/scan /path/to/project/backend
```

---

## 注意事项

1. **大项目分目录扫描**：超过 1000 个文件建议按模块扫描
2. **配置文件单独审查**：`.yml`、`.env` 中的硬编码需人工确认是否为开发配置
3. **测试文件特殊处理**：Mock 检测排除 `test/`、`tests/`、`__tests__/` 目录

---

## ⛔ 铁律约束

| 约束 | 要求 |
|------|------|
| **输出位置** | 必须保存到 `docs/技术债扫描/` 目录，禁止在项目根目录生成任何文件 |
| **文件命名** | 必须使用格式：`[YYYY-MM-DD]_技术债扫描报告.md` |
| **单一报告** | 只生成一个主报告文件，禁止生成多个冗余文件 |

**禁止行为**：
- ❌ 在项目根目录生成 `.md` 或 `.txt` 文件
- ❌ 生成多个报告文件（如 `README.md`、`xxx_DETAILED.txt` 等）
- ❌ 使用英文或非标准文件名

---

## 与其他 Skills 的关系

```
/overview（项目概览）
    ↓ 了解项目后
/scan（代码扫描）← 当前（推荐用于存量检查）
    ↓ 发现问题后
/refactor（代码重构）

日常开发流程：
/plan → /run-plan → /check → /qa → /ship
                       ↑
              /scan 与 /check 互补
              /scan: 全量存量检查
              /check: 增量变更检查
```

---

## ✅ 完成提示

```
✅ 代码质量扫描完成

📊 健康度: XX/100 (评级)
   🔴 严重: X 个
   🟡 警告: X 个
   🔵 建议: X 个

📄 报告: docs/技术债扫描/[日期]_技术债扫描报告.md

🎯 下一步:
1. 立即修复严重问题（安全漏洞、铁律违反）
2. 计划修复警告问题
3. 执行 /refactor 清理技术债
```

---

**版本**：v1.0
**创建日期**：2025-01-26

# H5 状态管理规范

> Pinia 状态管理使用规范

---

## 一、Store 结构

### 1.1 目录结构

```
store/
├── Index.js               # 统一导出
└── modules/
    ├── Common.js          # 公共状态（系统信息、用户信息）
    ├── User.js            # 用户状态
    └── Tenant.js          # 租客业务状态
```

### 1.2 Index.js 导出

```javascript
// store/Index.js
import useCommonStore from './modules/Common'
import useUserStore from './modules/User'
import useTenantStore from './modules/Tenant'

export {
  useCommonStore,
  useUserStore,
  useTenantStore
}
```

---

## 二、Store 定义规范

### 2.1 基础模板

```javascript
// store/modules/Tenant.js
import { defineStore } from 'pinia'

const useTenantStore = defineStore('tenant', {
  // 状态
  state: () => ({
    list: [],
    detail: null,
    loading: false
  }),

  // 计算属性
  getters: {
    tenantCount: (state) => state.list.length,
    hasDetail: (state) => state.detail !== null
  },

  // 方法
  actions: {
    // 设置列表
    setList(data) {
      this.list = data
    },

    // 设置详情
    setDetail(data) {
      this.detail = data
    },

    // 重置状态
    reset() {
      this.list = []
      this.detail = null
      this.loading = false
    }
  }
})

export default useTenantStore
```

### 2.2 命名规范

| 类型 | 命名规则 | 示例 |
|------|---------|------|
| Store ID | 小写模块名 | `'tenant'`、`'common'` |
| 导出函数 | `use{模块}Store` | `useTenantStore` |
| State 属性 | camelCase | `tenantList`、`currentDetail` |
| Getter | camelCase | `tenantCount`、`isLoading` |
| Action | camelCase，动词开头 | `setList`、`fetchDetail`、`reset` |

---

## 三、公共状态（Common Store）

### 3.1 系统信息

```javascript
const useCommonStore = defineStore('common', {
  state: () => ({
    // 系统信息
    statusBarHeight: 0,
    windowWidth: 0,
    windowHeight: 0,
    safeAreaInsets: {},
    platform: '',

    // 用户信息
    userInfo: {},
    isLogin: false,
    token: '',

    // 全局配置
    baseUrl: ''
  }),

  actions: {
    // 初始化系统信息
    initSystemInfo() {
      const info = uni.getSystemInfoSync()
      this.statusBarHeight = info.statusBarHeight
      this.windowWidth = info.windowWidth
      this.windowHeight = info.windowHeight
      this.safeAreaInsets = info.safeAreaInsets
      this.platform = info.platform
    },

    // 设置登录状态
    setLoginStatus(token, userInfo) {
      this.token = token
      this.userInfo = userInfo
      this.isLogin = true
      uni.setStorageSync('token', token)
      uni.setStorageSync('userInfo', userInfo)
    },

    // 退出登录
    logout() {
      this.token = ''
      this.userInfo = {}
      this.isLogin = false
      uni.removeStorageSync('token')
      uni.removeStorageSync('userInfo')
    }
  }
})
```

---

## 四、业务状态

### 4.1 多步骤表单状态

```javascript
// store/modules/Checkin.js
const useCheckinStore = defineStore('checkin', {
  state: () => ({
    step: 1,
    maxStep: 3,

    // 步骤数据
    basicInfo: {},
    contractInfo: {},
    depositInfo: {}
  }),

  getters: {
    // 当前进度
    progress: (state) => state.step / state.maxStep,

    // 是否可提交
    canSubmit: (state) => state.step === state.maxStep
  },

  actions: {
    // 下一步
    nextStep() {
      if (this.step < this.maxStep) {
        this.step++
      }
    },

    // 上一步
    prevStep() {
      if (this.step > 1) {
        this.step--
      }
    },

    // 保存步骤数据
    saveStepData(stepName, data) {
      this[stepName] = { ...this[stepName], ...data }
    },

    // 获取完整表单数据
    getFormData() {
      return {
        ...this.basicInfo,
        ...this.contractInfo,
        ...this.depositInfo
      }
    },

    // 重置
    reset() {
      this.step = 1
      this.basicInfo = {}
      this.contractInfo = {}
      this.depositInfo = {}
    }
  }
})

export default useCheckinStore
```

### 4.2 列表筛选状态

```javascript
// store/modules/TenantList.js
const useTenantListStore = defineStore('tenantList', {
  state: () => ({
    // 筛选条件
    filters: {
      status: '',
      keyword: '',
      startDate: '',
      endDate: ''
    },

    // 排序
    sortBy: 'createTime',
    sortOrder: 'desc'
  }),

  actions: {
    // 设置筛选条件
    setFilter(key, value) {
      this.filters[key] = value
    },

    // 批量设置筛选
    setFilters(filters) {
      this.filters = { ...this.filters, ...filters }
    },

    // 重置筛选
    resetFilters() {
      this.filters = {
        status: '',
        keyword: '',
        startDate: '',
        endDate: ''
      }
    }
  }
})
```

---

## 五、在组件中使用

### 5.1 基础用法

```vue
<script setup lang="ts">
import { useTenantStore } from '@/store/Index'

const tenantStore = useTenantStore()

// 读取状态
const list = computed(() => tenantStore.list)

// 调用 action
const handleReset = () => {
  tenantStore.reset()
}
</script>
```

### 5.2 storeToRefs 解构

```vue
<script setup lang="ts">
import { storeToRefs } from 'pinia'
import { useTenantStore } from '@/store/Index'

const tenantStore = useTenantStore()

// 响应式解构状态
const { list, detail, loading } = storeToRefs(tenantStore)

// action 直接解构（不需要 storeToRefs）
const { setList, reset } = tenantStore
</script>
```

### 5.3 监听状态变化

```vue
<script setup lang="ts">
import { watch } from 'vue'
import { useTenantStore } from '@/store/Index'

const tenantStore = useTenantStore()

// 监听状态变化
watch(
  () => tenantStore.detail,
  (newVal) => {
    if (newVal) {
      console.log('Detail updated:', newVal)
    }
  }
)
</script>
```

---

## 六、持久化

### 6.1 手动持久化

```javascript
const useUserStore = defineStore('user', {
  state: () => ({
    token: uni.getStorageSync('token') || '',
    userInfo: uni.getStorageSync('userInfo') || {}
  }),

  actions: {
    setToken(token) {
      this.token = token
      uni.setStorageSync('token', token)
    },

    setUserInfo(info) {
      this.userInfo = info
      uni.setStorageSync('userInfo', info)
    },

    clearStorage() {
      this.token = ''
      this.userInfo = {}
      uni.removeStorageSync('token')
      uni.removeStorageSync('userInfo')
    }
  }
})
```

---

## 七、最佳实践

### 7.1 Store 职责划分

| Store | 职责 | 生命周期 |
|-------|------|---------|
| CommonStore | 系统信息、全局配置 | 应用级 |
| UserStore | 用户信息、权限 | 登录后 |
| {业务}Store | 业务数据、表单状态 | 页面级 |

### 7.2 何时使用 Store

| 场景 | 使用 Store | 不使用 Store |
|------|-----------|-------------|
| 多组件共享数据 | ✅ | |
| 多页面共享数据 | ✅ | |
| 多步骤表单 | ✅ | |
| 单页面临时数据 | | ✅ 用 ref |
| 组件内部状态 | | ✅ 用 ref |

---

## 八、检查清单

- [ ] Store 文件放在 `store/modules/` 目录
- [ ] Store ID 使用小写模块名
- [ ] 导出函数使用 `use{模块}Store` 命名
- [ ] 页面离开时调用 `reset()` 清理状态
- [ ] 需要持久化的数据同步到 Storage
- [ ] 使用 `storeToRefs` 解构响应式状态

# H5 路由规范

> UniApp pages.json 配置和路由导航规范

---

## 一、pages.json 配置

### 1.1 基础结构

```json
{
  "easycom": {
    "autoscan": true,
    "custom": {
      "^comp-(.*)": "@/components/comp-$1/comp-$1.vue"
    }
  },
  "pages": [
    {
      "path": "pages/main/home/HomePage",
      "style": {
        "navigationBarTitleText": "首页"
      }
    }
  ],
  "globalStyle": {
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "",
    "navigationBarBackgroundColor": "#FFFFFF",
    "backgroundColor": "#F1F2F7"
  },
  "tabBar": {
    "color": "#84888F",
    "selectedColor": "#3277FF",
    "backgroundColor": "#FFFFFF",
    "list": []
  }
}
```

### 1.2 页面配置

```json
{
  "path": "pages/tenant/list/TenantList",
  "style": {
    "navigationBarTitleText": "租客列表",
    "navigationBarBackgroundColor": "#FFFFFF",
    "enablePullDownRefresh": false,
    "app-plus": {
      "titleNView": {
        "buttons": []
      }
    }
  }
}
```

---

## 二、路由路径规范

### 2.1 命名规则

| 类型 | 格式 | 示例 |
|------|------|------|
| 模块首页 | `pages/{模块}/home/{模块}Home` | `pages/tenant/home/TenantHome` |
| 列表页 | `pages/{模块}/list/{模块}List` | `pages/tenant/list/TenantList` |
| 详情页 | `pages/{模块}/detail/{模块}Detail` | `pages/tenant/detail/TenantDetail` |
| 表单页 | `pages/{模块}/form/{模块}Form` | `pages/tenant/form/TenantForm` |
| 公共页 | `pages/common/{功能}/{功能}Page` | `pages/common/webview/WebviewPage` |

### 2.2 路径格式

```
pages/{模块名}/{功能名}/{文件名}

示例：
pages/tenant/list/TenantList
pages/contract/detail/ContractDetail
pages/common/sign/SignPage
```

---

## 三、路由导航

### 3.1 页面跳转

```typescript
// 普通跳转（保留当前页）
uni.navigateTo({
  url: '/pages/tenant/detail/TenantDetail?id=123'
})

// 重定向（关闭当前页）
uni.redirectTo({
  url: '/pages/tenant/list/TenantList'
})

// 返回上一页
uni.navigateBack()
uni.navigateBack({ delta: 2 })  // 返回两级

// 切换 Tab
uni.switchTab({
  url: '/pages/main/home/HomePage'
})

// 关闭所有页面，跳转到指定页
uni.reLaunch({
  url: '/pages/main/login/LoginPage'
})
```

### 3.2 参数传递

```typescript
// 发送方
uni.navigateTo({
  url: `/pages/tenant/detail/TenantDetail?id=${id}&name=${encodeURIComponent(name)}`
})

// 接收方
onLoad((options) => {
  const id = options.id
  const name = decodeURIComponent(options.name || '')
})
```

### 3.3 复杂参数传递

```typescript
// 方式一：通过 eventChannel
uni.navigateTo({
  url: '/pages/tenant/form/TenantForm',
  success: (res) => {
    res.eventChannel.emit('sendData', { formData: data })
  }
})

// 接收方
onLoad(() => {
  const eventChannel = getCurrentInstance()?.proxy?.getOpenerEventChannel()
  eventChannel?.on('sendData', (data) => {
    console.log(data.formData)
  })
})

// 方式二：通过 Pinia 状态管理
const store = useTenantStore()
store.setFormData(data)
uni.navigateTo({ url: '/pages/tenant/form/TenantForm' })
```

---

## 四、页面返回与刷新

### 4.1 返回并刷新上一页

```typescript
// 方式一：通过 eventChannel
uni.navigateBack({
  success: () => {
    const pages = getCurrentPages()
    const prevPage = pages[pages.length - 1]
    prevPage.$vm?.refresh?.()
  }
})

// 方式二：通过 uni.$emit
// 返回前
uni.$emit('refreshTenantList')
uni.navigateBack()

// 上一页监听
onMounted(() => {
  uni.$on('refreshTenantList', () => {
    pagingRef.value?.reload()
  })
})
onUnmounted(() => {
  uni.$off('refreshTenantList')
})
```

### 4.2 onShow 刷新

```typescript
// 页面显示时刷新（不推荐频繁使用）
onShow(() => {
  if (needRefresh.value) {
    loadData()
    needRefresh.value = false
  }
})
```

---

## 五、路由守卫

### 5.1 登录拦截

```typescript
// utils/router.js
const whiteList = [
  '/pages/main/login/LoginPage',
  '/pages/common/webview/WebviewPage'
]

export const navigateTo = (url: string) => {
  const token = uni.getStorageSync('token')

  // 白名单页面直接跳转
  if (whiteList.some(path => url.startsWith(path))) {
    uni.navigateTo({ url })
    return
  }

  // 未登录跳转登录页
  if (!token) {
    uni.reLaunch({
      url: `/pages/main/login/LoginPage?redirect=${encodeURIComponent(url)}`
    })
    return
  }

  uni.navigateTo({ url })
}
```

### 5.2 权限拦截

```typescript
// 检查页面权限
export const checkPagePermission = (pageCode: string): boolean => {
  const store = useCommonStore()
  return store.permissions.includes(pageCode)
}

// 使用
if (!checkPagePermission('tenant:list')) {
  uni.showToast({ title: '暂无权限', icon: 'none' })
  return
}
navigateTo('/pages/tenant/list/TenantList')
```

---

## 六、分包配置

### 6.1 分包结构

```json
{
  "pages": [
    { "path": "pages/main/home/HomePage" }
  ],
  "subPackages": [
    {
      "root": "pages-tenant",
      "pages": [
        { "path": "list/TenantList" },
        { "path": "detail/TenantDetail" }
      ]
    },
    {
      "root": "pages-contract",
      "pages": [
        { "path": "list/ContractList" },
        { "path": "detail/ContractDetail" }
      ]
    }
  ],
  "preloadRule": {
    "pages/main/home/HomePage": {
      "network": "all",
      "packages": ["pages-tenant"]
    }
  }
}
```

### 6.2 分包页面跳转

```typescript
// 分包页面路径以分包 root 开头
uni.navigateTo({
  url: '/pages-tenant/list/TenantList'
})
```

---

## 七、检查清单

- [ ] 页面路径遵循 `pages/{模块}/{功能}/{文件名}` 格式
- [ ] 复杂参数使用 eventChannel 或 Pinia 传递
- [ ] 敏感页面有登录拦截
- [ ] 大型项目使用分包加载
- [ ] 页面返回时正确处理数据刷新

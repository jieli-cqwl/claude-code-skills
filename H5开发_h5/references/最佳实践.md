# H5 开发最佳实践

> UniApp 开发常见问题和解决方案

---

## 一、防抖节流

### 1.1 按钮防抖

```typescript
// utils/debounce.ts
export function debounce<T extends (...args: any[]) => any>(
  fn: T,
  delay = 300
): T {
  let timer: number | null = null
  return function(this: any, ...args: Parameters<T>) {
    if (timer) clearTimeout(timer)
    timer = setTimeout(() => {
      fn.apply(this, args)
      timer = null
    }, delay)
  } as T
}

// 使用
const handleSearch = debounce((keyword: string) => {
  api.search(keyword)
}, 500)
```

### 1.2 提交防重复

```typescript
// composables/useSubmit.ts
export function useSubmit<T>(submitFn: () => Promise<T>) {
  const loading = ref(false)

  const submit = async () => {
    if (loading.value) return

    loading.value = true
    try {
      return await submitFn()
    } finally {
      loading.value = false
    }
  }

  return { loading, submit }
}

// 使用
const { loading, submit } = useSubmit(() => api.save(formData))
```

---

## 二、键盘处理

### 2.1 监听键盘高度

```vue
<template>
  <view class="page" :style="{ paddingBottom: keyboardHeight + 'px' }">
    <!-- 内容 -->
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'

const keyboardHeight = ref(0)

onMounted(() => {
  uni.onKeyboardHeightChange((res) => {
    keyboardHeight.value = res.height
  })
})
</script>
```

### 2.2 输入框自动聚焦

```vue
<template>
  <input
    :focus="autoFocus"
    :adjust-position="true"
    @focus="onFocus"
    @blur="onBlur"
  />
</template>

<script setup lang="ts">
const autoFocus = ref(false)

onMounted(() => {
  // 延迟聚焦，避免页面动画冲突
  setTimeout(() => {
    autoFocus.value = true
  }, 300)
})
</script>
```

---

## 三、安全区域适配

### 3.1 底部安全区

```scss
// 方式一：CSS env()
.footer-btn {
  padding-bottom: calc(20rpx + env(safe-area-inset-bottom));
}

// 方式二：class
.safe-area-bottom {
  padding-bottom: env(safe-area-inset-bottom);
}
```

### 3.2 获取安全区信息

```typescript
const safeArea = uni.getSystemInfoSync().safeArea
const safeAreaInsets = {
  top: safeArea.top,
  bottom: uni.getSystemInfoSync().screenHeight - safeArea.bottom
}
```

---

## 四、条件编译

### 4.1 平台判断

```vue
<template>
  <!-- #ifdef H5 -->
  <view class="h5-only">仅 H5 显示</view>
  <!-- #endif -->

  <!-- #ifdef MP-WEIXIN -->
  <view class="mp-only">仅微信小程序显示</view>
  <!-- #endif -->

  <!-- #ifndef H5 -->
  <view class="not-h5">非 H5 显示</view>
  <!-- #endif -->
</template>

<script setup lang="ts">
// #ifdef H5
import { useH5Feature } from './h5-feature'
// #endif
</script>

<style lang="scss" scoped>
/* #ifdef H5 */
.h5-style {
  // H5 特有样式
}
/* #endif */
</style>
```

### 4.2 API 适配

```typescript
// utils/platform.ts
export const isH5 = () => {
  // #ifdef H5
  return true
  // #endif
  // #ifndef H5
  return false
  // #endif
}

export const copyText = (text: string) => {
  // #ifdef H5
  navigator.clipboard.writeText(text)
  // #endif
  // #ifndef H5
  uni.setClipboardData({ data: text })
  // #endif
}
```

---

## 五、权限处理

### 5.1 统一权限检查

```typescript
// utils/permission.ts
export const checkPermission = async (scope: string): Promise<boolean> => {
  try {
    const res = await uni.getSetting()
    if (res.authSetting[scope]) {
      return true
    }

    // 未授权，请求授权
    await uni.authorize({ scope })
    return true
  } catch (error) {
    // 用户拒绝，引导设置
    uni.showModal({
      title: '权限申请',
      content: '需要您授权才能使用此功能',
      confirmText: '去设置',
      success: (res) => {
        if (res.confirm) {
          uni.openSetting()
        }
      }
    })
    return false
  }
}

// 使用
const hasCamera = await checkPermission('scope.camera')
if (hasCamera) {
  // 调用相机
}
```

---

## 六、请求封装

### 6.1 统一请求

```typescript
// utils/request.ts
interface RequestOptions {
  url: string
  method?: 'GET' | 'POST' | 'PUT' | 'DELETE'
  data?: any
  showLoading?: boolean
  loadingText?: string
}

export const request = async <T>(options: RequestOptions): Promise<T> => {
  const { showLoading = false, loadingText = '加载中...' } = options

  if (showLoading) {
    uni.showLoading({ title: loadingText, mask: true })
  }

  try {
    const res = await uni.request({
      url: BASE_URL + options.url,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      }
    })

    const data = res.data as ApiResponse<T>

    if (data.code === 0) {
      return data.data
    }

    // 业务错误
    if (data.code === 40100) {
      // token 过期，跳转登录
      uni.reLaunch({ url: '/pages/login/index' })
    }

    throw new Error(data.message || '请求失败')
  } catch (error) {
    uni.showToast({ title: '网络错误', icon: 'none' })
    throw error
  } finally {
    if (showLoading) {
      uni.hideLoading()
    }
  }
}
```

### 6.2 API 模块化

```typescript
// api/tenant.ts
import { request } from '@/utils/request'

export const tenantApi = {
  getList: (params: ListParams) =>
    request<PageResult<Tenant>>({
      url: '/api/tenants',
      method: 'GET',
      data: params
    }),

  getDetail: (id: number) =>
    request<Tenant>({
      url: `/api/tenants/${id}`,
      method: 'GET'
    }),

  create: (data: CreateTenantDTO) =>
    request<Tenant>({
      url: '/api/tenants',
      method: 'POST',
      data,
      showLoading: true
    })
}
```

---

## 七、性能优化

### 7.1 图片懒加载

```vue
<image
  :src="item.image"
  mode="aspectFill"
  lazy-load
/>
```

### 7.2 长列表优化

```vue
<!-- 使用 z-paging 虚拟列表 -->
<z-paging
  ref="paging"
  v-model="list"
  :use-virtual-list="true"
  :virtual-list-col="1"
  :cell-height-mode="'dynamic'"
  @query="queryList"
>
  <!-- 列表项 -->
</z-paging>
```

### 7.3 分包加载

```json
// pages.json
{
  "subPackages": [
    {
      "root": "pages-tenant",
      "pages": [
        { "path": "list" },
        { "path": "detail" }
      ]
    },
    {
      "root": "pages-contract",
      "pages": [
        { "path": "list" },
        { "path": "detail" }
      ]
    }
  ],
  "preloadRule": {
    "pages/index/index": {
      "network": "all",
      "packages": ["pages-tenant"]
    }
  }
}
```

---

## 八、调试技巧

### 8.1 条件日志

```typescript
// utils/logger.ts
const isDev = process.env.NODE_ENV === 'development'

export const logger = {
  log: (...args: any[]) => {
    if (isDev) console.log('[LOG]', ...args)
  },
  warn: (...args: any[]) => {
    if (isDev) console.warn('[WARN]', ...args)
  },
  error: (...args: any[]) => {
    console.error('[ERROR]', ...args)
  }
}
```

### 8.2 性能监控

```typescript
// 页面加载耗时
onLoad(() => {
  const startTime = Date.now()

  onReady(() => {
    const loadTime = Date.now() - startTime
    logger.log(`页面加载耗时: ${loadTime}ms`)
  })
})
```

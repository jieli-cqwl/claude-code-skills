{
  "review_date": "2026-01-29",
  "review_title": "OpenRouter API JSON Schema 技术可行性评审",
  "context": "老板原版用 Gemini 的 responseSchema，现需评估在 OpenRouter 上用 OpenAI 格式 response_format 的可行性",
  "issues": [
    {
      "id": "issue_1",
      "severity": "HIGH",
      "description": "OpenRouter 访问 Gemini 模型时，JSON Schema 格式不兼容导致输出质量下降",
      "business_impact": "用户拿到的结构化数据不符合预期，复杂对象会被压平成字符串，无法正常解析",
      "technical_detail": "OpenRouter 使用现代 JSON Schema 特性（$defs、$ref、anyOf），但通过 OpenRouter 网关访问 Gemini 时，这些特性被 Gemini 错误解释，导致响应结构混乱",
      "evidence": [
        "Pydantic AI 框架在 v1.19.0 后遇到此问题",
        "GitHub issue #3617 记录详细案例：使用 OpenRouter 中转 Gemini，复杂对象输出转为字符串",
        "Pydantic AI 通过回退 schema 格式（使用 nullable 代替 anyOf）解决问题（PR #3618）"
      ],
      "suggestion": "若选用 Gemini，禁止通过 OpenRouter 中转。应直接调用 Gemini API 使用 responseSchema"
    },
    {
      "id": "issue_2",
      "severity": "MEDIUM",
      "description": "OpenRouter 的 response_format 参数格式与 Gemini responseSchema 完全不兼容，需要完全重写调用逻辑",
      "business_impact": "使用 OpenRouter response_format 时，原来的 Gemini responseSchema 代码必须废弃重写，迁移成本高",
      "technical_detail": {
        "gemini_way": "responseSchema 或 responseJsonSchema 参数，基于 OpenAPI 或 JSON Schema 规范",
        "openrouter_way": "response_format: { type: 'json_schema', json_schema: {...}, strict: true }",
        "compatibility": "0% - 两套完全不同的参数体系"
      },
      "suggestion": "需要编写适配层，根据选用的 LLM 供应商动态切换参数格式。建议使用 instructor 等统一库来屏蔽这种差异"
    },
    {
      "id": "issue_3",
      "severity": "MEDIUM",
      "description": "OpenRouter 对 JSON Schema 的模型支持不如原生 API 完整",
      "business_impact": "某些模型功能可能受限，选择 OpenRouter 意味着放弃一些模型的最优支持",
      "technical_detail": "OpenRouter 虽然支持 structured outputs，但作为中间层必然存在功能削减。例如部分开源模型可能不支持 strict: true 严格模式",
      "evidence": [
        "OpenRouter 文档强调'确认模型是否支持该功能'",
        "需要查看 OpenRouter models 页面逐个确认每个模型的支持情况"
      ],
      "suggestion": "详细测试各个模型的 structured output 支持，建立'支持矩阵'，文档化哪些模型能完整支持"
    },
    {
      "id": "issue_4",
      "severity": "LOW",
      "description": "OpenRouter 提供的 Response Healing 插件可能增加响应延迟",
      "business_impact": "如果启用 response_healing 插件来修复格式问题，会增加 API 调用延迟",
      "technical_detail": "response_healing 会在非流式请求时自动激活（使用 response_format 时），需要额外的验证和修复步骤",
      "suggestion": "建议测试禁用 response_healing 并让模型严格遵循 strict: true，以加快响应。只有在模型多次失败时才启用该插件"
    }
  ],
  "support_summary": {
    "openrouter_support": "✅ OpenRouter 本身支持 response_format 参数（OpenAI 兼容格式）",
    "openai_models": "✅ 通过 OpenRouter 访问 OpenAI 模型：完全支持，可直接迁移代码",
    "gemini_models_direct": "✅ 直接调用 Gemini API：原生支持 responseSchema，无需改动",
    "gemini_via_openrouter": "❌ 通过 OpenRouter 访问 Gemini：支持有损，输出质量下降，不推荐"
  },
  "recommendations": {
    "scenario_1_stick_with_gemini": {
      "name": "继续用 Gemini（推荐，如果不需要动态切换供应商）",
      "pros": [
        "保留现有 responseSchema 代码，0 改造成本",
        "直接调用 Gemini API，性能最优",
        "功能完整，支持 responseJsonSchema 等高级特性"
      ],
      "cons": [
        "锁定在 Gemini，无法灵活切换其他 LLM",
        "成本可能比 OpenRouter 高"
      ],
      "effort": "0 天",
      "risk": "中（成本依赖）"
    },
    "scenario_2_openai_via_openrouter": {
      "name": "改用 OpenAI via OpenRouter（推荐，如果要多供应商支持）",
      "pros": [
        "OpenRouter 完整支持 OpenAI 的 response_format",
        "可在 OpenRouter 控制台随时切换到其他模型（Claude、Mistral 等）",
        "降低供应商锁定风险"
      ],
      "cons": [
        "需要改写 API 调用代码，从 Gemini responseSchema 改为 OpenAI response_format",
        "额外的网络跳转（调用延迟可能增加 10-50ms）"
      ],
      "effort": "1-2 天",
      "risk": "低"
    },
    "scenario_3_abstraction_layer": {
      "name": "构建适配层，支持多供应商（推荐，长期方案）",
      "pros": [
        "一套业务逻辑，多种 LLM 供应商支持",
        "可根据成本/性能/功能动态选择最优供应商",
        "未来迁移成本最低"
      ],
      "cons": [
        "前期投入最大，需要设计统一的 schema 中间格式",
        "维护多个适配器的复杂度"
      ],
      "effort": "3-5 天",
      "risk": "低（代码风险）+ 中（时间风险）"
    }
  },
  "score": "中",
  "score_rationale": "OpenRouter 本身支持 JSON Schema（OpenAI 格式），但在 Gemini 模型的兼容性上存在已知问题。如果坚持使用 Gemini，建议直接调用 Gemini API 而非通过 OpenRouter 中转。如果选择 OpenRouter 作为统一入口，需要改写调用代码并放弃 Gemini 的特定功能。整体技术可行，但需要明确供应商选择策略。",
  "key_decisions": [
    "【决策 1】Gemini vs OpenAI：选择后的供应商锁定周期？",
    "【决策 2】多供应商支持：是否值得投入 3-5 天构建适配层？",
    "【决策 3】OpenRouter Gemini 中转：是否接受已知的兼容性风险？"
  ],
  "next_steps": [
    "1. 与老板确认：是否必须用 Gemini，还是可以切换到 OpenAI/Claude？",
    "2. 如果坚持 Gemini：建议直接调用 Gemini API，不走 OpenRouter 中转",
    "3. 如果选择 OpenRouter：评估改写 API 调用代码的工作量（预计 1-2 天）",
    "4. 长期考虑：是否需要构建供应商适配层以支持未来的灵活性需求"
  ],
  "sources": [
    {
      "title": "Structured Outputs | OpenRouter Documentation",
      "url": "https://openrouter.ai/docs/guides/features/structured-outputs"
    },
    {
      "title": "API Parameters | OpenRouter Documentation",
      "url": "https://openrouter.ai/docs/api/reference/parameters"
    },
    {
      "title": "OpenRouter + Google models produce degraded output due to schema format changes",
      "url": "https://github.com/pydantic/pydantic-ai/issues/3617"
    },
    {
      "title": "JSON Schema in Gemini - Medium",
      "url": "https://medium.com/@linz07m/json-schema-in-gemini-0b4cfc0a4f9b"
    },
    {
      "title": "Structured outputs with OpenRouter - Instructor Guide",
      "url": "https://python.useinstructor.com/integrations/openrouter/"
    }
  ]
}

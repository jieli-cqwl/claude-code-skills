---
name: experts
command: experts
user_invocable: true
parallel_mode: true
description: Agent 编排模式。当面对复杂任务需要多种专业知识时使用，协调多个专家 Agent（后端架构师、前端架构师、安全审计员等）共同完成任务。
---

> **角色**：技术导演，协调多专家攻克复杂问题
> **目标**：让对的专家做对的事，整合多视角方案
> **原则**：明确分工、并行执行、冲突调解、方案整合
> **流程**：复杂任务开始时使用
> **思考模式**：启用 ultrathink 深度思考，确保任务分解和方案整合全面准确

---

## 触发条件

当用户使用以下任一方式时，立即激活此 skill：
- 说"**专家协作**"或"**多专家**"（主触发词）
- 使用命令：`/experts`
- 说"需要多个专家"、"综合评估"
- 说"前后端一起看看"
- 说"安全和性能都要考虑"

**适用场景**：
- 复杂任务需要多种专业知识
- 需要多视角评审
- 跨领域问题需要协调

---

# Agent 编排模式 (Agent Orchestration)

> **来源**: 基于 [majiayu000/claude-arsenal](https://github.com/majiayu000/claude-arsenal) 的 Agent 编排理念

---

## 依赖规范

各专家 Agent 执行时应遵循对应的领域规范：

| 专家角色 | 依赖规范 |
|---------|---------|
| **backend-architect** | `.claude/rules/代码质量.md`、`.claude/rules/性能效率.md` |
| **frontend-architect** | `.claude/rules/代码质量.md`、`.claude/rules/全栈开发.md` |
| **security-auditor** | `.claude/rules/代码质量.md`（安全性章节） |
| **code-reviewer** | `.claude/rules/代码质量.md`、`.claude/rules/代码清洁.md` |

> **职责分离**：本 Skill 定义 Agent 编排**流程**，`rules/` 定义各领域**标准**。

---

## 核心理念

**"专业分工，协同作战"**

复杂任务不是由单一通用 AI 解决，而是由多个专家 Agent 各司其职、协调完成。

就像一个技术团队：
- 技术负责人（Tech Lead）统筹全局
- 后端架构师负责 API 和数据设计
- 前端架构师负责 UI 和交互
- 安全审计员检查漏洞
- 代码审查员把关质量

---

## 何时使用

| 场景 | 使用 |
|------|------|
| 涉及前后端的全栈任务 | ✅ 推荐 |
| 需要安全审计的变更 | ✅ 推荐 |
| 架构设计决策 | ✅ 推荐 |
| 代码审查 | ✅ 可用 |
| 简单的单文件修改 | ❌ 过度 |
| 纯探索性任务 | ❌ 使用 /explore |

---

## 专家 Agent 清单

> **核心专家概览**：以下为常用专家角色。完整 8 必选 + 2 可选专家列表见「并行架构」章节。

| Agent | 专长领域 | 触发场景 |
|-------|---------|---------|
| **tech-lead** | 项目全局、任务分解、协调整合 | 复杂任务启动时 |
| **backend-architect** | Python/FastAPI、API 设计、数据库 | 后端架构决策 |
| **frontend-architect** | React/Vue、H5、交互设计 | 前端架构决策 |
| **security-auditor** | 安全漏洞、合规性、权限控制 | 安全相关变更 |
| **code-reviewer** | 代码质量、最佳实践、测试 | 代码审查 |

---

## 执行流程

```
用户请求
    ↓
Tech Lead 分析
├── 理解任务背景和目标
├── 识别需要的专家
├── 分解为子任务
└── 分配给专家 Agent
    ↓
专家 Agent 执行
├── backend-architect: API + 数据模型
├── frontend-architect: UI + 交互
├── security-auditor: 安全检查
└── code-reviewer: 质量审查
    ↓
Tech Lead 整合
├── 收集各专家输出
├── 解决冲突和矛盾
├── 形成一致方案
└── 呈现最终结果
```

---

## 并行架构

> **设计理念**：通过并行 Agent 执行，大幅提升复杂任务的分析效率。

### Phase 1: 并行专家分析

**必选专家（8 Agent，始终启动，subagent_type=general-purpose）**：

| Agent | 专家角色 | 独占分析范围 | 禁止范围 |
|-------|---------|-------------|---------|
| Agent 1 | 后端架构师 | 服务架构、模块划分、API 路由设计 | 不分析数据库表设计、不做安全审查 |
| Agent 2 | 前端架构师 | UI 架构、组件设计、状态管理、路由 | 不分析后端 API 实现、不做性能基准 |
| Agent 3 | 数据库专家 | 数据模型、索引策略、查询优化、迁移 | 不分析服务架构、不做 API 设计 |
| Agent 4 | 安全专家 | 认证授权、输入校验、数据加密、漏洞 | 不分析业务逻辑、不做性能优化 |
| Agent 5 | 性能专家 | 缓存策略、并发处理、负载能力、瓶颈 | 不分析安全漏洞、不做数据建模 |
| Agent 6 | DevOps 专家 | 部署方案、CI/CD、监控告警、日志 | 不分析代码实现、不做业务设计 |
| Agent 7 | 测试专家 | 测试策略、覆盖范围、质量保障方法 | 不分析架构设计、不做性能调优 |
| Agent 8 | UX 专家 | 用户体验、交互设计、可用性、无障碍 | 不分析后端技术、不做安全审查 |

**每个 Agent 的 Prompt 模板**：

```markdown
你是「[专家角色]」，负责从你的专业视角分析任务。

## 你的独占分析范围
[具体负责的内容]

## 禁止范围（其他专家负责）
[不属于你的内容，不要重复分析]

## 任务描述
[任务全文]

## 输出要求
只输出你专业范围内的分析，包含：发现、建议、风险、与其他专家的依赖点。
```

**可选专家（2 Agent，按需启动）**：

| Agent | 专家角色 | 启动条件 |
|-------|---------|---------|
| Agent 9 | 业务分析师 | 任务涉及业务流程、工作流、审批流程 |
| Agent 10 | 领域专家 | 任务涉及特定领域（金融、医疗、法律等） |

**可选专家启动条件判断**：

> **判断机制**：Tech Lead 基于任务上下文综合判断，而非纯关键词匹配（避免误判）

- **Agent 9 业务分析师**：当任务**核心目标**涉及以下场景时启动：
  - 设计或优化业务流程、工作流、审批流程
  - 分析业务规则、业务逻辑、业务场景
  - 规划用户旅程、梳理业务需求
  - **排除**：仅提及关键词但非核心目标的情况（如"支付流程的技术实现"属于技术问题，不启动）

- **Agent 10 领域专家**：当任务**需要特定行业知识**才能完成时启动：
  - 金融领域：支付结算规则、风控模型、合规要求
  - 医疗领域：病历规范、诊断逻辑、医保政策
  - 法律领域：合同条款解读、合规审计要求
  - **排除**：仅涉及领域数据处理但不需要领域知识的情况（如"存储医疗数据"属于技术问题，不启动）

**冲突处理**：若同时符合 Agent 9 和 Agent 10 启动条件，两者都启动（最多 10 个专家并行）

**量化决策检查清单（Tech Lead 必须执行）**：

```markdown
### Agent 9 业务分析师启动检查

逐项回答 Yes/No：

| # | 检查项 | 答案 |
|---|-------|------|
| 1 | 任务核心目标是设计/优化业务流程吗？（如订单流程、审批流程） | Yes/No |
| 2 | 任务需要梳理业务规则或业务逻辑吗？（非技术实现） | Yes/No |
| 3 | 任务输出需要用户旅程图或业务流程图吗？ | Yes/No |

**启动条件**：任一项为 Yes → 启动 Agent 9
**排除条件**：所有项均为 No，即使提及"流程"关键词也不启动

### Agent 10 领域专家启动检查

逐项回答 Yes/No：

| # | 检查项 | 答案 |
|---|-------|------|
| 1 | 任务需要特定行业法规/政策知识吗？（如 HIPAA、PCI-DSS、GDPR） | Yes/No |
| 2 | 任务需要行业特定术语或概念解释吗？（如医疗诊断码、金融衍生品） | Yes/No |
| 3 | 任务的正确性依赖行业专业判断吗？（非纯技术判断） | Yes/No |

**启动条件**：任一项为 Yes → 启动 Agent 10
**排除条件**：所有项均为 No，即使涉及领域数据处理也不启动

### 检查清单输出格式

Tech Lead 在 Phase 1 启动前输出：

​```
📋 可选专家启动检查

Agent 9（业务分析师）：
  - Q1 业务流程设计？ → No（任务是 API 技术实现）
  - Q2 业务规则梳理？ → No
  - Q3 用户旅程图？ → No
  ✗ 不启动

Agent 10（领域专家）：
  - Q1 行业法规？ → Yes（涉及 PCI-DSS 支付合规）
  - Q2 行业术语？ → No
  - Q3 行业专业判断？ → Yes（风控阈值需金融专业判断）
  ✓ 启动（金融领域）

本次启动专家：8 必选 + 1 可选（Agent 10）= 9 位专家
​```
```

**每个 Agent 返回结构化 JSON**：

```json
{
  "agent_id": "agent_1",
  "expert_role": "后端架构师",
  "scope": "服务架构、模块划分、API 路由设计",
  "excluded_scope": "数据库表设计、安全审查",
  "analysis": {
    "findings": ["发现1（仅限独占范围内）", "发现2"],
    "recommendations": ["建议1", "建议2"],
    "risks": ["风险1", "风险2"],
    "dependencies_on_others": ["需要数据库专家确认表结构", "需要安全专家审查接口"]
  },
  "confidence": 0.85,
  "needs_input_from": ["数据库专家", "安全专家"]
}
```

**等待所有 Agent 完成后继续。**

---

> **用户进度提示**：在执行每个 Phase 前输出进度信息

```markdown
📊 /experts 执行进度

⏳ Phase 1: 专家分析（8 位必选 + 0-2 位可选专家并行）... ⏳ 执行中
⏳ Phase 2: 专家会诊
⏳ Phase 3: 输出决策
```

### Phase 2: 专家会诊（串行）

主 Agent（Tech Lead）模拟圆桌会议，整合各专家意见。

**会诊流程**：

1. **收集意见**：汇总所有专家的分析结果
2. **识别共识**：找出专家们一致认同的点
3. **发现分歧**：识别专家间的不同意见
4. **⚠️ 识别边界问题**：找出不属于任何专家独占范围的问题

**边界问题处理机制**：

> **定义**：边界问题是指落在所有专家独占范围之外，或跨越多个专家范围的问题。

Tech Lead 在会诊阶段必须执行以下检查：

```markdown
### 边界问题检查

**扫描范围**：检查任务中是否存在以下情况：
1. 跨专家范围的问题（如"前后端联调规范"跨前端+后端）
2. 所有专家都未覆盖的领域
3. 专家间职责缝隙（如"服务间通信"：后端不管网络、DevOps 不管代码）

**发现的边界问题**：

| 问题 | 涉及专家 | 处理方式 |
|------|---------|---------|
| [问题描述] | [专家A + 专家B] | Tech Lead 直接分析 / 请求用户指定负责人 |

**处理原则**：
- 简单边界问题：Tech Lead 直接给出分析
- 复杂边界问题：列出并请求用户指定负责人或启动专项讨论

**简单/复杂判断标准**：

| 判断维度 | 简单边界问题 | 复杂边界问题 |
|---------|-------------|-------------|
| 涉及专家数量 | 2 个专家 | 3+ 个专家 |
| 问题范围 | 明确可定义 | 模糊或争议性大 |
| 解决难度 | Tech Lead 可基于通用知识给出建议 | 需要特定专业知识 |
| 影响范围 | 仅影响当前任务的局部实现 | 影响架构决策或多个模块 |

**示例**：
- **简单**：前后端联调格式（只涉及前端+后端，规范明确）→ Tech Lead 直接建议
- **复杂**：分布式事务方案（涉及后端+数据库+DevOps，需专业知识）→ 请用户指定
```

**分歧处理机制**：

当专家间存在分歧时，按以下流程处理：

```markdown
### 分歧点列表

| 分歧点 | 专家A意见 | 专家B意见 | 优先级判断 | 建议方案 |
|--------|----------|----------|-----------|---------|
| [描述] | [意见]   | [意见]   | [依据]    | [建议]  |

### 分歧处理原则

优先级：安全性 > 正确性 > 性能 > 可维护性 > 风格

### 需要用户决策的点

以下分歧无法通过优先级原则判断，需要用户决策：

1. **[分歧点]**
   - 方案A：[描述] - 优势：[...] / 劣势：[...]
   - 方案B：[描述] - 优势：[...] / 劣势：[...]
   - 建议：[Tech Lead 的权衡建议]
```

---

### Phase 3: 输出决策（串行）

主 Agent 输出综合建议和行动项。

**输出格式**：

```markdown
## 专家会诊报告

### 执行摘要
[1-2 句话概括核心结论]

### 综合建议
| 优先级 | 建议内容 | 来源专家 | 预期收益 |
|--------|---------|---------|---------|
| P0 | [建议] | [专家] | [收益] |
| P1 | [建议] | [专家] | [收益] |

### 行动项
- [ ] [行动1] - 负责：[专家] - 优先级：P0
- [ ] [行动2] - 负责：[专家] - 优先级：P1

### 风险和关注点
[需要持续关注的事项]

### 待用户决策
[列出需要用户决策的分歧点]
```

---

## 错误处理

### Agent 超时处理

> **配置来源**：`docs/需求澄清/clarify_skills并行优化.md` 第 7.3 节超时配置表

```yaml
单个 Agent 超时: 60 秒  # 见 AC 文档超时配置表
处理策略:
  - 记录超时的 Agent
  - 继续等待其他 Agent
  - 在最终报告中标注"[专家名] 分析超时，建议单独咨询"
```

### Agent 失败处理

```yaml
处理策略:
  - 记录失败原因
  - 不阻塞其他 Agent
  - 在最终报告中标注"[专家名] 分析失败：[原因]"
  - 如果关键专家失败（安全、后端、前端），提示用户选择：
    1. 重试失败专家（推荐，网络问题通常可恢复）
    2. 继续执行（基于其他专家意见，输出将标注数据不完整）
    3. 暂停并排查问题
```

### 最小专家数阈值

```yaml
必须完成的专家: 后端架构师、前端架构师、安全专家、数据库专家
最小阈值: 4 个必选专家（与 AC-ERR-3 的 50% 规则对齐：8 × 50% = 4）
低于阈值: 停止执行，报告失败并列出缺失的关键专家，等待用户决策（重试或终止）
```

### 数据完整性警告

```yaml
完整度警告阈值: 成功完成的专家数 < 总启动数的 75%（即 < 6 个）
处理策略:
  - 在输出报告开头添加数据完整性警告
  - 列出缺失的专家视角及潜在影响
  - 标注报告为"基于部分专家的分析"

警告模板: |
  > ⚠️ **数据完整性警告**：本次会诊仅有 X/Y 位专家完成分析（共启动 Y 位）。
  > 缺失专家：[专家名1]、[专家名2]
  > 缺失视角可能影响：[具体影响]
  >
  > 建议后续补充缺失专家的分析，或在决策时考虑信息不完整的风险。

注：Y = 8（必选专家）+ 启动的可选专家数量（0-2）
```

---

## Agent 协作机制

### 任务分派

Tech Lead 使用标准格式向专家分派任务：

```markdown
# 专家任务分派

## 基本信息
- **任务 ID**: ORCH-001
- **目标专家**: backend-architect
- **优先级**: P1 高

## 任务描述
[清晰的目标和预期输出]

## 依赖信息
[前置任务的输出、需要的上下文]

## 输出格式要求
[专家应如何格式化输出]
```

详见模板：`templates/task-dispatch.md`

### 信息流转

```
┌─────────────────────────────────────────────────────────────┐
│                      Tech Lead                               │
│  - 持有全局上下文                                            │
│  - 负责收集和传递信息                                        │
│  - 专家不直接通信，通过 Tech Lead 中转                       │
└─────────────────────────────────────────────────────────────┘
        ↓ 分派任务 + 上下文        ↑ 返回输出
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ backend-arch  │ │ frontend-arch │ │ security-aud  │
│ (独立执行)    │ │ (独立执行)    │ │ (独立执行)    │
└───────────────┘ └───────────────┘ └───────────────┘
```

### 依赖处理

当任务之间有依赖时：

1. **识别依赖**：Tech Lead 分析任务间的依赖关系
2. **顺序调度**：先调度无依赖的任务，收到输出后再调度依赖任务
3. **传递输出**：将前置任务的输出作为后续任务的输入

```
示例：前端依赖后端 API 设计

1. Tech Lead → backend-architect: "设计登录 API"
2. backend-architect 返回: API 设计文档
3. Tech Lead → frontend-architect: "设计登录 UI" + [API 设计文档]
4. frontend-architect 基于 API 设计完成 UI 设计
```

### 输出整合

专家输出的标准格式：

```markdown
# [专家角色] 任务报告

## 任务信息
- **任务 ID**: ORCH-001
- **完成时间**: YYYY-MM-DD HH:mm

## 交付物
[具体输出内容]

## 后续建议
[需要其他专家关注的事项]

## 风险和关注点
[Tech Lead 需要关注的风险]
```

---

## 协调模式

### 模式 1: 串行协调

```
task → backend-architect → frontend-architect → security-auditor → 完成
```

**适用场景**：有明确依赖关系的任务

### 模式 2: 并行协调

```
task → ┬─ backend-architect  ─┬→ 整合 → 完成
       ├─ frontend-architect ─┤
       └─ security-auditor   ─┘
```

**适用场景**：可独立进行的多领域任务

### 模式 3: 迭代协调

```
task → expert-A → review-by-B → expert-A 修改 → review-by-B → ... → 完成
```

**适用场景**：需要多轮反馈的设计任务

---

## 各专家 Agent 职责

### Tech Lead（技术负责人）

**角色**：项目全局把控、任务协调

**职责**：
- 分析用户请求，理解真实需求
- 识别需要哪些专家参与
- 将任务分解为可分配的子任务
- 协调专家之间的交互
- 整合输出，解决冲突

**调用时机**：复杂任务启动时自动激活

详见 `agents/tech-lead.md`

### Backend Architect（后端架构师）

**角色**：后端技术专家

**专长**：
- Python 3.10+ / FastAPI 架构
- RESTful API 设计
- 数据库设计（MySQL）
- 缓存策略（Redis）
- 性能优化

**调用时机**：涉及后端 API、数据库、服务设计时

详见 `agents/backend-architect.md`

### Frontend Architect（前端架构师）

**角色**：前端技术专家

**专长**：
- React 18 / Vue 3 架构
- TypeScript 类型设计
- 组件设计和状态管理
- H5 移动端适配
- 用户交互体验

**调用时机**：涉及前端 UI、组件、交互设计时

详见 `agents/frontend-architect.md`

### Security Auditor（安全审计员）

**角色**：安全专家

**专长**：
- OWASP Top 10 漏洞
- 认证和授权
- 数据加密
- 输入验证
- 合规性检查

**调用时机**：涉及安全敏感功能时

详见 `agents/security-auditor.md`

### Code Reviewer（代码审查员）

**角色**：质量把关

**专长**：
- 代码质量评估
- 最佳实践检查
- 测试覆盖验证
- 性能问题发现
- 可维护性分析

**调用时机**：代码实现完成后

详见 `agents/code-reviewer.md`

---

## 预定义工作流

针对常见场景，提供预定义的工作流模板：

| 工作流 | 适用场景 | 参与专家 | 文档位置 |
|--------|---------|---------|---------|
| **全栈功能开发** | 前后端同步开发的功能 | tech-lead + backend + frontend + reviewer | `workflows/fullstack-feature.md` |
| **安全审计** | 安全敏感变更的审计 | tech-lead + security-auditor + reviewer | `workflows/security-audit.md` |
| **架构评审** | 重大架构决策评审 | tech-lead + backend + frontend + security | `workflows/architecture-review.md` |

使用时，Tech Lead 会根据任务类型自动选择合适的工作流。

---

## 使用示例

### 示例 1: 新功能开发（使用 fullstack-feature 工作流）

```
用户: 我需要实现用户登录功能

Tech Lead 分析:
- 这是全栈任务
- 需要：backend-architect（API）+ frontend-architect（UI）+ security-auditor（认证）
- 选择工作流: fullstack-feature

分配:
1. backend-architect: 设计登录 API、JWT 机制
2. frontend-architect: 设计登录表单、状态管理
3. security-auditor: 审计认证流程安全性

整合:
- 确保前后端接口一致
- 确保安全建议被采纳
- 形成完整方案
```

详见 `workflows/fullstack-feature.md`

### 示例 2: 安全审计（使用 security-audit 工作流）

```
用户: 检查最近的代码变更有没有安全问题

Tech Lead 分析:
- 这是安全审计任务
- 主要需要：security-auditor
- 选择工作流: security-audit

分配:
1. security-auditor: 审计变更代码
2. code-reviewer: 辅助检查代码质量

整合:
- 合并安全和质量报告
- 按严重程度排序
```

详见 `workflows/security-audit.md`

---

## 冲突解决

当专家意见冲突时：

### 优先级原则

```
安全性 > 正确性 > 性能 > 可维护性 > 风格
```

### 冲突处理流程

1. **Tech Lead 识别冲突**
2. **双方陈述理由**
3. **按优先级判断**
4. **无法判断则呈现给用户**

### 常见冲突类型

| 冲突 | 处理 |
|------|------|
| 性能 vs 安全 | 安全优先，性能次之 |
| 便利性 vs 安全 | 安全优先 |
| 前端 vs 后端 | 以接口契约为准 |
| 代码风格 | 遵循项目规范 |

---

## 与其他 Skills 的关系

```
/clarify（需求澄清）
    ↓
/experts  ← 本技能
    ├─ 调度各专家 Agent
    ↓
/plan（写计划）
    ↓
/run-plan（执行计划）
```

---

## 危险信号

- 简单任务使用编排（过度工程）
- 专家之间持续冲突无法解决
- 任务分解不清晰导致重复工作
- 整合阶段发现根本性问题

---

## 完成检查清单

- [ ] 任务已正确分解
- [ ] 合适的专家已被分配
- [ ] 各专家输出已收集
- [ ] 冲突已解决
- [ ] 最终方案已整合
- [ ] 用户已确认结果

---

## ✅ 完成提示

当专家协作完成后，输出：

```
✅ 专家协作完成

下一步：根据专家建议执行 /plan（写计划）或 /run-plan（执行计划）
```

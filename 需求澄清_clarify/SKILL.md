---
name: clarify
command: clarify
user_invocable: true
description: 需求澄清。基于项目上下文的精准提问，结合代码和规范聚焦关键疑点，确保双方对需求无歧义。在方案探索（/explore）之前使用。
---

# 需求澄清 (Clarify)

> **角色**：上下文感知的苏格拉底式提问者
> **目标**：基于项目现状精准澄清需求，减少无效提问
> **核心改进**：先研究项目 → 再聚焦提问
> **下一步**：澄清完成后进入方案探索 (`/explore`)

---

## 核心原则

| 原则 | 说明 |
|------|------|
| **先研究，再提问** | 充分利用项目规范、代码、文档 |
| **聚焦关键疑点** | 只问真正不确定的问题 |
| **结合项目约束** | 基于规范主动告知约束，不问已知 |
| **一次一个核心问题** | 避免信息过载 |
| **优先选择题** | 降低回答成本 |
| **记录共识** | 每个确认点都要记录 |

---

## 触发方式

用户输入 `/clarify` 时激活此 skill。

**适用场景**：
- 用户提出模糊需求："我想让系统更快"
- 用户有想法但不清晰："能不能加个功能..."
- 复杂功能开发前的需求对齐
- 避免开发完才发现理解偏差

---

## 执行流程

### 第零步：项目上下文研究（核心改进）

**在提问前，必须先快速研究项目**：

#### 1. 读取项目规范

根据需求类型，读取相关规范：

| 需求类型 | 必读规范 | 关注点 |
|---------|---------|--------|
| 性能优化 | `~/.claude/reference/性能效率.md` | 缓存、复用、批量、并发策略 |
| 新功能开发 | `~/.claude/reference/全栈开发.md` | 前后端同步、API 设计 |
| 任何需求 | `~/.claude/reference/代码质量.md` | 三条铁律、零容忍行为 |
| 批量操作 | `~/.claude/reference/性能效率.md` | 批量操作、事务处理 |
| 错误处理 | `~/.claude/reference/代码质量.md` | 用户友好提示、错误处理规范 |

**必读文件**：
- `CLAUDE.md`：项目信息、技术栈、铁律
- `~/.claude/rules/RULES.md`：核心规范（始终已加载）

#### 2. 读取相关代码

如果涉及现有功能，必须先了解当前实现：

```python
# 示例：用户说"优化文档搜索"
需要读取：
- backend/app/services/rag_service.py       # 当前搜索实现
- backend/app/api/v1/endpoints/search.py    # API 接口
```

#### 3. 识别关键约束

梳理哪些规范会影响这个需求：
- **铁律**：禁止降级、禁止硬编码、禁止 Mock
- **全栈要求**：先后端后前端，前后端同步完成
- **性能要求**：缓存、批量、事务
- **文档要求**：复杂改动需要计划文档

#### 4. 内部梳理（不展示给用户）

在心里整理：
- **已知信息**：从规范和代码可以推断的
- **未知信息**：必须问用户的
- **关键约束**：不能违反的规范

---

### 第一步：总结当前状态（展示给用户）

**不要直接问问题，先展示你的理解**：

```markdown
我先了解了一下项目现状：

**相关规范**：
- [列出涉及的规范文件，如「全栈开发规范」「性能效率规范」]

**当前实现**（如果涉及现有功能）：
- [总结当前代码的实现方式]
- [指出关键文件和行号]

**项目约束**：
- [列出必须遵守的铁律和规范]
```

**这样做的好处**：
1. 让用户感受到你理解了项目
2. 用户可以纠正你的理解偏差
3. 建立信任，提高沟通效率

---

### 第二步：聚焦关键疑点

**基于研究结果，列出真正不确定的问题**。

#### 问题分类策略

##### A) 规范相关问题（直接告知，不要问）

❌ **不要问**：
- "需要写测试吗？" → 规范要求必须写测试
- "前端要做吗？" → 全栈规范要求前后端同步
- "能用 Mock 吗？" → 铁律禁止 Mock
- "需要写文档吗？" → 复杂改动必须有计划文档

✅ **应该做**：
- 直接告知："根据项目规范，需要同时完成前后端"
- 主动提示："根据性能规范，需要考虑缓存策略"
- 给出约束："根据项目铁律，禁止降级兜底方案"

##### B) 技术实现问题（结合代码提问）

❌ **不要泛泛问**：
- "要实现什么功能？"

✅ **结合代码问**：
- "当前 `resource_service.py` 有单个删除，你想加批量删除是吗？需要支持跨资源类型吗？"
- "现有搜索是向量搜索，你想优化的是响应速度（<500ms）还是准确率（相关性）？"

##### C) 业务逻辑问题（必须问用户）

这些必须问：
- **业务规则**："批量删除的最大数量？"
- **用户体验**："删除前需要二次确认吗？"
- **优先级**："性能优化 vs 新功能，哪个优先？"
- **验收标准**："响应时间要多快才算达标？"

---

### 第三步：精准提问

**一次只问一个核心问题**，并提供基于项目的选项：

```markdown
基于以上分析，请确认：

[核心问题，基于项目实际情况]

A) [选项1，具体可执行]
   - 技术方案：[简要说明]
   - 工作量：[预估]

B) [选项2，具体可执行]
   - 技术方案：[简要说明]
   - 工作量：[预估]

C) 其他（请说明）

推荐：[基于项目规范的推荐方案]
```

**示例（性能优化场景）**：

```markdown
根据性能规范，你想优化的是：

A) **响应速度**（目标 < 500ms）
   - 技术方案：加 embedding 缓存 + Redis 热查询缓存
   - 工作量：1-2 天

B) **搜索准确率**（提高相关性）
   - 技术方案：调整 top-k 参数 + rerank 策略
   - 工作量：2-3 天

C) **并发能力**（支持更多用户）
   - 技术方案：Qdrant 集群 + 批量查询优化
   - 工作量：3-5 天

推荐：A（响应速度），因为当前平均 800ms，用户体验不佳
```

---

### 第四步：确认边界和约束

基于项目规范，主动列出边界：

```markdown
根据项目规范，以下是必须遵守的：

**全栈完整性**（来自全栈开发规范）：
- [ ] 后端 API 实现
- [ ] 前端 UI 实现
- [ ] 联调验证

**质量要求**（来自代码质量规范）：
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 错误提示用户友好（无技术细节）
- [ ] 禁止降级、禁止硬编码、禁止 Mock

**性能要求**（来自性能效率规范）：
- [ ] LLM 调用有缓存
- [ ] 数据库操作批量化
- [ ] 避免 N+1 查询

这些约束是否会影响你的需求？
```

---

### 第五步：输出需求文档

需求澄清完成后，输出增强版文档：

```markdown
## 需求澄清结果

**需求名称**：[简短名称]
**澄清日期**：YYYY-MM-DD
**状态**：已确认

---

### 0. 项目上下文

**相关规范**：
- `.claude/rules/全栈开发.md` - 前后端同步要求
- `.claude/rules/性能效率.md` - 缓存和批量操作

**相关代码**：
- `backend/app/services/xxx.py:123-145` - 当前实现
- `frontend/src/pages/xxx.tsx` - 前端页面

**关键约束**：
- 项目铁律：禁止降级、禁止硬编码、禁止 Mock
- 全栈要求：前后端必须同步完成
- 性能要求：必须有缓存策略

---

### 1. 背景
[为什么要做，触发原因]

---

### 2. 目标
- **功能目标**：[要实现什么能力]
- **质量目标**：[性能/体验要求，可量化]
- **时间目标**：[截止日期或优先级]
- **规范要求**：[项目规范的具体要求]

---

### 3. 技术方案要点

**涉及模块**：
- 后端：`backend/app/services/xxx.py`、`backend/app/api/v1/endpoints/xxx.py`
- 前端：`frontend/src/pages/xxx.tsx`、`frontend/src/components/xxx.tsx`

**关键技术决策**：
- [技术选型或方案]
- [需要遵守的规范约束]

**风险点**：
- [可能违反规范的地方]
- [技术难点]

---

### 4. 验收标准

**功能验收**：
- [ ] [具体功能点1]
- [ ] [具体功能点2]

**质量验收**：
- [ ] [可测量指标，如响应时间 < 500ms]
- [ ] [用户体验要求，如操作步骤 ≤ 3 步]

**规范验收**（来自项目规范）：
- [ ] 前后端同步完成
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 无硬编码配置
- [ ] 错误提示用户友好
- [ ] 有性能优化（缓存/批量）

---

以上理解是否正确？确认后进入方案探索 (`/explore`)
```

---

## 注意事项

### 核心改进点

1. **不要无脑提问**：先研究项目，再精准提问
2. **不要忽略规范**：主动结合项目规范，不要等用户提醒
3. **不要重复问已知信息**：规范明确的不要问
4. **不要抽象提问**：基于实际代码和场景提问

### 时间控制

- 研究阶段：快速浏览，不要深入细节
- 提问阶段：2-3 轮精准提问，不要 5 轮模板化提问
- 如果 3 轮还没澄清，可能需求本身不清晰，建议用户先梳理

### 输出要求

- 验收标准必须可测量、可验证
- 技术方案要点要具体到文件和模块
- 规范要求要明确引用规范文件

---

## 与其他 Skills 的关系

```
/clarify（需求澄清）
    ↓ 需求清晰后
/explore（方案探索）
    ↓ 方案确定后
/plan（写计划）
    ↓
/run-plan（执行计划）
    ↓
/check（开发检查）
    ↓
/qa（测试验收）
```

---

## 快速判断：是否需要 /clarify？

| 情况 | 是否需要 |
|------|---------|
| 用户说"帮我做 XXX"，XXX 很模糊 | ✅ 需要 |
| 用户给了详细的需求文档 | ❌ 可跳过 |
| 用户说"按上次讨论的做" | ⚠️ 快速确认关键点 |
| 小改动、Bug 修复 | ❌ 可跳过 |
| 复杂功能、涉及多模块 | ✅ 需要 |
| 性能优化、架构调整 | ✅ 需要（必须先研究现状） |

---

## 对比：旧版 vs 新版

| 维度 | 旧版（v1） | 新版（v2） |
|------|-----------|-----------|
| 提问前准备 | 无 | **先研究项目**（规范+代码） |
| 提问方式 | 通用模板 | **基于项目上下文**精准提问 |
| 规范处理 | 不考虑 | **主动结合规范**告知约束 |
| 提问轮次 | 5 轮固定流程 | **2-3 轮聚焦**关键疑点 |
| 输出文档 | 基础模板 | **增强版**（含上下文和技术方案） |
| 用户体验 | 感觉被质问 | **感觉被理解** |

---

## ✅ 完成提示

当需求澄清完成后，输出：

```
✅ 需求澄清完成

📋 需求文档已生成（见上文）

🎯 下一步建议：
1. 用户确认需求理解无误
2. 执行 /explore（方案探索）- 调研业界最佳实践
3. 执行 /plan（写计划）- 制定详细实施步骤

现在进入下一步？
```

---

**技能版本**: v2.0（上下文感知版）
**更新日期**: 2025-01-22
**改进要点**: 先研究项目，再精准提问

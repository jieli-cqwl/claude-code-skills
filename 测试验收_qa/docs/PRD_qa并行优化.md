# 需求澄清：/qa 并行优化

> **目标**：提升 `/qa` 执行效率，利用多个子 agent 并行执行测试，同时不影响质量保障

---

## 1. 背景

### 当前问题

| 问题 | 影响 |
|------|------|
| 串行执行 | 相当于"一个测试干活"，效率低 |
| 资源浪费 | 有多个子 agent 可用但未利用 |
| 等待时间长 | Layer 1 → 2 → 3 顺序执行，累计耗时高 |

### 当前架构（v3.x）

```
串行金字塔门控（现状）：
  Layer 1: test_a → test_b → test_c → test_d  （层内顺序执行）
      ↓ 全部通过
  Layer 2: api_1 → api_2 → api_3  （层内顺序执行）
      ↓ 全部通过
  Layer 3: e2e_1 → e2e_2  （层内顺序执行）

特点：层间有门控（好），层内是串行（待优化）
```

### 参考实现

`/check` skill 已有并行架构：
- 9 个 Agent 同时执行
- 效率提升：5 分钟 → 2-3 分钟

---

## 2. 目标

| 目标 | 指标 |
|------|------|
| **Layer 1+2 效率提升** | 单元+集成测试时间缩短 70%+ |
| **整体效率提升** | 总执行时间缩短 35%+（受 E2E 串行限制） |
| **质量不降** | 保留金字塔门控机制 |
| **快速失败** | 任何 Layer 失败立即停止 |

**说明**：E2E 必须串行执行（浏览器资源限制），是效率瓶颈。Layer 1+2 的并行化是主要收益点。

---

## 3. 方案概述

### 目标架构：层内并行 + 层间门控

```
┌─────────────────────────────────────────────────────────┐
│                    Layer 1: 单元测试                      │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │Agent 1  │ │Agent 2  │ │Agent 3  │ │Agent N  │       │
│  │ test_a  │ │ test_b  │ │ test_c  │ │ test_x  │       │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
│                    ↓ 全部通过才进入下层                    │
├─────────────────────────────────────────────────────────┤
│                   Layer 2: 集成测试                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │ 模块A测试组  │ │ 模块B测试组  │ │ 模块C测试组  │       │
│  └─────────────┘ └─────────────┘ └─────────────┘       │
│                    ↓ 全部通过才进入下层                    │
├─────────────────────────────────────────────────────────┤
│                    Layer 3: E2E 测试                     │
│  ┌─────────────────────────────────────────────┐       │
│  │              串行执行（不变）                  │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

### 架构演进说明

| 版本 | 架构 | 说明 |
|------|------|------|
| v2.x（旧） | 全并行无门控 | 各层独立，无最终验收 |
| v3.x（现） | 串行金字塔门控 | 层间门控，但层内串行 |
| **v4.x（目标）** | **层内并行 + 层间门控** | 保留门控，层内并行提效 |

### 核心原则

| 原则 | 说明 |
|------|------|
| **层内并行** | Layer 1/2 的测试由多个子 agent 并行执行 |
| **层间门控** | 上层全部通过才进入下层（保留 v3.x 的门控机制） |
| **E2E 串行** | Layer 3 保持串行，避免浏览器资源竞争 |
| **隔离要求** | 并行测试之间不能有共享状态依赖 |

---

## 4. 技术路线（明确选择）

### 选择：Task tool 并行调度

| 方案 | 选择 | 原因 |
|------|------|------|
| **Task tool 并行** | ✅ 采用 | skill 原生能力，与 `/check` 一致 |
| pytest-xdist | ❌ 不采用 | 仅适用于 pytest 项目，通用性差 |

### 实现方式

```markdown
## Task tool 并行调度

1. **任务分配**
   - 收集当前层所有测试文件/模块
   - 按文件或模块分组

2. **并行执行**
   - 使用 Task tool 的 run_in_background 参数
   - 每个子 agent 执行一组测试
   - 主 agent 监控所有子 agent 状态

3. **结果收集**
   - 使用 TaskOutput 收集每个子 agent 的结果
   - 设置超时时间，处理子 agent 异常

4. **资源回收**
   - 所有子 agent 完成后，确认无残留进程
   - 清理临时文件和日志
```

---

## 5. 验收标准（AC）

### AC-1: 层内并行执行

| 项目 | 内容 |
|------|------|
| **Given** | 存在多个独立的单元测试/集成测试 |
| **When** | 执行 `/qa` 的 Layer 1 或 Layer 2 |
| **Then** | 测试由多个子 agent 并行执行，而非顺序执行 |
| **验证方法** | 检查执行日志，确认多个测试同时开始（时间戳相近） |

### AC-2: 层间门控保留

| 项目 | 内容 |
|------|------|
| **Given** | Layer 1 有测试失败 |
| **When** | Layer 1 执行完成 |
| **Then** | 不进入 Layer 2，直接输出失败报告 |
| **验证方法** | 故意让 Layer 1 失败，确认 Layer 2 未执行 |

### AC-3: 失败聚合

| 项目 | 内容 |
|------|------|
| **Given** | 并行执行的多个测试中有 2+ 个失败 |
| **When** | 该层执行完成 |
| **Then** | 所有失败信息统一汇总展示，不遗漏 |
| **验证方法** | 让多个测试失败，检查报告是否完整包含所有失败 |

### AC-4: 效率提升

| 项目 | 内容 |
|------|------|
| **Given** | 有 N 个可并行的测试 |
| **When** | 使用 M 个子 agent 并行执行 |
| **Then** | 执行时间约为串行的 1/min(N, M) |
| **验证方法** | 对比并行前后的执行时间 |

### AC-5: 隔离验证（v1.0 简化版）

| 项目 | 内容 |
|------|------|
| **Given** | 准备并行执行测试 |
| **When** | 开始执行前 |
| **Then** | 检查测试文件是否标记为"需串行执行" |
| **验证方法** | 标记一个测试文件为串行，确认该文件不参与并行 |

**v1.0 检测方法（简化）**：
1. 检查测试文件头部是否有 `# SERIAL: reason` 标记
2. 有标记的文件：单独串行执行，不参与并行分组
3. 无标记的文件：默认可并行

**标记示例**：
```python
# SERIAL: 依赖全局数据库状态
# test_order_sequence.py

def test_create_order():
    ...
```

**v1.1 增强（未来）**：
- 静态分析 import 语句检测全局状态
- 自动检测共享 fixture（scope=session/module）

### AC-6: 子 agent 异常处理

| 项目 | 内容 |
|------|------|
| **Given** | 某个子 agent 执行超时或崩溃 |
| **When** | 等待子 agent 结果时 |
| **Then** | 超时后标记该 agent 为失败，不阻塞其他 agent，汇总时报告异常 |
| **验证方法** | 模拟子 agent 超时，确认主流程不卡住 |

**处理策略**：
| 异常类型 | 处理 |
|---------|------|
| 超时（默认 5 分钟） | 标记失败，继续等待其他 agent |
| 崩溃（无响应） | 标记失败，继续等待其他 agent |
| 部分结果 | 收集已有结果，标记不完整 |

### AC-7: 资源回收

| 项目 | 内容 |
|------|------|
| **Given** | 所有子 agent 执行完成（成功或失败） |
| **When** | 汇总结果后 |
| **Then** | 确认所有子 agent 已终止，无残留进程 |
| **验证方法** | 执行后检查后台任务列表，确认无遗留 |

**回收检查项**：
- [ ] 所有 background task 已完成或终止
- [ ] 临时日志文件已清理
- [ ] 测试环境已重置（如有）

### AC-8: E2E 保持串行

| 项目 | 内容 |
|------|------|
| **Given** | 执行 Layer 3 E2E 测试 |
| **When** | 有多个 E2E 流程 |
| **Then** | 按顺序串行执行，不并行 |
| **验证方法** | 检查 E2E 执行日志，确认顺序执行 |

**原因**：Claude in Chrome MCP 不支持同时操作多个独立浏览器会话，并行会导致标签页互相干扰。

---

## 6. 边界情况

### 6.1 测试依赖处理

| 情况 | 处理 |
|------|------|
| 静态检测到依赖 | 输出警告，该层降级为串行 |
| 数据库状态依赖 | 每个 agent 使用独立事务（建议） |
| 文件系统依赖 | 每个 agent 使用独立临时目录 |

### 6.2 资源限制（固定值，v1.0 不支持配置）

| 限制 | 固定值 | 说明 |
|------|--------|------|
| Layer 1 最大并行数 | 4 | 单元测试，高度并行 |
| Layer 2 最大并行数 | 3 | 集成测试，中度并行 |
| Layer 3 最大并行数 | 1 | E2E 串行，不并行 |
| 子 agent 超时 | 5 分钟 | 单个 agent 最大执行时间 |

**为什么 v1.0 不支持配置**：
- skill 是 Markdown 文件，无运行时配置机制
- 固定值足以满足大多数场景
- 未来可通过 YAML frontmatter 或参数扩展

### 6.3 失败策略

| 策略 | 说明 | v1.0 选择 |
|------|------|----------|
| **完整执行** | 本层全部执行完再汇总 | ✅ 默认 |
| 快速失败 | 任一失败立即停止整层 | ❌ 不支持 |

**理由**：完整执行能收集所有失败信息，便于一次性修复。

---

## 7. 不在范围内

| 排除项 | 原因 |
|--------|------|
| 跨层并行（Layer 1 和 Layer 2 同时） | 违反金字塔门控原则 |
| E2E 并行 | Claude in Chrome MCP 不支持多会话 |
| pytest-xdist 集成 | 通用性差，仅适用于 pytest |
| 运行时配置 | v1.0 复杂度控制，使用固定值 |
| 分布式测试（跨机器） | 复杂度过高，当前不需要 |

---

## 8. 效率预估

| 场景 | 串行耗时 | 并行耗时 | 提升 |
|------|---------|---------|------|
| 12 个单元测试（4 agents） | 60s | 15s | 4x |
| 9 个集成测试（3 agents） | 45s | 15s | 3x |
| **Layer 1+2 小计** | **105s** | **30s** | **3.5x（71% 缩短）** |
| 3 个 E2E（串行） | 90s | 90s | 1x（瓶颈） |
| **总计** | **195s** | **120s** | **1.6x（38% 缩短）** |

**分析**：
- Layer 1+2 效率提升显著：71% 缩短，达成 70%+ 目标 ✅
- 整体效率提升：38% 缩短，达成 35%+ 目标 ✅
- E2E 是瓶颈：占总耗时 46%（90/195），但必须串行

**优化空间**（未来）：
- 如果 E2E 测试数量减少或耗时缩短，整体提升会更明显
- Layer 1 并行数可从 4 增加到 6，进一步提升

---

## 9. 风险与缓解

| 风险 | 缓解措施 |
|------|---------|
| 测试间有隐藏依赖 | AC-5 静态检测 + 降级 |
| 子 agent 超时/崩溃 | AC-6 异常处理，不阻塞主流程 |
| 资源泄漏 | AC-7 资源回收检查 |
| 日志混乱 | 每个 agent 独立日志前缀，汇总时标注来源 |
| 并行不稳定 | 提供降级开关，可回退串行 |

---

## 10. SKILL.md 更新说明

需要同步更新 `/qa` SKILL.md 的以下内容：

| 位置 | 当前内容 | 更新为 |
|------|---------|--------|
| 第 71-82 行 | "旧架构（并行）→ 新架构（金字塔门控）" | "v3.x（串行门控）→ v4.x（层内并行 + 层间门控）" |
| 核心理念 | 仅强调门控 | 增加"层内并行提效" |
| 执行流程 | 串行描述 | 增加并行调度说明 |

---

**文档版本**：v1.2（建议优化版）
**创建日期**：2026-01-29
**状态**：评审通过

**v1.2 优化内容**：
1. ✅ AC-5 简化：从静态分析改为手动标记（`# SERIAL: reason`）
2. ✅ 目标细化：分离 Layer 1+2 目标（70%+）和整体目标（35%+）
3. ✅ 效率预估优化：增加分层分析，明确 E2E 是瓶颈

**v1.1 修复内容**：
1. ✅ 明确技术路线：Task tool 并行，不用 pytest-xdist
2. ✅ 新增 AC-6：子 agent 异常处理
3. ✅ 新增 AC-7：资源回收
4. ✅ 新增 AC-8：E2E 保持串行
5. ✅ 明确架构演进：v2.x → v3.x → v4.x
6. ✅ 配置改为固定值，说明不支持配置的原因
